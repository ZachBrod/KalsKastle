var t=1,i=!0,s=1,p=24,g=12,e=null;function d(t){this.target=t,this.startPos={x:t.x,y:t.y},this.list=[],this.tLim=null,this.bLim=null,this.lLim=null,this.rLim=null}window.onblur=function(){!1===u.isPaused&&u.pause(),e=new HUDRect(0,0,100,0,0,"white"),HUD.register(e),e.update=function(){this.x=0,this.y=0,this.w=canvas.width,this.h=canvas.height}},window.onfocus=function(){HUD.unRegister(e),e=null},window.onload=function(){canvas.width=288,canvas.height=216,window.resizeTo(canvas.width+30,canvas.height+78),ctx.mozImageSmoothingEnabled=!1,ctx.webkitImageSmoothingEnabled=!1,ctx.msImageSmoothingEnabled=!1,ctx.imageSmoothingEnabled=!1},window.onresize=function(){if(canvas.width=window.innerWidth-16,canvas.height=window.innerHeight-16,i){432<canvas.width&&(canvas.width=432),336<canvas.height&&(canvas.height=336)}canvas.tWidth=Math.ceil(canvas.width/p),canvas.tHeight=Math.ceil(canvas.height/p),ctx.mozImageSmoothingEnabled=!1,ctx.webkitImageSmoothingEnabled=!1,ctx.msImageSmoothingEnabled=!1,ctx.imageSmoothingEnabled=!1},canvas=document.getElementById("game"),canvas.width=288,canvas.height=216,canvas.tWidth=Math.ceil(canvas.width/p),canvas.tHeight=Math.ceil(canvas.height/p),ctx=canvas.getContext("2d"),ctx.msImageSmoothingEnabled=!1,ctx.imageSmoothingEnabled=!1,time=new Object,time.now=(new Date).getTime(),time.deltaTime=0,time.lastUpdate=time.now,time.update=function(){this.now=(new Date).getTime(),this.deltaTime=(this.now-this.lastUpdate)/1e3,this.lastUpdate=this.now},input=new Object,input.update=function(){for(var t in input.anyKey=!1,input)if(input.hasOwnProperty(t)){if(null==input[t].keys)continue;null!=input[t].buffer?("pressed"==input[t].buffer&&1!=input[t].state?(input[t].state=!0,input[t].pressed=!0,input[t].released=!1,input.anyKey=!0):"released"==input[t].buffer&&0!=input[t].state&&(input[t].state=!1,input[t].pressed=!1,input[t].released=!0,input[t].buffer=null),input[t].buffer=null):(input[t].pressed=!1,input[t].released=!1)}},input.registerNew=function(t,i){input[t]=new Object,input[t].keys=i,input[t].state=!1,input[t].pressed=!1,input[t].released=!1,input[t].buffer=null},input.clearAll=function(){for(var t in input)if(input.hasOwnProperty(t)){if(null==input[t].keys)continue;input[t].state=!1,input[t].pressed=!1,input[t].released=!1,input[t].buffer=null}},window.onkeydown=function(t){for(var i in input)if(input.hasOwnProperty(i)){if(null==input[i].keys)continue;for(var s=0;s<input[i].keys.length;s++)t.key==input[i].keys[s]&&(input[i].buffer="pressed")}u.isPaused&&u.addPassKey(t.key)},window.onkeyup=function(t){for(var i in input)if(input.hasOwnProperty(i)){if(null==input[i].keys)continue;for(var s=0;s<input[i].keys.length;s++)t.key==input[i].keys[s]&&(input[i].buffer="released")}},stage=new Object,stage.width=0,stage.height=0,stage.currentLevel=t,stage.currentLevelImg=document.createElement("img"),stage.tileIndex=[],stage.actorIndex=[],stage.tiles=[],stage.actors=[],stage.unRegisterList=[],stage.outOfBoundsWalls=[],stage.curtain=null,stage.levelTime=0,stage.levelDeaths=0,stage.showSkipScreen=!1,stage.skipScreen=null,stage.loadCurrentLevel=function(){if(clearInterval(u.Interval),u.Interval=null,61===stage.currentLevel)return stage.currentLevelImg.src="resources/art/game_over.png",stage.currentLevelImg.complete&&(ctx.fillStyle="black",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.drawImage(stage.currentLevelImg,0,0,162,82,canvas.width/2-81,canvas.height/2-41,162,82)),setTimeout(stage.loadCurrentLevel,50),!1;if(stage.currentLevelImg.src="resources/levels/lvl_"+stage.currentLevel+".png",stage.unloadLevel(),ctx.fillStyle="black",ctx.fillRect(0,0,canvas.width,canvas.height),stage.currentLevelImg.complete){ctx.drawImage(stage.currentLevelImg,0,0),stage.width=stage.currentLevelImg.width,stage.height=stage.currentLevelImg.height;for(var t=0;t<stage.width;t++){stage.tiles[t]=[];for(var i=0;i<stage.height;i++){var s=ctx.getImageData(t,i,1,1),e=16,h=Math.round(s.data[0]/e)*e;256===h&&(h=255);var r=Math.round(s.data[1]/e)*e;256===r&&(r=255);var a=Math.round(s.data[2]/e)*e;if(256===a&&(a=255),s=h.toString()+","+r.toString()+","+a.toString(),0==stage.loadTile(t,i,s))return!1}}stage.currentLevelImg.src="";for(t=0;t<stage.width;t++)for(i=0;i<stage.height;i++)stage.tiles[t][i].wakeUp();for(var n=0;n<stage.actors.length;n++)stage.actors[n].wakeUp();return stage.openCurtain(),stage.prepHeadsUpDisplay(),stage.notifications(),u.Interval=setInterval(u.update,1e3/60),!0}return setTimeout(stage.loadCurrentLevel,50),!1},stage.loadTile=function(t,i,s){for(var e=0;e<this.tileIndex.length;e++)for(var h=0;h<this.tileIndex[e].pixelColors.length;h++)if(this.tileIndex[e].pixelColors[h]==s)return this.tiles[t][i]=new this.tileIndex[e](t*p+g,i*p+g,s),!0;this.tiles[t][i]=new f(t*p+g,i*p+g,s);for(e=0;e<this.actorIndex.length;e++)for(h=0;h<this.actorIndex[e].pixelColors.length;h++)if(this.actorIndex[e].pixelColors[h]==s){var r=this.registerActor(new this.actorIndex[e](t*p+g,i*p+g,s));return null!=r.rigidBody&&physics.registerActor(r),!0}return alert("Pixel at "+t+","+i+" of color "+s+" is not a valid color."),!1},stage.prepHeadsUpDisplay=function(){if(1===stage.currentLevel){var t=new HUDImg(0,0,3,240,111,0,0,240,111,"resources/art/instructions_spritesheet.png");t.update=function(){u.isPaused=!0,this.x=parseInt(canvas.width/2-this.w/2),this.y=parseInt(canvas.height/2-this.h/2),input.pause.pressed&&HUD.unRegister(this)},t.draw=function(){ctx.fillStyle="black",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.drawImage(this.img,this.sX,this.sY,this.sW,this.sH,this.x,this.y,this.w,this.h)},HUD.register(t)}var i={msg:"Level: "+stage.currentLevel.toString(),font:"Bold 12px Arial",fill:"white",shadow:{color:"black",blur:2,offsetX:1,offsetY:1}},s=new HUDText(0,0,0,i);s.currentLevel=stage.currentLevel,s.update=function(){this.x=5,this.y=canvas.height-20,this.currentLevel!=stage.currentLevel&&HUD.unRegister(this)},i.msg="Password: "+u.passIndex[stage.currentLevel];var e=new HUDText(0,0,0,i);e.currentLevel=stage.currentLevel,e.update=function(){this.x=4,this.y=canvas.height-5,this.currentLevel!=stage.currentLevel&&HUD.unRegister(this)},HUD.register(e)},stage.registerActor=function(t){for(var i=0;i<this.actors.length;i++){if(this.actors[i]==t)return this.actors[i];if(this.actors[i].z>t.z)return this.actors.splice(i,0,t),t}return this.actors.push(t),t},stage.unRegisterActor=function(t){this.unRegisterList.push(t)},stage.unloadLevel=function(){stage.tiles=[],stage.actors=[],stage.unRegisterList=[],stage.outOfBoundsWalls=[],physics.actors=[],HUD.elements=[]},stage.getTile=function(t,i){if(0<=t&&t<stage.width&&0<=i&&i<stage.height)return stage.tiles[t][i];for(var s=0;s<stage.outOfBoundsWalls.length;s++)if(stage.outOfBoundsWalls[s].sX===t&&stage.outOfBoundsWalls[s].sY===i)return stage.outOfBoundsWalls[s];var e=new m(0,0);return e.sprite.source.x=4*e.sprite.sheet.cellW,e.sprite.source.y=6*e.sprite.sheet.cellH,e.x=t*p+g,e.y=i*p+g,e.sX=t,e.sY=i,stage.outOfBoundsWalls.push(e),e},stage.getTileAtWorld=function(t,i){return this.getTile(parseInt(t/p),parseInt(i/p))},stage.getTilesInside=function(t,i,s,e){t=Math.floor(t/p),i=Math.floor(i/p),s=Math.floor(s/p),e=Math.floor(e/p);for(var h=[],r=0;r<=e-s;r++){h[r]=[];for(var a=0;a<=i-t;a++)h[r][a]=stage.getTile(s+r,t+a)}return h},stage.update=function(){stage.levelTime+=time.deltaTime;for(var t=0;t<stage.height;t++)for(var i=0;i<stage.width;i++)null!=stage.tiles[i][t].update&&stage.tiles[i][t].update();if(0!=this.unRegisterList.length){for(var s=0;s<this.unRegisterList.length;s++)for(var e=0;e<this.actors.length;e++)if(this.actors[e]==this.unRegisterList[s]){this.actors.splice(e,1);break}this.unRegisterList=[]}for(s=0;s<this.actors.length;s++)null!=this.actors[s].update&&this.actors[s].update();for(s=0;s<this.actors.length;s++)null!=this.actors[s].lateUpdate&&this.actors[s].lateUpdate()},stage.sortActors=function(){for(var t=0;t<stage.actors.length-1;t++)if(stage.actors[t].z>stage.actors[t+1].z||stage.actors[t].z==stage.actors[t+1].z&&stage.actors[t].y>stage.actors[t+1].y){var i=stage.actors[t];stage.actors[t]=stage.actors[t+1],stage.actors[t+1]=i}},stage.notifications=function(){if(2<=stage.currentLevel&&stage.currentLevel<=4){var t={font:"Bold 11px Arial",fill:"white",shadow:{color:"black",blur:2,offsetX:1,offsetY:1},msg:""};(i=new HUDText(2,12,10,t)).timer=10,HUD.register(i),i.update=function(){1!=u.isPaused&&(this.timer-=time.deltaTime),this.timer<0&&(this.msg="Tip: You can press R at anytime to restart a level."),this.timer<-10&&HUD.unRegister(this)}}if(6<=stage.currentLevel&&stage.currentLevel<=7){t={font:"Bold 11px Arial",fill:"white",shadow:{color:"black",blur:2,offsetX:1,offsetY:1},msg:""};(i=new HUDText(2,12,10,t)).timer=10,HUD.register(i),i.update=function(){1!=u.isPaused&&(this.timer-=time.deltaTime),this.timer<0&&(this.msg="Tip: Use passwords to skip to a specific level."),this.timer<-15&&HUD.unRegister(this)},(i=new HUDText(2,28,10,t)).timer=10,HUD.register(i),i.update=function(){1!=u.isPaused&&(this.timer-=time.deltaTime),this.timer<0&&(this.msg="Press Enter to pause and type the password in."),this.timer<-15&&HUD.unRegister(this)}}if(9<=stage.currentLevel&&stage.currentLevel<=10){t={font:"Bold 11px Arial",fill:"white",shadow:{color:"black",blur:2,offsetX:1,offsetY:1},msg:""};(i=new HUDText(2,12,10,t)).timer=10,HUD.register(i),i.update=function(){1!=u.isPaused&&(this.timer-=time.deltaTime),this.timer<0&&(this.msg="Tip: Don't forget to write down the password!"),this.timer<-10&&HUD.unRegister(this)}}if(14===stage.currentLevel){var i;t={font:"Bold 11px Arial",fill:"white",shadow:{color:"black",blur:2,offsetX:1,offsetY:1},msg:""};(i=new HUDText(2,12,10,t)).timer=5,HUD.register(i),i.update=function(){1!=u.isPaused&&(this.timer-=time.deltaTime),this.timer<0&&(this.msg="Tip: Press the SpaceBar to fire!"),this.timer<-10&&HUD.unRegister(this)}}},stage.skipLevelCheck=function(){240<=stage.levelTime&&5<=stage.levelDeaths&&(stage.showSkipScreen=!0)},stage.openSkipScreen=function(){stage.showSkipScreen=!1,stage.skipScreen=new Object,HUD.register(stage.skipScreen),stage.skipScreen.members=[],stage.skipScreen.answer=!1,stage.skipScreen.update=function(){u.isPaused=!0,input.pause.pressed&&(!0===this.answer?(stage.levelTime=0,stage.levelDeaths=0,stage.currentLevel+=1):stage.levelDeaths=2,u.nextLevel=!0),!0===input.anyKey&&1!=input.pause.pressed&&(!0===this.answer?this.answer=!1:this.answer=!0);for(var t=0;t<this.members.length;t++)null!=this.members[t].update&&this.members[t].update()},stage.skipScreen.draw=function(){for(var t=0;t<this.members.length;t++)null!=this.members[t].draw&&this.members[t].draw()};var t=new HUDRect(0,0,2,0,0,"black");stage.skipScreen.members.push(t),t.update=function(){this.x=0,this.y=0,this.w=canvas.width,this.h=canvas.height};var i={font:"Bold 12px Arial",fill:"white",shadow:{color:"black",blur:2,offsetX:1,offsetY:1},msg:"You seem to be struggling."},s=new HUDText(0,0,10,i);stage.skipScreen.members.push(s),s.update=function(){this.x=canvas.width/2-75,this.y=canvas.height/2-32},i.msg="Would you like to skip this level?";s=new HUDText(0,0,10,i);stage.skipScreen.members.push(s),s.update=function(){this.x=canvas.width/2-88,this.y=canvas.height/2-16},i.msg="Yes",i.fill="rgb(100,100,100)";s=new HUDText(0,0,10,i);stage.skipScreen.members.push(s),s.update=function(){this.y=canvas.height/2+16,!0===stage.skipScreen.answer?(this.x=canvas.width/2-42,this.fill="rgb(0,255,0)",this.font="Bold 14px Arial"):(this.x=canvas.width/2-40,this.fill="rgb(100,100,100)",this.font="Bold 12px Arial")},i.msg="No";s=new HUDText(0,0,10,i);stage.skipScreen.members.push(s),s.update=function(){this.y=canvas.height/2+16,!1===stage.skipScreen.answer?(this.x=canvas.width/2+19,this.fill="rgb(255,0,0)",this.font="Bold 14px Arial"):(this.x=canvas.width/2+20,this.fill="rgb(100,100,100)",this.font="Bold 12px Arial")}},stage.openCurtain=function(){null===this.curtain&&(this.curtain=new HUDRect(0,0,2,0,0,"black"),this.curtain.state="opening",this.curtain.timer=0,this.curtain.length=.5,this.curtain.update=function(){u.isPaused=!0,this.timer+=time.deltaTime,this.timer>this.length&&(this.timer=this.length),this.x=0,this.y=0,this.w=canvas.width,this.h=canvas.height*(1-this.timer/this.length),this.timer===this.length&&(HUD.unRegister(this),u.isPaused=!1,stage.curtain=null)},HUD.register(this.curtain))},stage.closeCurtain=function(){null===this.curtain&&(this.curtain=new HUDRect(0,0,2,0,0,"black"),this.curtain.state="closing",this.curtain.timer=0,this.curtain.length=.5,this.curtain.update=function(){u.isPaused=!0,this.timer+=time.deltaTime,this.timer>this.length&&(this.timer=this.length),this.w=canvas.width*(this.timer/this.length),this.h=canvas.height*(this.timer/this.length),this.x=canvas.width/2-this.w/2,this.y=canvas.height/2-this.h/2,this.timer===this.length&&(HUD.unRegister(stage.curtain),stage.curtain=null,!1===stage.showSkipScreen?u.nextLevel=!0:stage.openSkipScreen())},HUD.register(this.curtain))},physics=new Object,physics.actors=[],physics.unRegisterList=[],physics.registerList=[],physics.update=function(){if(0!=this.unRegisterList.length){for(var t=0;t<this.unRegisterList.length;t++)for(var i=0;i<this.actors.length;i++)if(this.actors[i]==this.unRegisterList[t]){this.actors.splice(i,1);break}this.unRegisterList=[]}if(0!=this.registerList.length){for(t=0;t<this.registerList.length;t++){for(i=0;i<this.actors.length&&this.actors[i]!=this.registerList[t];i++);this.actors.push(this.registerList[t])}this.registerList=[]}for(t=0;t<this.actors.length;t++){var s=this.actors[t].rigidBody;if((0!=s.velocity.x||0!=s.velocity.y)&&"static"!=s.type){if(0<s.friction){var e=s.friction*s.velocity.x*time.deltaTime,h=s.friction*s.velocity.y*time.deltaTime;Math.abs(e)<Math.abs(s.velocity.x)?s.velocity.x-=e:s.velocity.x=0,Math.abs(h)<Math.abs(s.velocity.y)?s.velocity.y-=h:s.velocity.y=0,Math.abs(s.velocity.x)<1&&(s.velocity.x=0),Math.abs(s.velocity.y)<1&&(s.velocity.y=0)}this.actors[t].x+=s.velocity.x*time.deltaTime,this.actors[t].y+=s.velocity.y*time.deltaTime}}for(var r=[],a=!0;a;){a=!1;for(t=0;t<this.actors.length;t++){for(i=t+1;i<this.actors.length;i++){if(0!=(g=this.getOverlap(this.actors[t],this.actors[i])).x&&0!=g.y){null==r[t]&&(r[t]=new d(this.actors[t])),null==r[i]&&(r[i]=new d(this.actors[i]));for(var n=!1,o=0;o<r[t].list.length;o++)r[t].list[o]==this.actors[i]&&(n=!0);0==n&&(a=!0,r[t].add(this.actors[i]),r[i].add(this.actors[t]),this.findLimits(r[t],r[i],g))}}for(var l=stage.getTilesInside(this.actors[t].top,this.actors[t].bottom,this.actors[t].left,this.actors[t].right),c=0;c<l.length;c++)for(var p=0;p<l[c].length;p++){var g;if(null!=l[c][p].rigidBody)if(0!=(g=this.getOverlap(this.actors[t],l[c][p])).x&&0!=g.y){null==r[t]&&(r[t]=new d(this.actors[t]));for(n=!1,i=0;i<r[t].list.length;i++)r[t].list[i]==l[c][p]&&(n=!0);if(0==n){a=!0,r[t].add(l[c][p]);var u=new d(l[c][p]);u.add(this.actors[t]),this.findLimits(r[t],u,g)}}}}if(1==a)for(t=0;t<r.length;t++)null!=r[t]&&(null!=r[t].lLim&&null!=r[t].rLim?(this.actors[t].x=(r[t].lLim+r[t].rLim)/2,Math.abs(r[t].rLim-r[t].lLim)<this.actors[t].width/2&&null!=this.actors[t].kill&&this.actors[t].kill(physics)):(null!=r[t].lLim&&(this.actors[t].x=r[t].lLim+this.actors[t].width/2),null!=r[t].rLim&&(this.actors[t].x=r[t].rLim-this.actors[t].width/2)),null!=r[t].tLim&&null!=r[t].bLim?(this.actors[t].y=(r[t].tLim+r[t].bLim)/2,Math.abs(r[t].bLim-r[t].tLim)<this.actors[t].height/2&&null!=this.actors[t].kill&&this.actors[t].kill(physics)):(null!=r[t].tLim&&(this.actors[t].y=r[t].tLim+this.actors[t].height/2),null!=r[t].bLim&&(this.actors[t].y=r[t].bLim-this.actors[t].height/2)))}for(t=0;t<r.length;t++)if(null!=r[t]){var y={x:r[t].target.x-r[t].startPos.x,y:r[t].target.y-r[t].startPos.y},f=r[t].target.rigidBody.mass*Math.sqrt(Math.pow(y.x/time.deltaTime,2)+Math.pow(y.y/time.deltaTime,2));physics.applyForce(f,y.x,y.y,r[t].target.rigidBody)}for(t=0;t<r.length;t++)if(null!=r[t])for(i=0;i<r[t].list.length;i++)null!=r[t].target.hit&&r[t].target.hit(r[t].list[i]),r[t].list[i].isTile&&null!=r[t].list[i].hit&&r[t].list[i].hit(r[t].target)},physics.registerActor=function(t){this.registerList.push(t)},physics.unRegisterActor=function(t){this.unRegisterList.push(t)},d.prototype.add=function(t){this.list.push(t)},physics.findLimits=function(t,i,s){var e=t.target,h=i.target,r=e.rigidBody,a=h.rigidBody;if("trigger"!=r.type&&"trigger"!=a.type&&!("weightless"==r.type&&"weightless"==a.type||"static"==r.type&&"static"==a.type)){for(var n=0;n<r.ignores.length;n++)if(r.ignores[n]==h.constructor)return;for(n=0;n<a.ignores.length;n++)if(a.ignores[n]==e.constructor)return;var o=.001;if("static"==r.type||"weightless"!=r.type&&"static"!=a.type)if("static"==a.type||"weightless"!=a.type&&"static"!=r.type){if("static"!=r.type&&"static"!=a.type)if(Math.abs(s.x)<Math.abs(s.y)){var l=Math.abs(s.x)*(a.mass/(r.mass+a.mass)),c=Math.abs(s.x)*(r.mass/(r.mass+a.mass));e.x>h.x?((null==t.lLim||t.lLim<h.right-c)&&(t.lLim=h.right-c),(null==i.rLim||i.rLim>e.left+l)&&(i.rLim=e.left+l)):((null==t.rLim||t.rLim>h.left-c)&&(t.rLim=h.left+c),(null==i.lLim||i.lLim<e.right+l)&&(i.lLim=e.right-l))}else{l=Math.abs(s.y)*(r.mass/(r.mass+a.mass)),c=Math.abs(s.y)*(a.mass/(r.mass+a.mass));e.y>h.y?((null==t.tLim||t.tLim<h.bottom-c)&&(t.tLim=h.bottom-c),(null==i.bLim||i.bLim>e.top+l)&&(i.bLim=e.top+l)):((null==t.bLim||t.bLim>h.top-c)&&(t.bLim=h.top+c),(null==i.tLim||i.tLim<e.bottom+l)&&(i.tLim=e.bottom-l))}}else Math.abs(s.x)<Math.abs(s.y)?h.x>e.x?(null==i.lLim||i.lLim<e.right+o)&&(i.lLim=e.right+o):(null==i.rLim||i.rLim>e.left-o)&&(i.rLim=e.left-o):h.y>e.y?(null==i.tLim||i.tLim<e.bottom+o)&&(i.tLim=e.bottom+o):(null==i.bLim||i.bLim>e.top-o)&&(i.bLim=e.top-o);else Math.abs(s.x)<Math.abs(s.y)?e.x>h.x?(null==t.lLim||t.lLim<h.right+o)&&(t.lLim=h.right+o):(null==t.rLim||t.rLim>h.left-o)&&(t.rLim=h.left-o):e.y>h.y?(null==t.tLim||t.tLim<h.bottom+o)&&(t.tLim=h.bottom+o):(null==t.bLim||t.bLim>h.top-o)&&(t.bLim=h.top-o)}},physics.getOverlap=function(t,i){var s={x:0,y:0};return t.x>i.x?t.left<i.right&&(s.x=t.left-i.right):t.right>i.left&&(s.x=t.right-i.left),t.y>i.y?t.top<i.bottom&&(s.y=t.top-i.bottom):t.bottom>i.top&&(s.y=t.bottom-i.top),s},physics.rayTrace=function(t,i,s,e){var h=[],r=Math.abs(s-t),a=Math.abs(e-i),n=t,o=i,l=1+r+a;if(t<s)var c=1;else c=-1;if(i<e)var p=1;else p=-1;var g=r-a;r*=2,a*=2;for(l=l;0<l;--l)h.push(stage.getTile(n,o)),0<g?(n+=c,g-=a):(o+=p,g+=r);return h},physics.applyForce=function(t,i,s,e){var h=Math.sqrt(Math.abs(i)/(Math.abs(i)+Math.abs(s)))||0,r=Math.sqrt(Math.abs(s)/(Math.abs(i)+Math.abs(s)))||0;i<0&&(h*=-1),s<0&&(r*=-1);var a=t/e.mass;e.velocity.x+=a*h,e.velocity.y+=a*r},camera=new Object,camera.x=0,camera.y=0,Object.defineProperty(camera,"sX",{get:function(){return parseInt(this.x/p)}}),Object.defineProperty(camera,"sY",{get:function(){return parseInt(this.y/p)}}),camera.scale=s,camera.focus=null,camera.panMode=!1,camera.outOfBoundsWall=null,input.registerNew("dbug",[]),camera.update=function(){null!=this.focus&&(0==this.panMode?(this.x=this.focus.x,this.y=this.focus.y):console.log("Pan Mode not written yet"));for(var t=Math.ceil(Math.ceil(canvas.tWidth/this.scale)/2),i=Math.ceil(Math.ceil(canvas.tHeight/this.scale)/2),s=this.sX-t,e=this.sX+t+1,h=this.sY-i,r=this.sY+i+1,a=h;a<r;a++)for(var n=s;n<e;n++)0<=n&&n<stage.width&&0<=a&&a<stage.height?this.draw(stage.getTile(n,a)):(null===camera.outOfBoundsWall&&(camera.outOfBoundsWall=new m(0,0),camera.outOfBoundsWall.sprite.source.x=4*camera.outOfBoundsWall.sprite.sheet.cellW,camera.outOfBoundsWall.sprite.source.y=6*camera.outOfBoundsWall.sprite.sheet.cellH),camera.outOfBoundsWall.x=n*p+g,camera.outOfBoundsWall.y=a*p+g,this.draw(camera.outOfBoundsWall));if(u.isInDBug)for(n=s;n<e;n++)for(a=h;a<r;a++)this.drawDBUG(stage.getTile(n,a));t=Math.ceil(Math.ceil(canvas.width/this.scale)/2),i=Math.ceil(Math.ceil(canvas.height/this.scale)/2),s=this.x-t,e=this.x+t+1,h=this.y-i,r=this.y+i+1,stage.sortActors();for(var o=0;o<stage.actors.length;o++){var l=stage.actors[o],c=stage.actors[o].sprite;l.x+c.offset.x+c.sheet.cellW>s&&l.x+c.offset.x-c.sheet.cellW<e&&l.y+c.offset.y+c.sheet.cellH>h&&l.y+c.offset.y-c.sheet.cellH<r&&this.draw(stage.actors[o])}if(u.isInDBug)for(o=0;o<stage.actors.length;o++){l=stage.actors[o],c=stage.actors[o].sprite;l.x+c.offset.x+c.sheet.cellW>s&&l.x+c.offset.x-c.sheet.cellW<e&&l.y+c.offset.y+c.sheet.cellH>h&&l.y+c.offset.y-c.sheet.cellH<r&&this.drawDBUG(stage.actors[o])}for(o=0;o<HUD.elements.length;o++)HUD.elements[o].draw()},camera.draw=function(t){var i=t.sprite.sheet.cellW,s=t.sprite.sheet.cellH,e=(t.x+t.sprite.offset.x-i/2)*this.scale-(this.x*this.scale-canvas.width/2),h=(t.y+t.sprite.offset.y-s/2)*this.scale-(this.y*this.scale-canvas.height/2);if(0<e+i*this.scale&&0<h+s*this.scale&&e<canvas.width&&h<canvas.height){var r=t.sprite.sheet;if(r.complete){var a=t.sprite.source.x,n=t.sprite.source.y,o=i*this.scale,l=s*this.scale;e=Math.round(e,1),h=Math.round(h,1),o=Math.round(o,1),l=Math.round(l,1),ctx.drawImage(r,a,n,i,s,e,h,o,l)}}},camera.drawDBUG=function(t){var i=t.sprite.sheet.cellW,s=t.sprite.sheet.cellH,e=(t.x+t.sprite.offset.x-i/2)*this.scale-(this.x*this.scale-canvas.width/2),h=(t.y+t.sprite.offset.y-s/2)*this.scale-(this.y*this.scale-canvas.height/2);if(0<e+i*this.scale&&0<h+s*this.scale&&e<canvas.width&&h<canvas.height&&t.sprite.sheet.complete){t.sprite.source.x,t.sprite.source.y;var r=i*this.scale,a=s*this.scale;e=Math.round(e,1),h=Math.round(h,1),r=Math.round(r,1),a=Math.round(a,1),null!=t.rigidBody&&(e=Math.round(t.x*this.scale-(this.x*this.scale-canvas.width/2)-t.width*this.scale/2),h=Math.round(t.y*this.scale-(this.y*this.scale-canvas.height/2)-t.height*this.scale/2),ctx.strokeStyle="red",ctx.strokeRect(e,h,t.width*this.scale,t.height*this.scale))}},HUD=new Object,HUD.elements=[],HUD.registerList=[],HUD.unRegisterList=[],HUD.update=function(){if(0!=this.unRegisterList.length){for(var t=0;t<this.unRegisterList.length;t++)for(var i=0;i<this.elements.length;i++)if(this.elements[i]==this.unRegisterList[t]){this.elements.splice(i,1);break}this.unRegisterList=[]}if(0!=this.registerList.length){for(t=0;t<this.registerList.length;t++){for(i=0;i<this.elements.length;i++)if(this.elements[i].z>this.registerList[t].z){this.elements.splice(i,0,this.registerList[t]);break}i>=this.elements.length&&this.elements.push(this.registerList[t])}this.registerList=[]}for(t=0;t<this.elements.length;t++)null!=this.elements[t].update&&this.elements[t].update()},HUD.register=function(t){for(var i=0;i<this.registerList.length;i++)if(this.registerList[i]==t)return!1;return this.registerList.push(t),!0},HUD.unRegister=function(t){for(var i=0;i<this.unRegisterList.length;i++)if(this.unRegisterList[i]==t)return!1;return this.unRegisterList.push(t),!0},HUD.cleanUp=function(){ctx.font=null,ctx.fillStyle=null,ctx.strokeStyle=null,ctx.lineWidth=1,ctx.shadowColor=null,ctx.shadowBlur=null,ctx.shadowOffsetX=null,ctx.shadowOffsetY=null},HUDRect=function(t,i,s,e,h,r,a){this.x=t,this.y=i,this.z=s,this.w=e,this.h=h,this.fillColor=r,this.strokeColor=a},HUDRect.prototype.draw=function(){null!=this.strokeColor&&(ctx.fillStyle=this.strokeColor,ctx.strokeRect(this.x,this.y,this.w,this.h)),null!=this.fillColor&&(ctx.fillStyle=this.fillColor,ctx.fillRect(this.x,this.y,this.w,this.h)),HUD.cleanUp()},HUDText=function(t,i,s,e){this.x=t,this.y=i,this.z=s,this.msg=e.msg,this.font=e.font,this.fill=e.fill,this.stroke=e.stroke,this.lineWidth=e.lineWidth,this.shadow=e.shadow},HUDText.prototype.draw=function(){ctx.font=this.font,ctx.lineWidth=this.lineWidth,null!=this.stroke&&(ctx.strokeStyle=this.stroke,ctx.strokeText(this.msg,this.x,this.y)),null!=this.fill&&(null!=this.shadow&&(null!=this.shadow.color&&(ctx.shadowColor=this.shadow.color),null!=this.shadow.blur&&(ctx.shadowBlur=this.shadow.blur),null!=this.shadow.offsetX&&(ctx.shadowOffsetX=this.shadow.offsetX),null!=this.shadow.offsetY&&(ctx.shadowOffsetY=this.shadow.offsetY)),ctx.fillStyle=this.fill,ctx.fillText(this.msg,this.x,this.y)),HUD.cleanUp()},HUDImg=function(t,i,s,e,h,r,a,n,o,l){this.x=t,this.y=i,this.z=s,this.w=e,this.h=h,this.sX=r,this.sY=a,this.sW=n,this.sH=o,this.img=new Image,this.img.src=l},HUDImg.prototype.draw=function(){ctx.drawImage(this.img,this.sX,this.sY,this.sW,this.sH,this.x,this.y,this.w,this.h)};var u=new Object;function h(t,i){return Math.random()*(i-t)+t}function r(t,i){return parseInt(Math.random()*(i-t+1)+t)}function a(t){return"up"===t?{x:0,y:-1}:"down"===t?{x:0,y:1}:"left"===t?{x:-1,y:0}:"right"===t?{x:1,y:0}:void 0}function n(t){return"up"===t?"right":"down"===t?"left":"left"===t?"up":"right"===t?"down":void 0}function o(t){return"up"===t?"left":"down"===t?"right":"left"===t?"down":"right"===t?"up":void 0}function l(t,i,s,e){this.owner=t,this.offset={x:i,y:s},this.source={x:0,y:0},this.sheet=e}function c(t,i,s,e,h,r){this.velocity=new Object,this.velocity.x=0,this.velocity.y=0,this.owner=t,this.mass=i,this.friction=s,this.collider=e,Object.defineProperty(t,"width",{get:function(){return this.rigidBody.collider.w}}),Object.defineProperty(t,"height",{get:function(){return this.rigidBody.collider.h}}),Object.defineProperty(t,"top",{get:function(){return this.y-this.rigidBody.collider.h/2}}),Object.defineProperty(t,"bottom",{get:function(){return this.y+this.rigidBody.collider.h/2}}),Object.defineProperty(t,"left",{get:function(){return this.x-this.rigidBody.collider.w/2}}),Object.defineProperty(t,"right",{get:function(){return this.x+this.rigidBody.collider.w/2}}),this.type=h||"soft",this.ignores=r||[]}function y(){this.loop=[],this.state=null,this.direction=null,this.current=0,this.time=0,this.rate=0}function f(t,i){this.x=t,this.y=i,this.z=0,this.sX=parseInt(t/p),this.sY=parseInt(i/p),this.sprite=new l(this,0,0,f.sheet),this.isBlocked=!1}function m(t,i){this.x=t,this.y=i,this.z=0,this.sX=parseInt(t/p),this.sY=parseInt(i/p),this.sprite=new l(this,0,0,m.sheet),this.rigidBody=new c(this,null,null,{w:p,h:p},"static"),this.isBlocked=!0}function x(t,i){this.x=t,this.y=i,this.z=0,this.sX=parseInt(t/p),this.sY=parseInt(i/p),this.sprite=new l(this,0,0,x.sheet),this.rigidBody=new c(this,null,null,{w:p,h:p},"trigger"),this.isBlocked=!1,this.pull=[]}function w(t,i){this.x=t,this.y=i,this.z=0,this.sX=parseInt(t/p),this.sY=parseInt(i/p),this.sprite=new l(this,0,0,w.sheet),this.isBlocked=!1,this.state="up"}function v(t,i){this.x=t,this.y=i,this.z=0,this.sX=parseInt(t/p),this.sY=parseInt(i/p),this.rigidBody=new c(this,null,null,{w:p,h:p},"static"),this.sprite=new l(this,0,0,v.sheet),this.isBlocked=!0,this.state="closed",this.facing=null,this.curtain=null,this.type="wall"}input.registerNew("pause",["Enter"]),u.lastPause=0,u.isPaused=!1,u.isInDBug=!1,u.interval=null,u.nextLevel=!1,u.passCurrent="",u.passIndex=["default","HELLO1","WORLD2","WELCOME3","TO4","SOKOBAN5","BUZZ6","LOOPER7","ARCHER8","CLASSIC9","KNIGHTS10","NEEDLES11","RUSH12","CRUSH13","FREEZE14","DROWN15","BLOCKED16","CHECKER17","TIMING18","TWINS19","EYES20","ROOMS21","CONGO22","SPIRAL23","TRAPPED24","ROUTE25","FOLLOW26","LOLO27","FLYING28","REVENGE29","BOSS30","STOP31","SCREWED32","PRISONS33","CAREFUL34","XFIRE35","ROVER36","MAZE37","CLASSIC38","SHIELD39","BORROW40","CLASSIC41","ISLANDS42","SHRED43","CLASSIC44","SUNKEN45","PATROL46","CLASSIC47","CLASSIC48","RACE49","CLASSIC50","REPEATS51","STEADY52","FUSE53","BEEHIVE54","DRIFT55","RUN56","FISHING57","FUSETWO58","THEEND59","PARTTWO60","GAMEOVER","BONUS62","BONUS63","BONUS64","BONUS65","BONUS66","BONUS67","BONUS68","BONUS69","BONUS70","BONUS71","BONUS72","BONUS73","BONUS74","BONUS75","BONUS76","BONUS77","BONUS78","BONUS79","BONUS80"],u.update=function(){time.update(),input.update(),0==u.isPaused&&(stage.update(),physics.update()),HUD.update(),camera.update(),input.pause.pressed&&(u.isPaused?u.unPause():u.pause()),input.dbug.pressed&&!1===u.isPaused&&(!0===u.isInDBug?u.isInDBug=!1:u.isInDBug=!0),!0===u.nextLevel&&(u.nextLevel=!1,stage.loadCurrentLevel())},u.pause=function(){var t=(new Date).getTime();if(500<t-this.lastPause){this.lastPause=t,this.isPaused=!0,input.clearAll();var i={msg:"Paused",font:"Bold 42px Arial",fill:"white",shadow:{color:"black",blur:2,offsetX:1,offsetY:1}},s=new HUDText(0,0,10,i);HUD.register(s),s.update=function(){this.x=canvas.width/2-70,this.y=canvas.height/2,0==u.isPaused&&HUD.unRegister(this)},i={msg:"Enter Password: ",font:"Bold 12px Arial",fill:"white",shadow:{color:"black",blur:2,offsetX:1,offsetY:1}};var e=new HUDText(0,0,10,i);HUD.register(e),e.update=function(){this.x=canvas.width/2-68,this.y=canvas.height/2+15,0==u.isPaused&&HUD.unRegister(this)},i.msg="";var h=new HUDText(0,0,10,i);HUD.register(h),h.update=function(){this.msg=u.passCurrent,this.x=canvas.width/2+35,this.y=canvas.height/2+15,0==u.isPaused&&HUD.unRegister(this)}}},u.unPause=function(){var t=(new Date).getTime();500<t-this.lastPause&&(this.lastPause=t,this.isPaused=!1,input.clearAll())},u.addPassKey=function(t){if("Enter"===t){for(var i=1;i<u.passIndex.length;i++)if(u.passCurrent===u.passIndex[i])return stage.levelTime=0,stage.levelDeaths=0,stage.currentLevel=i,u.nextLevel=!0,!(u.passCurrent="");return u.passCurrent="",!1}if("Backspace"===t){if(0<u.passCurrent.length){var s=[];for(i=0;i<u.passCurrent.length;i++)s[i]=u.passCurrent.toString()[i];s.pop(),u.passCurrent="";for(i=0;i<s.length;i++)u.passCurrent+=s[i];return!0}return!1}var e=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],h=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","0","1","2","3","4","5","6","7","8","9"],r=!1;for(i=0;i<h.length;i++)if(t===h[i]||t===e[i]){t=h[i],r=!0;break}return!1!==r&&(u.passCurrent.length<9&&(u.passCurrent+=t),!0)},y.prototype.update=function(){if(null!=this.loop[this.current].r&&(this.rate=this.loop[this.current].r),0==this.rate)return!1;this.time+=time.deltaTime,this.time>this.rate&&(this.time-=this.rate,this.current+=1,this.current>=this.loop.length&&(this.current=0))},stage.tileIndex.push(f),f.sheet=new Image,f.sheet.src="resources/art/floor_spritesheet.png",f.sheet.cellW=p,f.sheet.cellH=p,f.pixelColors=[],f.pixelColors[0]="255,255,255",f.sheet.index=[0,1,2,3,4,5,6,6],f.prototype.type="floor",f.prototype.isTile=!0,f.prototype.isActor=!1,f.prototype.wakeUp=function(){for(var t=0,i=1,s=[{x:-1,y:-1},{x:0,y:-1},{x:-1,y:0}],e=0;e<s.length;e++)"wall"==stage.getTile(this.sX+s[e].x,this.sY+s[e].y).type&&(t+=i),i*=2;null!=this.sprite.sheet.index[t]&&(this.sprite.source.x=this.sprite.sheet.index[t]*this.sprite.sheet.cellW),this.sprite.source.y+=r(0,2)*this.sprite.sheet.cellH},stage.tileIndex.push(m),m.sheet=new Image,m.sheet.src="resources/art/wall_spritesheet.png",m.sheet.cellW=p,m.sheet.cellH=p,m.pixelColors=[],m.pixelColors[0]="0,0,0",m.sheet.index=[0,0,1,1,0,0,1,1,2,2,3,4,2,2,3,4,5,5,6,6,5,5,7,7,8,8,9,10,8,8,11,12,0,0,1,1,0,0,1,1,2,2,3,4,2,2,3,4,5,5,6,6,5,5,7,7,8,8,9,10,8,8,11,12,13,13,14,14,13,13,14,14,15,15,16,17,15,15,16,17,18,18,19,19,18,18,20,20,21,21,22,23,21,21,24,25,13,13,14,14,13,13,14,14,26,26,27,28,26,26,27,28,18,18,19,19,18,18,20,20,29,29,30,31,29,29,32,33,0,0,1,1,0,0,1,1,2,2,3,4,2,2,3,4,5,5,6,6,5,5,7,7,8,8,9,10,8,8,11,12,0,0,1,1,0,0,1,1,2,2,3,4,2,2,3,4,5,5,6,6,5,5,7,7,8,8,9,10,8,8,11,12,13,13,14,14,13,13,14,14,15,15,16,17,15,15,16,17,34,34,35,35,34,34,36,36,37,37,38,39,37,37,40,41,13,13,14,14,13,13,14,14,26,26,27,28,26,26,27,28,34,34,35,35,34,34,36,36,42,42,43,44,42,42,45,46],m.prototype.type="wall",m.prototype.isBlocked=!0,m.prototype.isTile=!0,m.prototype.isActor=!1,m.prototype.wakeUp=function(){for(var t=0,i=1,s=this.sY-1;s<=this.sY+1;s++)for(var e=this.sX-1;e<=this.sX+1;e++)e==this.sX&&s==this.sY||("wall"==stage.getTile(e,s).type&&(t+=i),i*=2);if(null!=this.sprite.sheet.index[t])for(this.sprite.source.x=this.sprite.sheet.index[t]*this.sprite.sheet.cellW;this.sprite.source.x>=this.sprite.sheet.width;)this.sprite.source.y+=this.sprite.sheet.cellH,this.sprite.source.x-=this.sprite.sheet.width},stage.tileIndex.push(x),x.sheet=new Image,x.sheet.src="resources/art/water_spritesheet.png",x.sheet.cellW=p,x.sheet.cellH=p,x.anim=new y(x),x.anim.lastUpdate=0,x.anim.loop[0]={x:8*p*0,r:.35},x.anim.loop[1]={x:8*p*1,r:.35},x.anim.loop[2]={x:8*p*2,r:.35},x.anim.loop[3]={x:8*p*3,r:.35},x.pixelColors=[],x.pixelColors[0]="0,0,255",x.prototype.type="water",x.prototype.pullSpeed=80,x.prototype.isTile=!0,x.prototype.isActor=!1,x.prototype.wakeUp=function(){for(var t=0,i=1,s=this.sY-1;s<=this.sY+1;s++)for(var e=this.sX-1;e<=this.sX+1;e++)e==this.sX&&s==this.sY||(stage.getTile(e,s).constructor==x&&(t+=i),i*=2);if(null!=m.sheet.index[t])for(this.sprite.source.xOffset=m.sheet.index[t]*this.sprite.sheet.cellW;this.sprite.source.xOffset>=7*this.sprite.sheet.cellW;)this.sprite.source.y+=this.sprite.sheet.cellH,this.sprite.source.xOffset-=7*this.sprite.sheet.cellW;this.sprite.source.x=this.sprite.source.xOffset+x.anim.loop[x.anim.current].x,stage.getTile(this.sX,this.sY+1).constructor!=x?this.pull.up=!0:this.pull.up=!1,stage.getTile(this.sX,this.sY-1).constructor!=x?this.pull.down=!0:this.pull.down=!1,stage.getTile(this.sX+1,this.sY).constructor!=x?this.pull.left=!0:this.pull.left=!1,stage.getTile(this.sX-1,this.sY).constructor!=x?this.pull.right=!0:this.pull.right=!1},x.prototype.update=function(){x.anim.lastUpdate!=time.now&&(x.anim.lastUpdate=time.now,x.anim.update()),this.sprite.source.x=this.sprite.source.xOffset+x.anim.loop[x.anim.current].x,this.sprite.source.y=this.sprite.source.y},x.prototype.hit=function(t){if("water"==this.type)if("crate"==t.type&&t.x==this.x&&t.y==this.y){this.type="floor",this.isBlocked=!1,this.sprite.source.y+=7*this.sprite.sheet.cellH,t.kill(this);var i=stage.getTile(this.sX,this.sY-1);i.constructor==x&&(i.pull.up=!0),(i=stage.getTile(this.sX,this.sY+1)).constructor==x&&(i.pull.down=!0),(i=stage.getTile(this.sX-1,this.sY)).constructor==x&&(i.pull.left=!0),(i=stage.getTile(this.sX+1,this.sY)).constructor==x&&(i.pull.right=!0)}else if("pickup"===t.type)null!=t.kill&&t.kill(this);else if(("player"==t.type||t.constructor==M||"enemy"==t.type)&&t.constructor!=I&&t.sX==this.sX&&t.sY==this.sY){for(var s=stage.getTilesInside(t.top,t.bottom,t.left,t.right),e=!0,h=0;h<s.length&&!0===e;h++)for(var r=0;r<s[h].length&&!0===e;r++)"water"!=s[h][r].type&&(e=!1);if(e)t.rigidBody.velocity.x-=4*t.rigidBody.velocity.x*time.deltaTime,t.rigidBody.velocity.y-=4*t.rigidBody.velocity.y*time.deltaTime,t.constructor!=M&&null!=t.kill&&t.kill(this);else{var a=physics.getOverlap(t,this),n=null,o=null;n=0<a.x?"right":"left",o=0<a.y?"down":"up";var l=null;h=0,r=0;"up"===(l=Math.abs(a.x)<Math.abs(a.y)?!0===this.pull[n]?n:o:!0===this.pull[o]?o:n)?r=-1:"down"===l?r=1:"left"===l?h=-1:"right"===l&&(h=1),t.rigidBody.velocity.x+=h*Math.abs(a.x)*this.pullSpeed*time.deltaTime,t.rigidBody.velocity.y+=r*Math.abs(a.y)*this.pullSpeed*time.deltaTime}}},stage.tileIndex.push(w),w.sheet=f.sheet,w.pixelColors=[],w.pixelColors[0]="255,0,255",w.sheet.index=[0,1,2,3,4,5,6,6],w.prototype.type="floor",w.prototype.isTile=!0,w.prototype.isActor=!1,w.prototype.wakeUp=function(){for(var t=0,i=1,s=[{x:-1,y:-1},{x:0,y:-1},{x:-1,y:0}],e=0;e<s.length;e++)"wall"==stage.getTile(this.sX+s[e].x,this.sY+s[e].y).type&&(t+=i),i*=2;null!=w.sheet.index[t]&&(this.sprite.source.x=w.sheet.index[t]*this.sprite.sheet.cellW),this.sprite.source.y+=3*this.sprite.sheet.cellH},stage.tileIndex.push(v),v.sheet=new Image,v.sheet.src="resources/art/leveldoor_spritesheet.png",v.sheet.cellW=p,v.sheet.cellH=p,v.pixelColors=[],v.pixelColors[0]="0,255,0",v.plates=[],v.prototype.isTile=!0,v.prototype.isActor=!1,v.prototype.wakeUp=function(){v.plates=[];for(var t=0;t<stage.width;t++)for(var i=0;i<stage.height;i++){var s=stage.getTile(t,i);s.constructor==w&&v.plates.push(s)}"closed"==this.state?this.sprite.source.y=0*this.sprite.sheet.cellH:this.sprite.source.y=+this.sprite.sheet.cellH,stage.getTile(this.sX,this.sY-1).constructor!=m?(this.facing="up",this.sprite.source.x=0*this.sprite.sheet.cellW):stage.getTile(this.sX,this.sY+1).constructor!=m?(this.facing="down",this.sprite.source.x=3*this.sprite.sheet.cellW):stage.getTile(this.sX-1,this.sY).constructor!=m?(this.facing="left",this.sprite.source.x=+this.sprite.sheet.cellW):stage.getTile(this.sX+1,this.sY).constructor!=m&&(this.facing="right",this.sprite.source.x=2*this.sprite.sheet.cellW)},v.prototype.update=function(){for(var t=0;t<v.plates.length;t++)if("up"==v.plates[t].state){if("open"==this.state){this.state="closed",this.type="wall",this.rigidBody.type="static",this.sprite.source.y=0*this.sprite.sheet.cellH;for(var i=0;i<physics.actors.length;i++)physics.actors[i].sX===this.sX&&physics.actors[i].sY===this.sY&&("up"===this.facing&&(physics.actors[i].y=this.top-physics.actors[i].height/2),"down"===this.facing&&(physics.actors[i].y=this.bottom+physics.actors[i].height/2),"left"===this.facing&&(physics.actors[i].x=this.left-physics.actors[i].width/2),"right"===this.facing&&(physics.actors[i].x=this.right+physics.actors[i].width/2))}return}"closed"==this.state&&(this.state="open",this.type="floor",this.rigidBody.type="trigger",this.sprite.source.y=+this.sprite.sheet.cellH)},v.prototype.hit=function(t){if("open"==this.state&&"player"==t.type){if("up"==this.facing&&t.top<this.top)return;if("down"==this.facing&&t.bottom>this.bottom)return;if("left"==this.facing&&t.left<this.left)return;if("right"==this.facing&&t.right>this.right)return;stage.currentLevel++,stage.levelTime=0,stage.levelDeaths=0,stage.closeCurtain()}};var T=0,b=1,P=2;function k(t,i){this.x=t,this.y=i,this.z=b,Object.defineProperty(this,"sX",{get:function(){return parseInt(this.x/p)}}),Object.defineProperty(this,"sY",{get:function(){return parseInt(this.y/p)}}),this.type="unit",this.isDead=!1,this.sprite=new l(this,0,0,k.sheet),this.rigidBody=new c(this,5,5,{w:16,h:16},"soft")}function L(t,i){this.x=t,this.y=i,this.z=b,Object.defineProperty(this,"sX",{get:function(){return parseInt(this.x/p)}}),Object.defineProperty(this,"sY",{get:function(){return parseInt(this.y/p)}}),this.type="player",this.isDead=!1,this.sprite=new l(this,0,-4.5,L.sheet),this.rigidBody=new c(this,5,7,{w:12,h:12},"soft"),this.state="idle",this.anim=new y,this.facing="down",this.moveForce=3e3,this.inputQueue=[],this.pushToggle=!1,this.ammo=0,this.ammoText=null,this.setAnimation(this.state)}function B(t,i){this.x=t,this.y=i,this.z=T,Object.defineProperty(this,"sX",{get:function(){return parseInt(this.x/p)}}),Object.defineProperty(this,"sY",{get:function(){return parseInt(this.y/p)}}),stage.getTile(this.sX,this.sY).isBlocked=!0,this.type="crate",this.isDead=!1,this.sprite=new l(this,0,0,B.sheet),this.rigidBody=new c(this,2,5,{w:p,h:p},"static"),this.facing=null,this.state=null,this.pusher=null,this.slideTile=null,this.slideSpeed=38}function S(t,i,s){this.x=t,this.y=i,this.z=b,Object.defineProperty(this,"sX",{get:function(){return parseInt(this.x/p)}}),Object.defineProperty(this,"sY",{get:function(){return parseInt(this.y/p)}}),this.type="enemy",this.isDead=!1,this.state="ready",this.facing="down",this.sprite=new l(this,0,-3,S.sheet),this.rigidBody=new c(this,0,0,{w:14,h:14},"static"),this.anim=new y,this.minShootForce=400,this.maxShootForce=800,this.shootForcePer=3,this.canFire=!0,this.targetPlayer=null,this.arrows=[]}function Y(t,i,s){this.x=t,this.y=i,this.z=b,Object.defineProperty(this,"sX",{get:function(){return parseInt(this.x/p)}}),Object.defineProperty(this,"sY",{get:function(){return parseInt(this.y/p)}}),this.type="projectile",this.isDead=!1,this.sprite=new l(this,0,0,Y.sheet),this.rigidBody=new c(this,1,0,{w:3,h:3},"trigger"),this.firer=s,this.facing=s.facing,this.hitTarget=null}function X(t,i,s){this.x=t,this.y=i,this.z=b,Object.defineProperty(this,"sX",{get:function(){return parseInt(this.x/p)}}),Object.defineProperty(this,"sY",{get:function(){return parseInt(this.y/p)}}),this.sprite=new l(this,0,-1.5,X.sheet),this.rigidBody=new c(this,5,7,{w:12,h:12},"soft"),this.anim=new y,s===X.pixelColors[0]&&(this.hand="left"),s===X.pixelColors[1]&&(this.hand="right"),this.state="idle",this.type="enemy",this.isDead=!1,this.facing="down",this.targetPlayer=null,this.lastLookFrom=null,this.lastLookTo=null,this.canSeePlayer=!1,this.playerLastSeen=null,this.idleTimer={cur:0,max:2},this.moveForce=this.walkForce,this.wayPoints=[],this.lastHandChange=0}function H(t,i,s,e){this.tile=t,this.prev=i,this.distance=s,this.heuristic=e||0}function I(t,i,s){this.x=t,this.y=i,this.z=b,Object.defineProperty(this,"sX",{get:function(){return parseInt(this.x/p)}}),Object.defineProperty(this,"sY",{get:function(){return parseInt(this.y/p)}}),this.type="enemy",this.isDead=!1,this.sprite=new l(this,.5,1,I.sheet),this.rigidBody=new c(this,2,5,{w:14,h:14},"weightless",[L,I]),this.anim=new y,s===I.pixelColors[0]&&(this.state="clockwise"),s===I.pixelColors[1]&&(this.state="counter-clockwise"),this.moveForce=1200,this.facing="up"}function U(t,i){this.x=t,this.y=i,this.z=b,Object.defineProperty(this,"sX",{get:function(){return parseInt(this.x/p)}}),Object.defineProperty(this,"sY",{get:function(){return parseInt(this.y/p)}}),this.type="pickup",this.isDead=!1,this.anim=new y,this.sprite=new l(this,0,-3,U.sheet),this.rigidBody=new c(this,1,1,{w:4,h:8},"soft")}function D(t,i,s){this.x=t,this.y=i,this.z=b,Object.defineProperty(this,"sX",{get:function(){return parseInt(this.x/p)}}),Object.defineProperty(this,"sY",{get:function(){return parseInt(this.y/p)}}),this.firer=s,this.facing=s.facing,this.type="projectile",this.isDead=!1,this.sprite=new l(this,0,0,D.sheet),this.rigidBody=new c(this,1,0,{w:12,h:12},"trigger"),this.anim=new y,this.anim.rate=.1,this.speed=120,this.wakeUp()}function M(t){this.x=t.x,this.y=t.y,this.z=b,Object.defineProperty(this,"sX",{get:function(){return parseInt(this.x/p)}}),Object.defineProperty(this,"sY",{get:function(){return parseInt(this.y/p)}}),this.frozenActor=t,this.type="unit",this.isDead=!1,this.sprite=new l(this,0,0,M.sheet),this.rigidBody=new c(this,t.rigidBody.mass,2,{w:t.width,h:t.height},"soft"),this.colliderTrueSize={w:18,h:16},this.needPhysReg=!0,this.meltTimer=8,this.wakeUp()}k.pixelColors=[],k.pixelColors[0]="255,128,255",stage.actorIndex.push(k),k.sheet=new Image,k.sheet.src="resources/art/tester_spritesheet.png",k.sheet.cellW=16,k.sheet.cellH=16,k.prototype.isTile=!1,k.prototype.isActor=!0,k.prototype.lateUpdate=function(){},k.prototype.wakeUp=function(){},k.prototype.hit=function(t){},k.prototype.kill=function(t){this.isDead=!0,stage.unRegisterActor(this),physics.unRegisterActor(this)},L.pixelColors=[],L.pixelColors[0]="255,0,0",stage.actorIndex.push(L),L.sheet=new Image,L.sheet.src="resources/art/player_spritesheet.png",L.sheet.cellW=28,L.sheet.cellH=29,L.prototype.isTile=!1,L.prototype.isActor=!0,L.prototype.wakeUp=function(){camera.focus=this,input.registerNew("up",["w","W","Up"]),input.registerNew("down",["s","S","Down"]),input.registerNew("left",["a","A","Left"]),input.registerNew("right",["d","D","Right"]),input.registerNew("suicide",["r","R"]),input.registerNew("fire",["Spacebar"," "])},L.prototype.update=function(){if(!1===this.pushToggle&&"pushing"===this.state&&(this.state="running"),this.pushToggle=!1,"dieing"!=this.state&&"drowning"!=this.state&&"shooting"!=this.state){var t=0,i=0;input.right.state&&(t+=1,this.facing="right"),input.left.state&&(--t,this.facing="left"),input.up.state&&(--i,this.facing="up"),input.down.state&&(i+=1,this.facing="down");for(var s=["right","left","up","down"],e=0;e<s.length;e++)if(input[s[e]].pressed&&input[s[e]].state&&this.inputQueue.unshift(s[e]),!1===input[s[e]].state)for(var h=0;h<this.inputQueue.length;h++)this.inputQueue[h]===s[e]&&this.inputQueue.splice(h,1);if(null!=this.inputQueue[0]&&(this.facing=this.inputQueue[0]),0!=t||0!=i?("pushing"!=this.state&&(this.state="running"),physics.applyForce(this.moveForce*time.deltaTime,t,i,this.rigidBody)):this.state="idle",input.fire.pressed&&0<this.ammo){this.state="shooting",--this.ammo;var r=new D(this.x,this.y,this);"up"===this.facing?r.x+=2:"down"===this.facing?r.x-=2:"left"===this.facing?r.y+=2:"right"===this.facing&&(r.y+=2)}}"shooting"===this.state&&1===this.anim.current&&(this.state="idle"),input.suicide.pressed&&"dieing"!=this.state&&"drowning"!=this.state&&this.kill(this),"dieing"!==this.state&&"drowning"!==this.state||7!==this.anim.current||(this.isDead=!0,stage.closeCurtain()),input.dbug.pressed&&!1===u.isInDBug&&this.addRemoveAmmo(1),this.setAnimation(this.state),this.anim.update(),this.sprite.source.x=this.anim.loop[this.anim.current].x,this.sprite.source.y=this.anim.loop[this.anim.current].y},L.prototype.hit=function(t){if("static"===t.rigidBody.type&&("running"===this.state||"pushing"===this.state)){var i=!1;Math.abs(t.x-this.x)>Math.abs(t.y-this.y)?t.x>this.x?"right"===this.facing&&input.right.state&&(i=!0):"left"===this.facing&&input.left.state&&(i=!0):t.y>this.y?"down"===this.facing&&input.down.state&&(i=!0):"up"===this.facing&&input.up.state&&(i=!0),i&&(this.state="pushing",this.pushToggle=!0,null!=t.push&&t.push(this))}},L.prototype.addRemoveAmmo=function(t){if(this.ammo+=t,10<=this.ammo&&(this.ammo=9),this.ammo<0&&(this.ammo=0),null===this.ammoText){this.ammoText=new HUDText(0,0,0,{msg:"Ice",font:"Bold 12px Consolas",fill:"white",stroke:"black",lineWidth:2,shadow:{color:"black",blur:2,offsetX:1,offsetY:1}}),(this.ammoText.parent=this).ammoText.update=function(){this.x=canvas.width-38,this.y=canvas.height-5,null===this.parent?HUD.unRegister(this):this.parent.ammo<=0?(HUD.unRegister(this),this.parent.ammoText=null):this.msg=this.parent.ammo.toString()+" Ice"},HUD.register(this.ammoText)}},L.prototype.kill=function(t){!1===this.isDead&&(this.isDead=!0,stage.levelDeaths+=1,stage.skipLevelCheck(),physics.unRegisterActor(this),t.constructor===x?this.state="drowning":(this.rigidBody.velocity.x=0,this.rigidBody.velocity.y=0,this.state="dieing"))},L.prototype.setAnimation=function(t){if(this.anim.state===t&&this.anim.direction===this.facing)return!1;this.anim.state=t,this.anim.direction=this.facing,this.anim.loop=[],this.anim.time=0,this.anim.rate=0,this.anim.current=0;var i=this.sprite.sheet.cellW,s=this.sprite.sheet.cellH;switch(t){case"idle":"down"===this.facing?this.anim.loop[0]={x:0*i,y:0*s,r:0}:"up"===this.facing?this.anim.loop[0]={x:3*i,y:0*s,r:0}:"left"===this.facing?this.anim.loop[0]={x:0*i,y:+s,r:0}:"right"===this.facing&&(this.anim.loop[0]={x:0*i,y:2*s,r:0});break;case"running":"down"===this.facing?(this.anim.loop[0]={x:0*i,y:0*s,r:.2},this.anim.loop[1]={x:+i,y:0*s,r:.2},this.anim.loop[2]={x:0*i,y:0*s,r:.2},this.anim.loop[3]={x:2*i,y:0*s,r:.2}):"up"===this.facing?(this.anim.loop[0]={x:3*i,y:0*s,r:.2},this.anim.loop[1]={x:4*i,y:0*s,r:.2},this.anim.loop[2]={x:3*i,y:0*s,r:.2},this.anim.loop[3]={x:5*i,y:0*s,r:.2}):"left"===this.facing?(this.anim.loop[0]={x:+i,y:+s,r:.12},this.anim.loop[1]={x:2*i,y:+s,r:.12},this.anim.loop[2]={x:3*i,y:+s,r:.12},this.anim.loop[3]={x:4*i,y:+s,r:.12}):"right"===this.facing&&(this.anim.loop[0]={x:+i,y:2*s,r:.12},this.anim.loop[1]={x:2*i,y:2*s,r:.12},this.anim.loop[2]={x:3*i,y:2*s,r:.12},this.anim.loop[3]={x:4*i,y:2*s,r:.12});break;case"pushing":"down"===this.facing?(this.anim.loop[0]={x:0*i,y:3*s,r:.2},this.anim.loop[1]={x:+i,y:3*s,r:.2}):"up"===this.facing?(this.anim.loop[0]={x:2*i,y:3*s,r:.2},this.anim.loop[1]={x:3*i,y:3*s,r:.2}):"left"===this.facing?(this.anim.loop[0]={x:0*i,y:4*s,r:.2},this.anim.loop[1]={x:+i,y:4*s,r:.2}):"right"===this.facing&&(this.anim.loop[0]={x:2*i,y:4*s,r:.2},this.anim.loop[1]={x:3*i,y:4*s,r:.2});break;case"shooting":"down"===this.facing?(this.anim.loop[0]={x:4*i,y:3*s,r:.3},this.anim.loop[1]={x:4*i,y:3*s,r:0}):"up"===this.facing?(this.anim.loop[0]={x:4*i,y:0*s,r:.3},this.anim.loop[1]={x:4*i,y:0*s,r:0}):"left"===this.facing?(this.anim.loop[0]={x:4*i,y:4*s,r:.3},this.anim.loop[1]={x:4*i,y:4*s,r:0}):"right"===this.facing&&(this.anim.loop[0]={x:5*i,y:4*s,r:.3},this.anim.loop[1]={x:5*i,y:4*s,r:0});break;case"dieing":this.anim.loop[0]={x:0*i,y:0*s,r:.2},this.anim.loop[1]={x:0*i,y:5*s,r:.08},this.anim.loop[2]={x:+i,y:5*s,r:.08},this.anim.loop[3]={x:2*i,y:5*s,r:.08},this.anim.loop[4]={x:3*i,y:5*s,r:.08},this.anim.loop[5]={x:4*i,y:5*s,r:.08},this.anim.loop[6]={x:5*i,y:5*s,r:.8},this.anim.loop[7]={x:5*i,y:5*s,r:0};break;case"drowning":this.anim.loop[0]={x:0*i,y:0*s,r:.07},this.anim.loop[1]={x:0*i,y:6*s,r:.07},this.anim.loop[2]={x:+i,y:6*s,r:.07},this.anim.loop[3]={x:2*i,y:6*s,r:.07},this.anim.loop[4]={x:3*i,y:6*s,r:.07},this.anim.loop[5]={x:4*i,y:6*s,r:.07},this.anim.loop[6]={x:5*i,y:6*s,r:.8},this.anim.loop[7]={x:5*i,y:6*s,r:0};break;default:alert(t+" animation not found.")}},B.pixelColors=[],B.pixelColors[0]="192,128,80",stage.actorIndex.push(B),B.sheet=new Image,B.sheet.src="resources/art/crate_spritesheet.png",B.sheet.cellW=p,B.sheet.cellH=p,B.prototype.isTile=!1,B.prototype.isActor=!0,B.prototype.wakeUp=function(){},B.prototype.update=function(){if("sliding"===this.state){var t=0,i=0;"up"===this.facing?--i:"down"===this.facing?i+=1:"left"===this.facing?--t:"right"===this.facing&&(t+=1),"pushing"===this.pusher.state&&this.pusher.facing===this.facing?(this.x+=t*this.slideSpeed*time.deltaTime,this.y+=i*this.slideSpeed*time.deltaTime,this.rigidBody.velocity.x+=t*this.slideSpeed,this.rigidBody.velocity.y+=i*this.slideSpeed,this.pusher.x+=t*this.slideSpeed*time.deltaTime,this.pusher.y+=i*this.slideSpeed*time.deltaTime):(this.x+=t*this.slideSpeed*time.deltaTime*.6,this.y+=i*this.slideSpeed*time.deltaTime*.6,this.rigidBody.velocity.x+=t*this.slideSpeed*.6,this.rigidBody.velocity.y+=i*this.slideSpeed*.6),("down"===this.facing&&this.y>this.slideTile.y||"up"===this.facing&&this.y<this.slideTile.y||"right"===this.facing&&this.x>this.slideTile.x||"left"===this.facing&&this.x<this.slideTile.x)&&(this.x=this.slideTile.x,this.y=this.slideTile.y,this.slideTile.constructor===w&&(this.slideTile.state="down"),this.facing=null,this.state=null,this.pusher=null,this.slideTile=null)}else this.rigidBody.velocity={x:0,y:0}},B.prototype.push=function(t){if("pushing"===t.state&&null===this.state){var i=!1;if(Math.abs(t.x-this.x)>Math.abs(t.y-this.y)?t.x>this.x?"left"===t.facing&&(this.facing="left",i=!0):"right"===t.facing&&(this.facing="right",i=!0):t.y>this.y?"up"===t.facing&&(this.facing="up",i=!0):"down"===t.facing&&(this.facing="down",i=!0),i&&("down"===this.facing||"up"===this.facing?(t.left<this.left||t.right>this.right)&&(i=!1):(t.top<this.top||t.bottom>this.bottom)&&(i=!1)),i&&(this.slideTile={x:this.sX,y:this.sY},"down"===this.facing&&(this.slideTile.y+=1),"up"===this.facing&&--this.slideTile.y,"right"===this.facing&&(this.slideTile.x+=1),"left"===this.facing&&--this.slideTile.x,this.slideTile=stage.getTile(this.slideTile.x,this.slideTile.y),this.slideTile.isBlocked&&(i=!1)),i)for(var s=0;s<physics.actors.length;s++)if("static"===physics.actors[s].rigidBody.type&&physics.actors[s]!=this){var e=physics.actors[s].sX,h=physics.actors[s].sY;if(e===this.slideTile.sX&&h===this.slideTile.sY){i=!1;break}if(null!=physics.actors[s].slideTile&&physics.actors[s].slideTile.sX===this.slideTile.sX&&physics.actors[s].slideTile.sY===this.slideTile.sY){i=!1;break}}if(i){var r=stage.getTile(this.sX,this.sY);r.constructor===w&&(r.state="up"),r.isBlocked=!1,this.slideTile.isBlocked=!0,this.state="sliding",this.pusher=t}else this.facing=null,this.state=null,this.pusher=null,this.slideTile=null}},B.prototype.kill=function(t){stage.getTile(this.sX,this.sY).isBlocked=!1,null!=this.slideTile&&(this.slideTile.isBlocked=!1),this.state="dead",this.isDead=!0,stage.unRegisterActor(this),physics.unRegisterActor(this)},S.pixelColors=[],S.pixelColors[0]="0,128,0",stage.actorIndex.push(S),S.sheet=new Image,S.sheet.src="resources/art/archer_spritesheet.png",S.sheet.cellW=26,S.sheet.cellH=26,S.prototype.isTile=!1,S.prototype.isActor=!0,S.prototype.wakeUp=function(){this.setAnimation();for(var t=0;t<stage.actors.length;t++)if("player"===stage.actors[t].type){this.targetPlayer=stage.actors[t];break}stage.getTile(this.sX,this.sY).isBlocked=!0},S.prototype.update=function(){if(this.state="ready",null!=this.targetPlayer){var t={x:this.targetPlayer.x-this.x,y:this.targetPlayer.y-this.y};Math.abs(t.x)>Math.abs(t.y)?(this.facing=0<t.x?"right":"left",this.targetPlayer.top<(this.sY+1)*p&&this.targetPlayer.bottom>this.sY*p&&(this.state="aim",this.targetPlayer.sY===this.sY&&(this.state="fire",this.fireCheck()))):(this.facing=0<t.y?"down":"up",this.targetPlayer.left<(this.sX+1)*p&&this.targetPlayer.right>this.sX*p&&(this.state="aim",this.targetPlayer.sX===this.sX&&(this.state="fire",this.fireCheck())))}"fire"!=this.state&&(this.canFire=!0),this.setAnimation(),this.anim.update(),this.sprite.source.x=this.anim.loop[this.anim.current].x,this.sprite.source.y=this.anim.loop[this.anim.current].y},S.prototype.fireCheck=function(){if(!1===this.canFire)return!1;var t=this.sX,i=this.sY,s=stage.getTile(t,i),e=stage.getTile(this.targetPlayer.sX,this.targetPlayer.sY),h=0,r=0;for("up"===this.facing?r=-1:"down"===this.facing?r=1:"left"===this.facing?h=-1:"right"===this.facing&&(h=1);s!=e;)if(t+=h,i+=r,(s=stage.getTile(t,i)).isBlocked)return!1;for(var a=0;a<physics.actors.length;a++)if(physics.actors[a].constructor===B&&this.targetPlayer.sX===physics.actors[a].sX&&this.targetPlayer.sY===physics.actors[a].sY)return!1;t=0,i=0;if("up"===this.facing?i=-1:"down"===this.facing?i=1:"left"===this.facing?t=-1:"right"===this.facing&&(t=1),this.arrows.push(new Y(this.x,this.y,this)),this.arrows[this.arrows.length-1].wakeUp(),4<this.arrows.length&&(null!=this.arrows[0]&&this.arrows[0].kill(this),this.arrows.shift()),"up"===this.facing||"down"===this.facing)var n=Math.abs(this.y-this.targetPlayer.y)*this.shootForcePer;else n=Math.abs(this.x-this.targetPlayer.x)*this.shootForcePer;return n<this.minShootForce&&(n=this.minShootForce),n>this.maxShootForce&&(n=this.maxShootForce),physics.applyForce(n,t,i,this.arrows[this.arrows.length-1].rigidBody),!(this.canFire=!1)},S.prototype.setAnimation=function(){if(this.anim.state===this.state&&this.anim.direction===this.facing)return!1;this.anim.state=this.state,this.anim.direction=this.facing,this.anim.loop=[],this.anim.time=0,this.anim.rate=0,this.anim.current=0;var t=this.sprite.sheet.cellW,i=this.sprite.sheet.cellH;switch(this.anim.loop[0]={x:0,y:0,r:0},"down"===this.facing?this.anim.loop[0].y=0*i:"up"===this.facing?this.anim.loop[0].y=+i:"left"===this.facing?this.anim.loop[0].y=2*i:"right"===this.facing&&(this.anim.loop[0].y=3*i),this.state){case"ready":this.anim.loop[0].x=0*t;break;case"aim":this.anim.loop[0].x=+t;break;case"fire":this.anim.loop[0].x=2*t}},S.prototype.hit=function(t){},S.prototype.kill=function(t){this.isDead=!0,stage.unRegisterActor(this),physics.unRegisterActor(this)},Y.sheet=new Image,Y.sheet.src="resources/art/arrow_spritesheet.png",Y.sheet.cellW=19,Y.sheet.cellH=25,Y.prototype.isTile=!1,Y.prototype.isActor=!0,Y.prototype.lateUpdate=function(){if(null===this.hitTarget){if(null!=this.firer&&null!=this.firer.targetPlayer){var t=this.firer.targetPlayer;if("up"===this.facing||"down"===this.facing){var i=Math.abs(this.y-t.y)/Math.abs(this.rigidBody.velocity.y);(s=t.x+t.rigidBody.velocity.x*i)-this.width/2<this.firer.sX*p?s=this.firer.sX*p+this.width/2+.01:s+this.width/2>(this.firer.sX+1)*p&&(s=(this.firer.sX+1)*p-this.width/2-.01),this.rigidBody.velocity.x=(s-this.x)/i}else{var s;i=Math.abs(this.x-t.x)/Math.abs(this.rigidBody.velocity.x);(s=t.y+t.rigidBody.velocity.y*i)-this.height/2<this.firer.sY*p?s=this.firer.sY*p+this.height/2+.01:s+this.height/2>(this.firer.sY+1)*p&&(s=(this.firer.sY+1)*p-this.height/2-.01),this.rigidBody.velocity.y=(s-this.y)/i}}}else{for(var e=!1,h=0;h<stage.actors.length&&!1===e;h++)stage.actors[h]===this.hitTarget.actor&&(e=!0);if(!1===e&&this.kill(this),null!=this.hitTarget.actor)for(this.x=this.hitTarget.actor.x+this.hitTarget.offsetX,this.y=this.hitTarget.actor.y+this.hitTarget.offsetY;this.hitTarget.facing!=this.hitTarget.actor.facing&&this.hitTarget.actor.constructor!=B;){var r=["up","right","down","left"];for(h=0;h<r.length;h++)if(r[h]===this.hitTarget.facing){(h+=1)===r.length&&(h=0),this.hitTarget.facing=r[h];for(var a=0;a<r.length;a++)if(r[a]===this.facing){(a+=1)===r.length&&(a=0),this.facing=r[a],this.updateBody();break}var n=this.hitTarget.offsetY;this.hitTarget.offsetY=this.hitTarget.offsetX,this.hitTarget.offsetX=-1*n;break}}}},Y.prototype.wakeUp=function(){this.updateBody(),stage.registerActor(this),physics.registerActor(this)},Y.prototype.updateBody=function(){"up"===this.facing?(this.sprite.source.x=0*this.sprite.sheet.cellW,this.rigidBody.collider.h=10,this.sprite.offset.y=.5):"down"===this.facing?(this.sprite.source.x=+this.sprite.sheet.cellW,this.rigidBody.collider.h=10,this.sprite.offset.y=4.5):"left"===this.facing?(this.sprite.source.x=2*this.sprite.sheet.cellW,this.rigidBody.collider.w=10,this.sprite.offset.x=-3):"right"===this.facing&&(this.sprite.source.x=3*this.sprite.sheet.cellW,this.rigidBody.collider.w=10,this.sprite.offset.x=3)},Y.prototype.hit=function(t){t!=this.firer&&"trigger"!=t.rigidBody.type&&"projectile"!=t.type&&"pickup"!=t.type&&("player"===t.type&&t.kill(this),t.constructor===I&&this.kill(t),"up"===this.facing?this.y=t.bottom+this.height/2:"down"===this.facing?this.y=t.top-this.height/2:"left"===this.facing?this.x=t.right+this.width/2:"right"===this.facing&&(this.x=t.left-this.width/2),this.hitTarget=new Object,this.hitTarget.actor=t,this.hitTarget.facing=t.facing,this.hitTarget.offsetX=this.x-this.hitTarget.actor.x,this.hitTarget.offsetY=this.y-this.hitTarget.actor.y,physics.unRegisterActor(this))},Y.prototype.kill=function(t){this.isDead=!0,stage.unRegisterActor(this),physics.unRegisterActor(this)},X.pixelColors=[],X.pixelColors[0]="255,128,0",X.pixelColors[1]="255,192,0",stage.actorIndex.push(X),X.sheet=new Image,X.sheet.src="resources/art/knight_spritesheet.png",X.sheet.cellW=28,X.sheet.cellH=30,X.prototype.isTile=!1,X.prototype.isActor=!0,X.prototype.walkForce=1300,X.prototype.runForce=2600,X.prototype.wakeUp=function(){this.setAnimation(this.state),this.sprite.source.x=this.anim.loop[this.anim.current].x,this.sprite.source.y=this.anim.loop[this.anim.current].y;for(var t=0;t<stage.actors.length;t++)if("player"===stage.actors[t].type){this.targetPlayer=stage.actors[t];break}},X.prototype.update=function(){switch(this.state){case"idle":if(this.lookForPlayer(),this.idleTimer.cur+=time.deltaTime,this.idleTimer.cur>this.idleTimer.max)if(this.idleTimer.cur-=this.idleTimer.max,!0===this.findPatrolPath())this.state="patrolling";else{this.facing=["up","down","left","right"][r(0,3)]}!0===this.canSeePlayer&&this.findPathToPlayer();break;case"patrolling":this.lookForPlayer(),this.canSeePlayer?(this.wayPoints=[],this.findPathToPlayer()):(0<this.wayPoints.length&&this.sX===this.wayPoints[0].sX&&this.sY===this.wayPoints[0].sY&&this.wayPoints.shift(),0===this.wayPoints.length&&this.findPatrolPath(),0!=this.wayPoints.length&&this.goTo(this.wayPoints[0]));break;case"chasing":this.targetPlayer.isDead?(this.wayPoints=[],!0===this.findPatrolPath()?this.state="patrolling":this.state="idle"):this.sX===this.targetPlayer.sX&&this.sY===this.targetPlayer.sY?this.goTo(this.targetPlayer):(this.lookForPlayer(),this.canSeePlayer&&this.findPathToPlayer(),0<this.wayPoints.length?this.sX===this.wayPoints[0].sX&&this.sY===this.wayPoints[0].sY?1<this.wayPoints.length?(this.wayPoints.shift(),this.goTo(this.wayPoints[0])):this.findPatrolPath():this.goTo(this.wayPoints[0]):this.findPatrolPath());break;case"watching":this.targetPlayer.isDead?(this.wayPoints=[],!0===this.findPatrolPath()?this.state="patrolling":this.state="idle"):this.face(this.targetPlayer),this.targetPlayer.sX==this.playerLastSeen.sX&&this.targetPlayer.sY==this.playerLastSeen.sY||(this.lookForPlayer(),this.canSeePlayer?(this.findPathToPlayer(),0<this.wayPoints.length&&(this.sX==this.wayPoints[this.wayPoints.length-1].sX&&this.sY==this.wayPoints[this.wayPoints.length-1].sY||(this.state="chasing"))):this.findPatrolPath());break;case"attacking":4===this.anim.current&&(this.state="idle");break;case"dieing":case"drowning":7===this.anim.current&&(this.isDead=!0,stage.unRegisterActor(this),physics.unRegisterActor(this));break;default:console.log("Knight state not found - "+this.state+".")}this.setAnimation(this.state),this.anim.update(),this.sprite.source.x=this.anim.loop[this.anim.current].x,this.sprite.source.y=this.anim.loop[this.anim.current].y},X.prototype.goTo=function(t){this.face(t),"patrolling"===this.state?physics.applyForce(this.moveForce*time.deltaTime,t.x-this.x,t.y-this.y,this.rigidBody):physics.applyForce(2*this.moveForce*time.deltaTime,t.x-this.x,t.y-this.y,this.rigidBody)},X.prototype.face=function(t){Math.abs(this.x-t.x)>Math.abs(this.y-t.y)?0<this.x-t.x?this.facing="left":this.facing="right":0<this.y-t.y?this.facing="up":this.facing="down"},X.prototype.lookForPlayer=function(){if(this.targetPlayer.isDead)this.canSeePlayer=!1;else if(this.lastLookFrom!==stage.getTile(this.sX,this.sY)||this.lastLookTo!==stage.getTile(this.targetPlayer.sX,this.targetPlayer.sY)){this.lastLookFrom=stage.getTile(this.sX,this.sY),this.lastLookTo=stage.getTile(this.targetPlayer.sX,this.targetPlayer.sY);var t=this.targetPlayer.x-this.x,i=this.targetPlayer.y-this.y;if("chasing"===this.state||"watching"===this.state)var s=!0;else{s=!1;"up"===this.facing?i<0&&Math.abs(i)>Math.abs(t)/2&&(s=!0):"down"===this.facing?0<i&&Math.abs(i)>Math.abs(t)/2&&(s=!0):"left"===this.facing?t<0&&Math.abs(t)>Math.abs(i)/2&&(s=!0):"right"===this.facing&&0<t&&Math.abs(t)>Math.abs(i)/2&&(s=!0)}if(s){if(10<Math.sqrt(Math.pow(t,2)+Math.pow(i,2))/p)return void(this.canSeePlayer=!1);for(var e=physics.rayTrace(this.sX,this.sY,this.targetPlayer.sX,this.targetPlayer.sY),h=0;h<e.length;h++)if(!0===e[h].isBlocked)return void(this.canSeePlayer=!1);this.playerLastSeen=stage.getTile(this.targetPlayer.sX,this.targetPlayer.sY),this.canSeePlayer=!0}else this.canSeePlayer=!1}},X.prototype.findPathToPlayer=function(){if(0<this.wayPoints.length&&this.wayPoints[this.wayPoints.length-1].sX===this.playerLastSeen.sX&&this.wayPoints[this.wayPoints.length-1].sY===this.playerLastSeen.sY)return!0;if(this.sX===this.targetPlayer.sX&&this.sY===this.targetPlayer.sY)return this.state="chasing",this.wayPoints=[],this.wayPoints.push(stage.getTile(this.sX,this.sY)),!0;this.wayPoints=[];var t=null,i=[],s=[];for(i.push(new H(stage.getTile(this.sX,this.sY),null,0,Math.abs(this.sX-this.targetPlayer.sX)+Math.abs(this.sY-this.targetPlayer.sY)));0<i.length;){for(var e=0,h=0;h<i.length;h++)i[h].distance+i[h].heuristic<i[e].distance+i[e].heuristic&&(e=h);if(i[e].distance<50){var r=[];r.push(new H(stage.getTile(i[e].tile.sX,i[e].tile.sY-1),i[e],i[e].distance+1,Math.abs(i[e].tile.sX-this.targetPlayer.sX)+Math.abs(i[e].tile.sY-1-this.targetPlayer.sY))),r.push(new H(stage.getTile(i[e].tile.sX,i[e].tile.sY+1),i[e],i[e].distance+1,Math.abs(i[e].tile.sX-this.targetPlayer.sX)+Math.abs(i[e].tile.sY+1-this.targetPlayer.sY))),r.push(new H(stage.getTile(i[e].tile.sX-1,i[e].tile.sY),i[e],i[e].distance+1,Math.abs(i[e].tile.sX-1-this.targetPlayer.sX)+Math.abs(i[e].tile.sY-this.targetPlayer.sY))),r.push(new H(stage.getTile(i[e].tile.sX+1,i[e].tile.sY),i[e],i[e].distance+1,Math.abs(i[e].tile.sX+1-this.targetPlayer.sX)+Math.abs(i[e].tile.sY-this.targetPlayer.sY))),1!=r[0].tile.isBlocked&&"water"!=r[0].tile.type&&(1!=r[2].tile.isBlocked&&"water"!=r[2].tile.type&&r.push(new H(stage.getTile(i[e].tile.sX-1,i[e].tile.sY-1),i[e],i[e].distance+Math.SQRT2,Math.abs(i[e].tile.sX-1-this.targetPlayer.sX)+Math.abs(i[e].tile.sY-1-this.targetPlayer.sY))),1!=r[3].tile.isBlocked&&"water"!=r[3].tile.type&&r.push(new H(stage.getTile(i[e].tile.sX+1,i[e].tile.sY-1),i[e],i[e].distance+Math.SQRT2,Math.abs(i[e].tile.sX+1-this.targetPlayer.sX)+Math.abs(i[e].tile.sY-1-this.targetPlayer.sY)))),1!=r[1].tile.isBlocked&&"water"!=r[1].tile.type&&(1!=r[2].tile.isBlocked&&"water"!=r[2].tile.type&&r.push(new H(stage.getTile(i[e].tile.sX-1,i[e].tile.sY+1),i[e],i[e].distance+Math.SQRT2,Math.abs(i[e].tile.sX-1-this.targetPlayer.sX)+Math.abs(i[e].tile.sY+1-this.targetPlayer.sY))),1!=r[3].tile.isBlocked&&"water"!=r[3].tile.type&&r.push(new H(stage.getTile(i[e].tile.sX+1,i[e].tile.sY+1),i[e],i[e].distance+Math.SQRT2,Math.abs(i[e].tile.sX+1-this.targetPlayer.sX)+Math.abs(i[e].tile.sY+1-this.targetPlayer.sY))));for(h=0;h<r.length;h++)if(!0!==r[h].tile.isBlocked&&"water"!==r[h].tile.type){for(var a=0;a<i.length&&r[h].tile!==i[a].tile;a++);if(a==i.length){for(a=0;a<s.length&&r[h].tile!==s[a].tile;a++);a==s.length&&i.push(r[h])}}}if(s.push(i[e]),i.splice(e,1),s[s.length-1].tile.sX===this.playerLastSeen.sX&&s[s.length-1].tile.sY===this.playerLastSeen.sY){t=s[s.length-1];break}}if(0===s.length)return this.wayPoints=[],this.canSeePlayer?(this.face(this.targetPlayer),this.state="watching"):this.state="idle",!1;if(null===t){var n=0;for(h=0;h<s.length;h++)s[h].heuristic<s[n].heuristic&&(n=h);t=s[n]}if(this.wayPoints=[],this.state="chasing",this.sX===t.tile.sX&&this.sY===t.tile.sY)return this.face(this.targetPlayer),!(this.state="watching");for(;null!=t;)this.wayPoints.unshift(t.tile),t=t.prev;return!0},X.prototype.findPatrolPath=function(){for(var t=!1,i=this.sY-1;i<=this.sY+1&&!1===t;i++)for(var s=this.sX-1;s<=this.sX+1&&!1===t;s++)s==this.sX&&i==this.sY||!0!==stage.getTile(s,i).isBlocked&&"water"!==stage.getTile(s,i).type||(t=!0);if(!0===t){var e=[];"left"===this.hand?(e.up=[{x:-1,y:0},{x:-1,y:1}],e.down=[{x:1,y:0},{x:1,y:-1}],e.left=[{x:0,y:1},{x:1,y:1}],e.right=[{x:0,y:-1},{x:-1,y:-1}]):"right"===this.hand&&(e.up=[{x:1,y:0},{x:1,y:1}],e.down=[{x:-1,y:0},{x:-1,y:-1}],e.left=[{x:0,y:-1},{x:1,y:-1}],e.right=[{x:0,y:1},{x:-1,y:1}]);var h=[];"left"===this.hand?(h.up="right",h.down="left",h.left="up",h.right="down"):"right"===this.hand&&(h.up="left",h.down="right",h.left="down",h.right="up");for(var r=!1,a=0;a<4&&!1===r;a++){r=!1;for(var n=0;n<e[this.facing].length;n++){if(!0===(o=stage.getTile(this.sX+e[this.facing][n].x,this.sY+e[this.facing][n].y)).isBlocked||"water"===o.type){r=!0;break}}!1===r&&(this.facing=h[this.facing])}if(4===a)return this.findClosestWall(),!0;this.wayPoints=[];for(a=0;a<4&&0===this.wayPoints.length;a++){var o;!0===(o=stage.getTile(this.sX+e[this.facing][0].x,this.sY+e[this.facing][0].y)).isBlocked||"water"===o.type?this.facing=h[this.facing]:this.wayPoints.unshift(o)}if(0===this.wayPoints.length)return!(this.state="idle")}else this.findClosestWall();return this.state="patrolling",!0},X.prototype.findClosestWall=function(){var t=null,i=[],s=[],e=[];for(i.push(new H(stage.getTile(this.sX,this.sY),null,0));0<i.length;){for(var h=0,r=0;r<i.length;r++)i[r].distance<i[h].distance&&(h=r);e.push(new H(stage.getTile(i[h].tile.sX,i[h].tile.sY-1),i[h],i[h].distance+1)),e.push(new H(stage.getTile(i[h].tile.sX,i[h].tile.sY+1),i[h],i[h].distance+1)),e.push(new H(stage.getTile(i[h].tile.sX-1,i[h].tile.sY),i[h],i[h].distance+1)),e.push(new H(stage.getTile(i[h].tile.sX+1,i[h].tile.sY),i[h],i[h].distance+1)),1!=e[0].tile.isBlocked&&"water"!=e[0].tile.type&&(1!=e[2].tile.isBlocked&&"water"!=e[2].tile.type&&e.push(new H(stage.getTile(i[h].tile.sX-1,i[h].tile.sY-1),i[h],i[h].distance+Math.SQRT2)),1!=e[3].tile.isBlocked&&"water"!=e[3].tile.type&&e.push(new H(stage.getTile(i[h].tile.sX+1,i[h].tile.sY-1),i[h],i[h].distance+Math.SQRT2))),1!=e[1].tile.isBlocked&&"water"!=e[1].tile.type&&(1!=e[2].tile.isBlocked&&"water"!=e[2].tile.type&&e.push(new H(stage.getTile(i[h].tile.sX-1,i[h].tile.sY+1),i[h],i[h].distance+Math.SQRT2)),1!=e[3].tile.isBlocked&&"water"!=e[3].tile.type&&e.push(new H(stage.getTile(i[h].tile.sX+1,i[h].tile.sY+1),i[h],i[h].distance+Math.SQRT2)));for(r=0;r<e.length;r++){for(var a=0;a<i.length&&e[r].tile!==i[a].tile;a++);if(a==i.length){for(a=0;a<s.length&&e[r].tile!==s[a].tile;a++);a==s.length&&i.push(e[r])}}if(s.push(i[h]),i.splice(h,1),!0===s[s.length-1].tile.isBlocked||"water"===s[s.length-1].tile.type){t=s[s.length-1];break}}for(t=t.prev,this.wayPoints=[],this.state="patrolling";null!=t;)this.wayPoints.unshift(t.tile),t=t.prev;return!0},X.prototype.setAnimation=function(t){if(this.anim.state===t&&this.anim.direction===this.facing)return!1;this.anim.state=t,this.anim.direction=this.facing,this.anim.loop=[],this.anim.time=0,this.anim.rate=0,this.anim.current=0;var i=this.sprite.sheet.cellW,s=this.sprite.sheet.cellH;switch(t){case"idle":"down"===this.facing&&(this.anim.loop[0]={x:0*i,y:0*s,r:0}),"up"===this.facing&&(this.anim.loop[0]={x:0*i,y:+s,r:0}),"left"===this.facing&&(this.anim.loop[0]={x:0*i,y:2*s,r:0}),"right"===this.facing&&(this.anim.loop[0]={x:0*i,y:3*s,r:0});break;case"patrolling":"down"===this.facing?(this.anim.loop[0]={x:0*i,y:0*s,r:.2},this.anim.loop[1]={x:+i,y:0*s,r:.2},this.anim.loop[2]={x:0*i,y:0*s,r:.2},this.anim.loop[3]={x:2*i,y:0*s,r:.2}):"up"===this.facing?(this.anim.loop[0]={x:0*i,y:+s,r:.2},this.anim.loop[1]={x:+i,y:+s,r:.2},this.anim.loop[2]={x:0*i,y:+s,r:.2},this.anim.loop[3]={x:2*i,y:+s,r:.2}):"left"===this.facing?(this.anim.loop[0]={x:+i,y:2*s,r:.12},this.anim.loop[1]={x:2*i,y:2*s,r:.12},this.anim.loop[2]={x:3*i,y:2*s,r:.12},this.anim.loop[3]={x:4*i,y:2*s,r:.12}):"right"===this.facing&&(this.anim.loop[0]={x:+i,y:3*s,r:.12},this.anim.loop[1]={x:2*i,y:3*s,r:.12},this.anim.loop[2]={x:3*i,y:3*s,r:.12},this.anim.loop[3]={x:4*i,y:3*s,r:.12});break;case"chasing":"down"===this.facing?(this.anim.loop[0]={x:0*i,y:4*s,r:.2},this.anim.loop[1]={x:+i,y:4*s,r:.2},this.anim.loop[2]={x:0*i,y:4*s,r:.2},this.anim.loop[3]={x:2*i,y:4*s,r:.2}):"up"===this.facing?(this.anim.loop[0]={x:0*i,y:+s,r:.2},this.anim.loop[1]={x:+i,y:+s,r:.2},this.anim.loop[2]={x:0*i,y:+s,r:.2},this.anim.loop[3]={x:2*i,y:+s,r:.2}):"left"===this.facing?(this.anim.loop[0]={x:+i,y:5*s,r:.12},this.anim.loop[1]={x:2*i,y:5*s,r:.12},this.anim.loop[2]={x:3*i,y:5*s,r:.12},this.anim.loop[3]={x:4*i,y:5*s,r:.12}):"right"===this.facing&&(this.anim.loop[0]={x:+i,y:6*s,r:.12},this.anim.loop[1]={x:2*i,y:6*s,r:.12},this.anim.loop[2]={x:3*i,y:6*s,r:.12},this.anim.loop[3]={x:4*i,y:6*s,r:.12});break;case"attacking":var e=.08;"down"===this.facing?(this.anim.loop[0]={x:0*i,y:7*s,r:e},this.anim.loop[1]={x:+i,y:7*s,r:e},this.anim.loop[2]={x:2*i,y:7*s,r:e},this.anim.loop[3]={x:0*i,y:0*s,r:1},this.anim.loop[4]={x:0*i,y:0*s,r:0}):"up"===this.facing?(this.anim.loop[0]={x:0*i,y:8*s,r:e},this.anim.loop[1]={x:+i,y:8*s,r:e},this.anim.loop[2]={x:2*i,y:8*s,r:e},this.anim.loop[3]={x:0*i,y:+s,r:1},this.anim.loop[4]={x:0*i,y:+s,r:0}):"left"===this.facing?(this.anim.loop[0]={x:0*i,y:9*s,r:e},this.anim.loop[1]={x:+i,y:9*s,r:e},this.anim.loop[2]={x:2*i,y:9*s,r:e},this.anim.loop[3]={x:0*i,y:2*s,r:1},this.anim.loop[4]={x:0*i,y:2*s,r:0}):"right"===this.facing&&(this.anim.loop[0]={x:0*i,y:10*s,r:e},this.anim.loop[1]={x:+i,y:10*s,r:e},this.anim.loop[2]={x:2*i,y:10*s,r:e},this.anim.loop[3]={x:0*i,y:3*s,r:1},this.anim.loop[4]={x:0*i,y:3*s,r:0});break;case"dieing":this.anim.loop[0]={x:0*i,y:4*s,r:.2},this.anim.loop[1]={x:0*i,y:11*s,r:.08},this.anim.loop[2]={x:+i,y:11*s,r:.08},this.anim.loop[3]={x:2*i,y:11*s,r:.08},this.anim.loop[4]={x:3*i,y:11*s,r:.08},this.anim.loop[5]={x:4*i,y:11*s,r:.08},this.anim.loop[6]={x:4*i,y:10*s,r:.8},this.anim.loop[7]={x:4*i,y:10*s,r:0};break;case"drowning":e=.07;this.anim.loop[0]={x:0*i,y:4*s,r:e},this.anim.loop[1]={x:0*i,y:12*s,r:e},this.anim.loop[2]={x:+i,y:12*s,r:e},this.anim.loop[3]={x:2*i,y:12*s,r:e},this.anim.loop[4]={x:3*i,y:12*s,r:e},this.anim.loop[5]={x:4*i,y:12*s,r:e},this.anim.loop[6]={x:4*i,y:10*s,r:.8},this.anim.loop[7]={x:4*i,y:10*s,r:0};break;case"watching":"down"===this.facing&&(this.anim.loop[0]={x:0*i,y:4*s,r:0}),"up"===this.facing&&(this.anim.loop[0]={x:0*i,y:+s,r:0}),"left"===this.facing&&(this.anim.loop[0]={x:0*i,y:5*s,r:0}),"right"===this.facing&&(this.anim.loop[0]={x:0*i,y:6*s,r:0});break;default:alert(t+" animation not found.")}},X.prototype.hit=function(t){if("player"===t.type?"dieing"!=t.state&&"drowning"!=t.state&&(t.kill(this),this.face(t),this.state="attacking"):t.constructor===D&&(this.state="idle",this.canSeePlayer=!1,this.idleTimer.cur=this.idleTimer.max-1,this.wayPoints=[]),"trigger"!=t.rigidBody.type&&"weightless"!=t.rigidBody.type)if("crate"===t.type)if("patrolling"===this.state){var i=null,s=physics.getOverlap(this,t);if(Math.abs(s.x)<Math.abs(s.y)){if(!1===(i=stage.getTile(this.sX,this.sY-1)).isBlocked&&"water"!=i.type)return void(this.wayPoints=[i]);if(!1===(i=stage.getTile(this.sX,this.sY+1)).isBlocked&&"water"!=i.type)return void(this.wayPoints=[i])}else{if(!1===(i=stage.getTile(this.sX-1,this.sY)).isBlocked&&"water"!=i.type)return void(this.wayPoints=[i]);if(!1===(i=stage.getTile(this.sX+1,this.sY)).isBlocked&&"water"!=i.type)return void(this.wayPoints=[i])}}else"chasing"===this.state&&(this.wayPoints=[],this.findPathToPlayer());else"patrolling"===this.state&&t.constructor===X&&.2<(time.now-this.lastHandChange)/1e3&&(this.lastHandChange=time.now,"left"===this.hand?this.hand="right":this.hand="left","up"===this.facing?this.facing="down":"down"===this.facing?this.facing="up":"left"===this.facing?this.facing="right":"right"===this.facing&&(this.facing="left"),physics.applyForce(200,t.x-this.x,t.y-this.y,t.rigidBody),this.wayPoints=[])},X.prototype.kill=function(t){this.isDead=!0,physics.unRegisterActor(this),t.constructor===x?this.state="drowning":(this.rigidBody.velocity.x=0,this.rigidBody.velocity.y=0,this.state="dieing")},I.pixelColors=[],I.pixelColors[0]="192,192,192",I.pixelColors[1]="160,160,160",stage.actorIndex.push(I),I.sheet=new Image,I.sheet.src="resources/art/buzz_spritesheet.png",I.sheet.cellW=23,I.sheet.cellH=24,I.prototype.isTile=!1,I.prototype.isActor=!0,I.prototype.wakeUp=function(){if("clockwise"===this.state)var t=0;else t=1;this.anim.loop[0]={x:0*this.sprite.sheet.cellW,y:this.sprite.sheet.cellH*t,r:.04},this.anim.loop[1]={x:+this.sprite.sheet.cellW,y:this.sprite.sheet.cellH*t,r:.04},this.anim.loop[2]={x:2*this.sprite.sheet.cellW,y:this.sprite.sheet.cellH*t,r:.04};var i=[];i[0]={dir:"up",x:0,y:-1,dis:0},i[1]={dir:"down",x:0,y:1,dis:0},i[2]={dir:"left",x:-1,y:0,dis:0},i[3]={dir:"right",x:1,y:0,dis:0};for(var s=0;s<i.length;s++)for(var e={x:this.sX,y:this.sY};;){e.x+=i[s].x,e.y+=i[s].y,i[s].dis++;var h=stage.getTile(e.x,e.y);if("wall"===h.type||h.isBlocked)break}var r=i[0];for(s=0;s<i.length;s++)i[s].dis<r.dis&&(r=i[s]);this.facing=r.dir},I.prototype.update=function(){var t=0,i=0;"right"===this.facing?t=1:"left"===this.facing?t=-1:"up"===this.facing?i=-1:"down"===this.facing&&(i=1),physics.applyForce(this.moveForce*time.deltaTime,t,i,this.rigidBody),this.anim.update(),this.sprite.source.x=this.anim.loop[this.anim.current].x,this.sprite.source.y=this.anim.loop[this.anim.current].y},I.prototype.hit=function(t){if(t.constructor!==Y){if("trigger"!=t.rigidBody.type&&"weightless"!=t.rigidBody.type)if("player"===t.type)t.kill(this);else{var i=physics.getOverlap(this,t);Math.abs(i.x)<Math.abs(i.y)?this.x<t.x?this.facing="up":this.facing="down":this.y<t.y?this.facing="right":this.facing="left","counter-clockwise"===this.state&&("up"===this.facing?this.facing="down":"down"===this.facing?this.facing="up":"left"===this.facing?this.facing="right":"right"===this.facing&&(this.facing="left"))}}else t.kill(this)},I.prototype.kill=function(t){if(t===physics&&stage.getTile(this.sX,this.sY).isBlocked)for(var i=0;i<stage.actors.length;i++)if("crate"===stage.actors[i].type&&stage.actors[i].sX===this.sX&&stage.actors[i].sY===this.sY)return void stage.actors[i].kill(this);this.isDead=!0,stage.unRegisterActor(this),physics.unRegisterActor(this)},U.pixelColors=[],U.pixelColors[0]="0,255,255",stage.actorIndex.push(U),U.sheet=new Image,U.sheet.src="resources/art/icewand_spritesheet.png",U.sheet.cellW=10,U.sheet.cellH=24,U.prototype.isTile=!1,U.prototype.isActor=!0,U.prototype.wakeUp=function(){this.anim.rate=.15,this.anim.loop[0]={x:0*U.sheet.cellW,y:0*U.sheet.cellH},this.anim.loop[1]={x:+U.sheet.cellW,y:0*U.sheet.cellH},this.anim.loop[2]={x:2*U.sheet.cellW,y:0*U.sheet.cellH},this.anim.loop[3]={x:3*U.sheet.cellW,y:0*U.sheet.cellH},this.anim.loop[4]={x:4*U.sheet.cellW,y:0*U.sheet.cellH}},U.prototype.update=function(){this.anim.update(),this.sprite.source.x=this.anim.loop[this.anim.current].x,this.sprite.source.y=this.anim.loop[this.anim.current].y},U.prototype.hit=function(t){"player"===t.type&&(t.addRemoveAmmo(1),this.kill(this))},U.prototype.kill=function(t){this.isDead=!0,stage.unRegisterActor(this),physics.unRegisterActor(this)},D.sheet=new Image,D.sheet.src="resources/art/iceball_spritesheet.png",D.sheet.cellW=18,D.sheet.cellH=22,D.prototype.isTile=!1,D.prototype.isActor=!0,D.prototype.wakeUp=function(){var t=0;"up"===this.facing?(t=0,this.rigidBody.collider.w=6,physics.applyForce(this.speed,0,-1,this.rigidBody)):"down"===this.facing?(t=1,this.rigidBody.collider.w=6,physics.applyForce(this.speed,0,1,this.rigidBody)):"left"===this.facing?(t=2,this.rigidBody.collider.h=8,physics.applyForce(this.speed,-1,0,this.rigidBody)):"right"===this.facing&&(t=3,this.rigidBody.collider.h=8,physics.applyForce(this.speed,1,0,this.rigidBody)),this.anim.loop[0]={x:D.sheet.cellW*t,y:0*D.sheet.cellH},this.anim.loop[1]={x:D.sheet.cellW*t,y:+D.sheet.cellH},this.anim.loop[2]={x:D.sheet.cellW*t,y:2*D.sheet.cellH},stage.registerActor(this),physics.registerActor(this)},D.prototype.update=function(){this.anim.update(),this.sprite.source.x=this.anim.loop[this.anim.current].x,this.sprite.source.y=this.anim.loop[this.anim.current].y},D.prototype.hit=function(t){t!=this.firer&&("enemy"===t.type&&t.constructor!=S&&(new M(t),this.kill(t)),"trigger"!=t.rigidBody.type&&"pickup"!=t.type&&"projectile"!=t.type&&this.kill(t))},D.prototype.kill=function(t){this.isDead=!0,stage.unRegisterActor(this),physics.unRegisterActor(this)},M.sheet=new Image,M.sheet.src="resources/art/iceblock_spritesheet.png",M.sheet.cellW=22,M.sheet.cellH=26,M.prototype.isTile=!1,M.prototype.isActor=!0,M.prototype.wakeUp=function(){stage.registerActor(this),stage.unRegisterActor(this.frozenActor),physics.unRegisterActor(this.frozenActor),this.rigidBody.velocity.x=this.frozenActor.rigidBody.velocity.x,this.rigidBody.velocity.y=this.frozenActor.rigidBody.velocity.y,this.frozenActor.constructor!=I?(this.frozenActor.constructor===X?this.sprite.source.x=0*M.sheet.cellW:this.frozenActor.constructor===S&&(this.sprite.source.x=+M.sheet.cellW),this.sprite.offset.y=-4,"down"===this.frozenActor.facing?this.sprite.source.y=0*M.sheet.cellH:"up"===this.frozenActor.facing?this.sprite.source.y=+M.sheet.cellH:"left"===this.frozenActor.facing?this.sprite.source.y=2*M.sheet.cellH:"right"===this.frozenActor.facing&&(this.sprite.source.y=3*M.sheet.cellH)):(this.sprite.source.x=2*M.sheet.cellW,"clockwise"===this.frozenActor.state&&(this.sprite.source.y=+M.sheet.cellH))},M.prototype.update=function(){this.needPhysReg&&(this.needPhysReg=!1,physics.registerActor(this)),this.width!=this.colliderTrueSize.w&&(this.rigidBody.collider.w+=6*time.deltaTime,this.width>this.colliderTrueSize.w&&(this.rigidBody.collider.w=this.colliderTrueSize.w)),this.height!=this.colliderTrueSize.h&&(this.rigidBody.collider.h+=6*time.deltaTime,this.height>this.colliderTrueSize.h&&(this.rigidBody.collider.h=this.colliderTrueSize.h)),this.meltTimer-=time.deltaTime,this.meltTimer<=4&&this.sprite.source.x<3*M.sheet.cellW||this.meltTimer<=3&&this.sprite.source.x<6*M.sheet.cellW||this.meltTimer<=2&&this.sprite.source.x<9*M.sheet.cellW||this.meltTimer<=1&&this.sprite.source.x<12*M.sheet.cellW?this.sprite.source.x+=3*M.sheet.cellW:this.meltTimer<=0&&this.melt()},M.prototype.hit=function(t){},M.prototype.melt=function(){stage.registerActor(this.frozenActor),physics.registerActor(this.frozenActor),this.frozenActor.x=this.x,this.frozenActor.y=this.y,this.frozenActor.rigidBody.velocity.x=this.rigidBody.velocity.x,this.frozenActor.rigidBody.velocity.y=this.rigidBody.velocity.y,this.kill(this)},M.prototype.kill=function(t){this.isDead=!0,stage.unRegisterActor(this),physics.unRegisterActor(this)},stage.loadCurrentLevel();