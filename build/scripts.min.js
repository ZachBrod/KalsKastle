var STARTLEVEL=1,LIMITCANVASSIZE=!0,CAMERASCALE=1,TSIZE=24,HTSIZE=12,hideWall=null;function HitData(t){this.target=t,this.startPos={x:t.x,y:t.y},this.list=[],this.tLim=null,this.bLim=null,this.lLim=null,this.rLim=null}window.onblur=function(){!1===gameLoop.isPaused&&gameLoop.pause(),hideWall=new HUDRect(0,0,100,0,0,"white"),HUD.register(hideWall),hideWall.update=function(){this.x=0,this.y=0,this.w=canvas.width,this.h=canvas.height}},window.onfocus=function(){HUD.unRegister(hideWall),hideWall=null},window.onload=function(){canvas.width=288,canvas.height=216,window.resizeTo(canvas.width+30,canvas.height+78),ctx.mozImageSmoothingEnabled=!1,ctx.webkitImageSmoothingEnabled=!1,ctx.msImageSmoothingEnabled=!1,ctx.imageSmoothingEnabled=!1},window.onresize=function(){if(canvas.width=window.innerWidth-16,canvas.height=window.innerHeight-16,LIMITCANVASSIZE){432<canvas.width&&(canvas.width=432),336<canvas.height&&(canvas.height=336)}canvas.tWidth=Math.ceil(canvas.width/TSIZE),canvas.tHeight=Math.ceil(canvas.height/TSIZE),ctx.mozImageSmoothingEnabled=!1,ctx.webkitImageSmoothingEnabled=!1,ctx.msImageSmoothingEnabled=!1,ctx.imageSmoothingEnabled=!1},canvas=document.getElementById("game"),canvas.width=288,canvas.height=216,canvas.tWidth=Math.ceil(canvas.width/TSIZE),canvas.tHeight=Math.ceil(canvas.height/TSIZE),ctx=canvas.getContext("2d"),ctx.msImageSmoothingEnabled=!1,ctx.imageSmoothingEnabled=!1,time=new Object,time.now=(new Date).getTime(),time.deltaTime=0,time.lastUpdate=time.now,time.update=function(){this.now=(new Date).getTime(),this.deltaTime=(this.now-this.lastUpdate)/1e3,this.lastUpdate=this.now},input=new Object,input.update=function(){for(var t in input.anyKey=!1,input)if(input.hasOwnProperty(t)){if(null==input[t].keys)continue;null!=input[t].buffer?("pressed"==input[t].buffer&&1!=input[t].state?(input[t].state=!0,input[t].pressed=!0,input[t].released=!1,input.anyKey=!0):"released"==input[t].buffer&&0!=input[t].state&&(input[t].state=!1,input[t].pressed=!1,input[t].released=!0,input[t].buffer=null),input[t].buffer=null):(input[t].pressed=!1,input[t].released=!1)}},input.registerNew=function(t,i){input[t]=new Object,input[t].keys=i,input[t].state=!1,input[t].pressed=!1,input[t].released=!1,input[t].buffer=null},input.clearAll=function(){for(var t in input)if(input.hasOwnProperty(t)){if(null==input[t].keys)continue;input[t].state=!1,input[t].pressed=!1,input[t].released=!1,input[t].buffer=null}},window.onkeydown=function(t){for(var i in input)if(input.hasOwnProperty(i)){if(null==input[i].keys)continue;for(var e=0;e<input[i].keys.length;e++)t.key==input[i].keys[e]&&(input[i].buffer="pressed")}gameLoop.isPaused&&gameLoop.addPassKey(t.key)},window.onkeyup=function(t){for(var i in input)if(input.hasOwnProperty(i)){if(null==input[i].keys)continue;for(var e=0;e<input[i].keys.length;e++)t.key==input[i].keys[e]&&(input[i].buffer="released")}},stage=new Object,stage.width=0,stage.height=0,stage.currentLevel=STARTLEVEL,stage.currentLevelImg=document.createElement("img"),stage.tileIndex=[],stage.actorIndex=[],stage.tiles=[],stage.actors=[],stage.unRegisterList=[],stage.outOfBoundsWalls=[],stage.curtain=null,stage.levelTime=0,stage.levelDeaths=0,stage.showSkipScreen=!1,stage.skipScreen=null,stage.loadCurrentLevel=function(){if(clearInterval(gameLoop.Interval),gameLoop.Interval=null,61===stage.currentLevel)return stage.currentLevelImg.src="resources/art/game_over.png",stage.currentLevelImg.complete&&(ctx.fillStyle="black",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.drawImage(stage.currentLevelImg,0,0,162,82,canvas.width/2-81,canvas.height/2-41,162,82)),setTimeout(stage.loadCurrentLevel,50),!1;if(stage.currentLevelImg.src="resources/levels/lvl_"+stage.currentLevel+".png",stage.unloadLevel(),ctx.fillStyle="black",ctx.fillRect(0,0,canvas.width,canvas.height),stage.currentLevelImg.complete){ctx.drawImage(stage.currentLevelImg,0,0),stage.width=stage.currentLevelImg.width,stage.height=stage.currentLevelImg.height;for(var t=0;t<stage.width;t++){stage.tiles[t]=[];for(var i=0;i<stage.height;i++){var e=ctx.getImageData(t,i,1,1),s=16,r=Math.round(e.data[0]/s)*s;256===r&&(r=255);var h=Math.round(e.data[1]/s)*s;256===h&&(h=255);var a=Math.round(e.data[2]/s)*s;if(256===a&&(a=255),e=r.toString()+","+h.toString()+","+a.toString(),0==stage.loadTile(t,i,e))return!1}}stage.currentLevelImg.src="";for(t=0;t<stage.width;t++)for(i=0;i<stage.height;i++)stage.tiles[t][i].wakeUp();for(var o=0;o<stage.actors.length;o++)stage.actors[o].wakeUp();return stage.openCurtain(),stage.prepHeadsUpDisplay(),stage.notifications(),gameLoop.Interval=setInterval(gameLoop.update,1e3/60),!0}return setTimeout(stage.loadCurrentLevel,50),!1},stage.loadTile=function(t,i,e){for(var s=0;s<this.tileIndex.length;s++)for(var r=0;r<this.tileIndex[s].pixelColors.length;r++)if(this.tileIndex[s].pixelColors[r]==e)return this.tiles[t][i]=new this.tileIndex[s](t*TSIZE+HTSIZE,i*TSIZE+HTSIZE,e),!0;this.tiles[t][i]=new Floor(t*TSIZE+HTSIZE,i*TSIZE+HTSIZE,e);for(s=0;s<this.actorIndex.length;s++)for(r=0;r<this.actorIndex[s].pixelColors.length;r++)if(this.actorIndex[s].pixelColors[r]==e){var h=this.registerActor(new this.actorIndex[s](t*TSIZE+HTSIZE,i*TSIZE+HTSIZE,e));return null!=h.rigidBody&&physics.registerActor(h),!0}return alert("Pixel at "+t+","+i+" of color "+e+" is not a valid color."),!1},stage.prepHeadsUpDisplay=function(){if(1===stage.currentLevel){var t=new HUDImg(0,0,3,240,111,0,0,240,111,"resources/art/instructions_spritesheet.png");t.update=function(){gameLoop.isPaused=!0,this.x=parseInt(canvas.width/2-this.w/2),this.y=parseInt(canvas.height/2-this.h/2),input.pause.pressed&&HUD.unRegister(this)},t.draw=function(){ctx.fillStyle="black",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.drawImage(this.img,this.sX,this.sY,this.sW,this.sH,this.x,this.y,this.w,this.h)},HUD.register(t)}var i={msg:"Level: "+stage.currentLevel.toString(),font:"Bold 12px Arial",fill:"white",shadow:{color:"black",blur:2,offsetX:1,offsetY:1}},e=new HUDText(0,0,0,i);e.currentLevel=stage.currentLevel,e.update=function(){this.x=5,this.y=canvas.height-20,this.currentLevel!=stage.currentLevel&&HUD.unRegister(this)},i.msg="Password: "+gameLoop.passIndex[stage.currentLevel];var s=new HUDText(0,0,0,i);s.currentLevel=stage.currentLevel,s.update=function(){this.x=4,this.y=canvas.height-5,this.currentLevel!=stage.currentLevel&&HUD.unRegister(this)},HUD.register(s)},stage.registerActor=function(t){for(var i=0;i<this.actors.length;i++){if(this.actors[i]==t)return this.actors[i];if(this.actors[i].z>t.z)return this.actors.splice(i,0,t),t}return this.actors.push(t),t},stage.unRegisterActor=function(t){this.unRegisterList.push(t)},stage.unloadLevel=function(){stage.tiles=[],stage.actors=[],stage.unRegisterList=[],stage.outOfBoundsWalls=[],physics.actors=[],HUD.elements=[]},stage.getTile=function(t,i){if(0<=t&&t<stage.width&&0<=i&&i<stage.height)return stage.tiles[t][i];for(var e=0;e<stage.outOfBoundsWalls.length;e++)if(stage.outOfBoundsWalls[e].sX===t&&stage.outOfBoundsWalls[e].sY===i)return stage.outOfBoundsWalls[e];var s=new Wall(0,0);return s.sprite.source.x=4*s.sprite.sheet.cellW,s.sprite.source.y=6*s.sprite.sheet.cellH,s.x=t*TSIZE+HTSIZE,s.y=i*TSIZE+HTSIZE,s.sX=t,s.sY=i,stage.outOfBoundsWalls.push(s),s},stage.getTileAtWorld=function(t,i){return this.getTile(parseInt(t/TSIZE),parseInt(i/TSIZE))},stage.getTilesInside=function(t,i,e,s){t=Math.floor(t/TSIZE),i=Math.floor(i/TSIZE),e=Math.floor(e/TSIZE),s=Math.floor(s/TSIZE);for(var r=[],h=0;h<=s-e;h++){r[h]=[];for(var a=0;a<=i-t;a++)r[h][a]=stage.getTile(e+h,t+a)}return r},stage.update=function(){stage.levelTime+=time.deltaTime;for(var t=0;t<stage.height;t++)for(var i=0;i<stage.width;i++)null!=stage.tiles[i][t].update&&stage.tiles[i][t].update();if(0!=this.unRegisterList.length){for(var e=0;e<this.unRegisterList.length;e++)for(var s=0;s<this.actors.length;s++)if(this.actors[s]==this.unRegisterList[e]){this.actors.splice(s,1);break}this.unRegisterList=[]}for(e=0;e<this.actors.length;e++)null!=this.actors[e].update&&this.actors[e].update();for(e=0;e<this.actors.length;e++)null!=this.actors[e].lateUpdate&&this.actors[e].lateUpdate()},stage.sortActors=function(){for(var t=0;t<stage.actors.length-1;t++)if(stage.actors[t].z>stage.actors[t+1].z||stage.actors[t].z==stage.actors[t+1].z&&stage.actors[t].y>stage.actors[t+1].y){var i=stage.actors[t];stage.actors[t]=stage.actors[t+1],stage.actors[t+1]=i}},stage.notifications=function(){if(2<=stage.currentLevel&&stage.currentLevel<=4){var t={font:"Bold 11px Arial",fill:"white",shadow:{color:"black",blur:2,offsetX:1,offsetY:1},msg:""};(i=new HUDText(2,12,10,t)).timer=10,HUD.register(i),i.update=function(){1!=gameLoop.isPaused&&(this.timer-=time.deltaTime),this.timer<0&&(this.msg="Tip: You can press R at anytime to restart a level."),this.timer<-10&&HUD.unRegister(this)}}if(6<=stage.currentLevel&&stage.currentLevel<=7){t={font:"Bold 11px Arial",fill:"white",shadow:{color:"black",blur:2,offsetX:1,offsetY:1},msg:""};(i=new HUDText(2,12,10,t)).timer=10,HUD.register(i),i.update=function(){1!=gameLoop.isPaused&&(this.timer-=time.deltaTime),this.timer<0&&(this.msg="Tip: Use passwords to skip to a specific level."),this.timer<-15&&HUD.unRegister(this)},(i=new HUDText(2,28,10,t)).timer=10,HUD.register(i),i.update=function(){1!=gameLoop.isPaused&&(this.timer-=time.deltaTime),this.timer<0&&(this.msg="Press Enter to pause and type the password in."),this.timer<-15&&HUD.unRegister(this)}}if(9<=stage.currentLevel&&stage.currentLevel<=10){t={font:"Bold 11px Arial",fill:"white",shadow:{color:"black",blur:2,offsetX:1,offsetY:1},msg:""};(i=new HUDText(2,12,10,t)).timer=10,HUD.register(i),i.update=function(){1!=gameLoop.isPaused&&(this.timer-=time.deltaTime),this.timer<0&&(this.msg="Tip: Don't forget to write down the password!"),this.timer<-10&&HUD.unRegister(this)}}if(14===stage.currentLevel){var i;t={font:"Bold 11px Arial",fill:"white",shadow:{color:"black",blur:2,offsetX:1,offsetY:1},msg:""};(i=new HUDText(2,12,10,t)).timer=5,HUD.register(i),i.update=function(){1!=gameLoop.isPaused&&(this.timer-=time.deltaTime),this.timer<0&&(this.msg="Tip: Press the SpaceBar to fire!"),this.timer<-10&&HUD.unRegister(this)}}},stage.skipLevelCheck=function(){240<=stage.levelTime&&5<=stage.levelDeaths&&(stage.showSkipScreen=!0)},stage.openSkipScreen=function(){stage.showSkipScreen=!1,stage.skipScreen=new Object,HUD.register(stage.skipScreen),stage.skipScreen.members=[],stage.skipScreen.answer=!1,stage.skipScreen.update=function(){gameLoop.isPaused=!0,input.pause.pressed&&(!0===this.answer?(stage.levelTime=0,stage.levelDeaths=0,stage.currentLevel+=1):stage.levelDeaths=2,gameLoop.nextLevel=!0),!0===input.anyKey&&1!=input.pause.pressed&&(!0===this.answer?this.answer=!1:this.answer=!0);for(var t=0;t<this.members.length;t++)null!=this.members[t].update&&this.members[t].update()},stage.skipScreen.draw=function(){for(var t=0;t<this.members.length;t++)null!=this.members[t].draw&&this.members[t].draw()};var t=new HUDRect(0,0,2,0,0,"black");stage.skipScreen.members.push(t),t.update=function(){this.x=0,this.y=0,this.w=canvas.width,this.h=canvas.height};var i={font:"Bold 12px Arial",fill:"white",shadow:{color:"black",blur:2,offsetX:1,offsetY:1},msg:"You seem to be struggling."},e=new HUDText(0,0,10,i);stage.skipScreen.members.push(e),e.update=function(){this.x=canvas.width/2-75,this.y=canvas.height/2-32},i.msg="Would you like to skip this level?";e=new HUDText(0,0,10,i);stage.skipScreen.members.push(e),e.update=function(){this.x=canvas.width/2-88,this.y=canvas.height/2-16},i.msg="Yes",i.fill="rgb(100,100,100)";e=new HUDText(0,0,10,i);stage.skipScreen.members.push(e),e.update=function(){this.y=canvas.height/2+16,!0===stage.skipScreen.answer?(this.x=canvas.width/2-42,this.fill="rgb(0,255,0)",this.font="Bold 14px Arial"):(this.x=canvas.width/2-40,this.fill="rgb(100,100,100)",this.font="Bold 12px Arial")},i.msg="No";e=new HUDText(0,0,10,i);stage.skipScreen.members.push(e),e.update=function(){this.y=canvas.height/2+16,!1===stage.skipScreen.answer?(this.x=canvas.width/2+19,this.fill="rgb(255,0,0)",this.font="Bold 14px Arial"):(this.x=canvas.width/2+20,this.fill="rgb(100,100,100)",this.font="Bold 12px Arial")}},stage.openCurtain=function(){null===this.curtain&&(this.curtain=new HUDRect(0,0,2,0,0,"black"),this.curtain.state="opening",this.curtain.timer=0,this.curtain.length=.5,this.curtain.update=function(){gameLoop.isPaused=!0,this.timer+=time.deltaTime,this.timer>this.length&&(this.timer=this.length),this.x=0,this.y=0,this.w=canvas.width,this.h=canvas.height*(1-this.timer/this.length),this.timer===this.length&&(HUD.unRegister(this),gameLoop.isPaused=!1,stage.curtain=null)},HUD.register(this.curtain))},stage.closeCurtain=function(){null===this.curtain&&(this.curtain=new HUDRect(0,0,2,0,0,"black"),this.curtain.state="closing",this.curtain.timer=0,this.curtain.length=.5,this.curtain.update=function(){gameLoop.isPaused=!0,this.timer+=time.deltaTime,this.timer>this.length&&(this.timer=this.length),this.w=canvas.width*(this.timer/this.length),this.h=canvas.height*(this.timer/this.length),this.x=canvas.width/2-this.w/2,this.y=canvas.height/2-this.h/2,this.timer===this.length&&(HUD.unRegister(stage.curtain),stage.curtain=null,!1===stage.showSkipScreen?gameLoop.nextLevel=!0:stage.openSkipScreen())},HUD.register(this.curtain))},physics=new Object,physics.actors=[],physics.unRegisterList=[],physics.registerList=[],physics.update=function(){if(0!=this.unRegisterList.length){for(var t=0;t<this.unRegisterList.length;t++)for(var i=0;i<this.actors.length;i++)if(this.actors[i]==this.unRegisterList[t]){this.actors.splice(i,1);break}this.unRegisterList=[]}if(0!=this.registerList.length){for(t=0;t<this.registerList.length;t++){for(i=0;i<this.actors.length&&this.actors[i]!=this.registerList[t];i++);this.actors.push(this.registerList[t])}this.registerList=[]}for(t=0;t<this.actors.length;t++){var e=this.actors[t].rigidBody;if((0!=e.velocity.x||0!=e.velocity.y)&&"static"!=e.type){if(0<e.friction){var s=e.friction*e.velocity.x*time.deltaTime,r=e.friction*e.velocity.y*time.deltaTime;Math.abs(s)<Math.abs(e.velocity.x)?e.velocity.x-=s:e.velocity.x=0,Math.abs(r)<Math.abs(e.velocity.y)?e.velocity.y-=r:e.velocity.y=0,Math.abs(e.velocity.x)<1&&(e.velocity.x=0),Math.abs(e.velocity.y)<1&&(e.velocity.y=0)}this.actors[t].x+=e.velocity.x*time.deltaTime,this.actors[t].y+=e.velocity.y*time.deltaTime}}for(var h=[],a=!0;a;){a=!1;for(t=0;t<this.actors.length;t++){for(i=t+1;i<this.actors.length;i++){if(0!=(g=this.getOverlap(this.actors[t],this.actors[i])).x&&0!=g.y){null==h[t]&&(h[t]=new HitData(this.actors[t])),null==h[i]&&(h[i]=new HitData(this.actors[i]));for(var o=!1,l=0;l<h[t].list.length;l++)h[t].list[l]==this.actors[i]&&(o=!0);0==o&&(a=!0,h[t].add(this.actors[i]),h[i].add(this.actors[t]),this.findLimits(h[t],h[i],g))}}for(var n=stage.getTilesInside(this.actors[t].top,this.actors[t].bottom,this.actors[t].left,this.actors[t].right),c=0;c<n.length;c++)for(var p=0;p<n[c].length;p++){var g;if(null!=n[c][p].rigidBody)if(0!=(g=this.getOverlap(this.actors[t],n[c][p])).x&&0!=g.y){null==h[t]&&(h[t]=new HitData(this.actors[t]));for(o=!1,i=0;i<h[t].list.length;i++)h[t].list[i]==n[c][p]&&(o=!0);if(0==o){a=!0,h[t].add(n[c][p]);var u=new HitData(n[c][p]);u.add(this.actors[t]),this.findLimits(h[t],u,g)}}}}if(1==a)for(t=0;t<h.length;t++)null!=h[t]&&(null!=h[t].lLim&&null!=h[t].rLim?(this.actors[t].x=(h[t].lLim+h[t].rLim)/2,Math.abs(h[t].rLim-h[t].lLim)<this.actors[t].width/2&&null!=this.actors[t].kill&&this.actors[t].kill(physics)):(null!=h[t].lLim&&(this.actors[t].x=h[t].lLim+this.actors[t].width/2),null!=h[t].rLim&&(this.actors[t].x=h[t].rLim-this.actors[t].width/2)),null!=h[t].tLim&&null!=h[t].bLim?(this.actors[t].y=(h[t].tLim+h[t].bLim)/2,Math.abs(h[t].bLim-h[t].tLim)<this.actors[t].height/2&&null!=this.actors[t].kill&&this.actors[t].kill(physics)):(null!=h[t].tLim&&(this.actors[t].y=h[t].tLim+this.actors[t].height/2),null!=h[t].bLim&&(this.actors[t].y=h[t].bLim-this.actors[t].height/2)))}for(t=0;t<h.length;t++)if(null!=h[t]){var y={x:h[t].target.x-h[t].startPos.x,y:h[t].target.y-h[t].startPos.y},d=h[t].target.rigidBody.mass*Math.sqrt(Math.pow(y.x/time.deltaTime,2)+Math.pow(y.y/time.deltaTime,2));physics.applyForce(d,y.x,y.y,h[t].target.rigidBody)}for(t=0;t<h.length;t++)if(null!=h[t])for(i=0;i<h[t].list.length;i++)null!=h[t].target.hit&&h[t].target.hit(h[t].list[i]),h[t].list[i].isTile&&null!=h[t].list[i].hit&&h[t].list[i].hit(h[t].target)},physics.registerActor=function(t){this.registerList.push(t)},physics.unRegisterActor=function(t){this.unRegisterList.push(t)},HitData.prototype.add=function(t){this.list.push(t)},physics.findLimits=function(t,i,e){var s=t.target,r=i.target,h=s.rigidBody,a=r.rigidBody;if("trigger"!=h.type&&"trigger"!=a.type&&!("weightless"==h.type&&"weightless"==a.type||"static"==h.type&&"static"==a.type)){for(var o=0;o<h.ignores.length;o++)if(h.ignores[o]==r.constructor)return;for(o=0;o<a.ignores.length;o++)if(a.ignores[o]==s.constructor)return;var l=.001;if("static"==h.type||"weightless"!=h.type&&"static"!=a.type)if("static"==a.type||"weightless"!=a.type&&"static"!=h.type){if("static"!=h.type&&"static"!=a.type)if(Math.abs(e.x)<Math.abs(e.y)){var n=Math.abs(e.x)*(a.mass/(h.mass+a.mass)),c=Math.abs(e.x)*(h.mass/(h.mass+a.mass));s.x>r.x?((null==t.lLim||t.lLim<r.right-c)&&(t.lLim=r.right-c),(null==i.rLim||i.rLim>s.left+n)&&(i.rLim=s.left+n)):((null==t.rLim||t.rLim>r.left-c)&&(t.rLim=r.left+c),(null==i.lLim||i.lLim<s.right+n)&&(i.lLim=s.right-n))}else{n=Math.abs(e.y)*(h.mass/(h.mass+a.mass)),c=Math.abs(e.y)*(a.mass/(h.mass+a.mass));s.y>r.y?((null==t.tLim||t.tLim<r.bottom-c)&&(t.tLim=r.bottom-c),(null==i.bLim||i.bLim>s.top+n)&&(i.bLim=s.top+n)):((null==t.bLim||t.bLim>r.top-c)&&(t.bLim=r.top+c),(null==i.tLim||i.tLim<s.bottom+n)&&(i.tLim=s.bottom-n))}}else Math.abs(e.x)<Math.abs(e.y)?r.x>s.x?(null==i.lLim||i.lLim<s.right+l)&&(i.lLim=s.right+l):(null==i.rLim||i.rLim>s.left-l)&&(i.rLim=s.left-l):r.y>s.y?(null==i.tLim||i.tLim<s.bottom+l)&&(i.tLim=s.bottom+l):(null==i.bLim||i.bLim>s.top-l)&&(i.bLim=s.top-l);else Math.abs(e.x)<Math.abs(e.y)?s.x>r.x?(null==t.lLim||t.lLim<r.right+l)&&(t.lLim=r.right+l):(null==t.rLim||t.rLim>r.left-l)&&(t.rLim=r.left-l):s.y>r.y?(null==t.tLim||t.tLim<r.bottom+l)&&(t.tLim=r.bottom+l):(null==t.bLim||t.bLim>r.top-l)&&(t.bLim=r.top-l)}},physics.getOverlap=function(t,i){var e={x:0,y:0};return t.x>i.x?t.left<i.right&&(e.x=t.left-i.right):t.right>i.left&&(e.x=t.right-i.left),t.y>i.y?t.top<i.bottom&&(e.y=t.top-i.bottom):t.bottom>i.top&&(e.y=t.bottom-i.top),e},physics.rayTrace=function(t,i,e,s){var r=[],h=Math.abs(e-t),a=Math.abs(s-i),o=t,l=i,n=1+h+a;if(t<e)var c=1;else c=-1;if(i<s)var p=1;else p=-1;var g=h-a;h*=2,a*=2;for(n=n;0<n;--n)r.push(stage.getTile(o,l)),0<g?(o+=c,g-=a):(l+=p,g+=h);return r},physics.applyForce=function(t,i,e,s){var r=Math.sqrt(Math.abs(i)/(Math.abs(i)+Math.abs(e)))||0,h=Math.sqrt(Math.abs(e)/(Math.abs(i)+Math.abs(e)))||0;i<0&&(r*=-1),e<0&&(h*=-1);var a=t/s.mass;s.velocity.x+=a*r,s.velocity.y+=a*h},camera=new Object,camera.x=0,camera.y=0,Object.defineProperty(camera,"sX",{get:function(){return parseInt(this.x/TSIZE)}}),Object.defineProperty(camera,"sY",{get:function(){return parseInt(this.y/TSIZE)}}),camera.scale=CAMERASCALE,camera.focus=null,camera.panMode=!1,camera.outOfBoundsWall=null,input.registerNew("dbug",[]),camera.update=function(){null!=this.focus&&(0==this.panMode?(this.x=this.focus.x,this.y=this.focus.y):console.log("Pan Mode not written yet"));for(var t=Math.ceil(Math.ceil(canvas.tWidth/this.scale)/2),i=Math.ceil(Math.ceil(canvas.tHeight/this.scale)/2),e=this.sX-t,s=this.sX+t+1,r=this.sY-i,h=this.sY+i+1,a=r;a<h;a++)for(var o=e;o<s;o++)0<=o&&o<stage.width&&0<=a&&a<stage.height?this.draw(stage.getTile(o,a)):(null===camera.outOfBoundsWall&&(camera.outOfBoundsWall=new Wall(0,0),camera.outOfBoundsWall.sprite.source.x=4*camera.outOfBoundsWall.sprite.sheet.cellW,camera.outOfBoundsWall.sprite.source.y=6*camera.outOfBoundsWall.sprite.sheet.cellH),camera.outOfBoundsWall.x=o*TSIZE+HTSIZE,camera.outOfBoundsWall.y=a*TSIZE+HTSIZE,this.draw(camera.outOfBoundsWall));if(gameLoop.isInDBug)for(o=e;o<s;o++)for(a=r;a<h;a++)this.drawDBUG(stage.getTile(o,a));t=Math.ceil(Math.ceil(canvas.width/this.scale)/2),i=Math.ceil(Math.ceil(canvas.height/this.scale)/2),e=this.x-t,s=this.x+t+1,r=this.y-i,h=this.y+i+1,stage.sortActors();for(var l=0;l<stage.actors.length;l++){var n=stage.actors[l],c=stage.actors[l].sprite;n.x+c.offset.x+c.sheet.cellW>e&&n.x+c.offset.x-c.sheet.cellW<s&&n.y+c.offset.y+c.sheet.cellH>r&&n.y+c.offset.y-c.sheet.cellH<h&&this.draw(stage.actors[l])}if(gameLoop.isInDBug)for(l=0;l<stage.actors.length;l++){n=stage.actors[l],c=stage.actors[l].sprite;n.x+c.offset.x+c.sheet.cellW>e&&n.x+c.offset.x-c.sheet.cellW<s&&n.y+c.offset.y+c.sheet.cellH>r&&n.y+c.offset.y-c.sheet.cellH<h&&this.drawDBUG(stage.actors[l])}for(l=0;l<HUD.elements.length;l++)HUD.elements[l].draw()},camera.draw=function(t){var i=t.sprite.sheet.cellW,e=t.sprite.sheet.cellH,s=(t.x+t.sprite.offset.x-i/2)*this.scale-(this.x*this.scale-canvas.width/2),r=(t.y+t.sprite.offset.y-e/2)*this.scale-(this.y*this.scale-canvas.height/2);if(0<s+i*this.scale&&0<r+e*this.scale&&s<canvas.width&&r<canvas.height){var h=t.sprite.sheet;if(h.complete){var a=t.sprite.source.x,o=t.sprite.source.y,l=i*this.scale,n=e*this.scale;s=Math.round(s,1),r=Math.round(r,1),l=Math.round(l,1),n=Math.round(n,1),ctx.drawImage(h,a,o,i,e,s,r,l,n)}}},camera.drawDBUG=function(t){var i=t.sprite.sheet.cellW,e=t.sprite.sheet.cellH,s=(t.x+t.sprite.offset.x-i/2)*this.scale-(this.x*this.scale-canvas.width/2),r=(t.y+t.sprite.offset.y-e/2)*this.scale-(this.y*this.scale-canvas.height/2);if(0<s+i*this.scale&&0<r+e*this.scale&&s<canvas.width&&r<canvas.height&&t.sprite.sheet.complete){t.sprite.source.x,t.sprite.source.y;var h=i*this.scale,a=e*this.scale;s=Math.round(s,1),r=Math.round(r,1),h=Math.round(h,1),a=Math.round(a,1),null!=t.rigidBody&&(s=Math.round(t.x*this.scale-(this.x*this.scale-canvas.width/2)-t.width*this.scale/2),r=Math.round(t.y*this.scale-(this.y*this.scale-canvas.height/2)-t.height*this.scale/2),ctx.strokeStyle="red",ctx.strokeRect(s,r,t.width*this.scale,t.height*this.scale))}},HUD=new Object,HUD.elements=[],HUD.registerList=[],HUD.unRegisterList=[],HUD.update=function(){if(0!=this.unRegisterList.length){for(var t=0;t<this.unRegisterList.length;t++)for(var i=0;i<this.elements.length;i++)if(this.elements[i]==this.unRegisterList[t]){this.elements.splice(i,1);break}this.unRegisterList=[]}if(0!=this.registerList.length){for(t=0;t<this.registerList.length;t++){for(i=0;i<this.elements.length;i++)if(this.elements[i].z>this.registerList[t].z){this.elements.splice(i,0,this.registerList[t]);break}i>=this.elements.length&&this.elements.push(this.registerList[t])}this.registerList=[]}for(t=0;t<this.elements.length;t++)null!=this.elements[t].update&&this.elements[t].update()},HUD.register=function(t){for(var i=0;i<this.registerList.length;i++)if(this.registerList[i]==t)return!1;return this.registerList.push(t),!0},HUD.unRegister=function(t){for(var i=0;i<this.unRegisterList.length;i++)if(this.unRegisterList[i]==t)return!1;return this.unRegisterList.push(t),!0},HUD.cleanUp=function(){ctx.font=null,ctx.fillStyle=null,ctx.strokeStyle=null,ctx.lineWidth=1,ctx.shadowColor=null,ctx.shadowBlur=null,ctx.shadowOffsetX=null,ctx.shadowOffsetY=null},HUDRect=function(t,i,e,s,r,h,a){this.x=t,this.y=i,this.z=e,this.w=s,this.h=r,this.fillColor=h,this.strokeColor=a},HUDRect.prototype.draw=function(){null!=this.strokeColor&&(ctx.fillStyle=this.strokeColor,ctx.strokeRect(this.x,this.y,this.w,this.h)),null!=this.fillColor&&(ctx.fillStyle=this.fillColor,ctx.fillRect(this.x,this.y,this.w,this.h)),HUD.cleanUp()},HUDText=function(t,i,e,s){this.x=t,this.y=i,this.z=e,this.msg=s.msg,this.font=s.font,this.fill=s.fill,this.stroke=s.stroke,this.lineWidth=s.lineWidth,this.shadow=s.shadow},HUDText.prototype.draw=function(){ctx.font=this.font,ctx.lineWidth=this.lineWidth,null!=this.stroke&&(ctx.strokeStyle=this.stroke,ctx.strokeText(this.msg,this.x,this.y)),null!=this.fill&&(null!=this.shadow&&(null!=this.shadow.color&&(ctx.shadowColor=this.shadow.color),null!=this.shadow.blur&&(ctx.shadowBlur=this.shadow.blur),null!=this.shadow.offsetX&&(ctx.shadowOffsetX=this.shadow.offsetX),null!=this.shadow.offsetY&&(ctx.shadowOffsetY=this.shadow.offsetY)),ctx.fillStyle=this.fill,ctx.fillText(this.msg,this.x,this.y)),HUD.cleanUp()},HUDImg=function(t,i,e,s,r,h,a,o,l,n){this.x=t,this.y=i,this.z=e,this.w=s,this.h=r,this.sX=h,this.sY=a,this.sW=o,this.sH=l,this.img=new Image,this.img.src=n},HUDImg.prototype.draw=function(){ctx.drawImage(this.img,this.sX,this.sY,this.sW,this.sH,this.x,this.y,this.w,this.h)};var gameLoop=new Object;function RandomRange(t,i){return Math.random()*(i-t)+t}function RandomIntRange(t,i){return parseInt(Math.random()*(i-t+1)+t)}function DirToCoor(t){return"up"===t?{x:0,y:-1}:"down"===t?{x:0,y:1}:"left"===t?{x:-1,y:0}:"right"===t?{x:1,y:0}:void 0}function SpinRight(t){return"up"===t?"right":"down"===t?"left":"left"===t?"up":"right"===t?"down":void 0}function SpinLeft(t){return"up"===t?"left":"down"===t?"right":"left"===t?"down":"right"===t?"up":void 0}function sprite(t,i,e,s){this.owner=t,this.offset={x:i,y:e},this.source={x:0,y:0},this.sheet=s}function rigidBody(t,i,e,s,r,h){this.velocity=new Object,this.velocity.x=0,this.velocity.y=0,this.owner=t,this.mass=i,this.friction=e,this.collider=s,Object.defineProperty(t,"width",{get:function(){return this.rigidBody.collider.w}}),Object.defineProperty(t,"height",{get:function(){return this.rigidBody.collider.h}}),Object.defineProperty(t,"top",{get:function(){return this.y-this.rigidBody.collider.h/2}}),Object.defineProperty(t,"bottom",{get:function(){return this.y+this.rigidBody.collider.h/2}}),Object.defineProperty(t,"left",{get:function(){return this.x-this.rigidBody.collider.w/2}}),Object.defineProperty(t,"right",{get:function(){return this.x+this.rigidBody.collider.w/2}}),this.type=r||"soft",this.ignores=h||[]}function animatron(){this.loop=[],this.state=null,this.direction=null,this.current=0,this.time=0,this.rate=0}function Floor(t,i){this.x=t,this.y=i,this.z=0,this.sX=parseInt(t/TSIZE),this.sY=parseInt(i/TSIZE),this.sprite=new sprite(this,0,0,Floor.sheet),this.isBlocked=!1}function Wall(t,i){this.x=t,this.y=i,this.z=0,this.sX=parseInt(t/TSIZE),this.sY=parseInt(i/TSIZE),this.sprite=new sprite(this,0,0,Wall.sheet),this.rigidBody=new rigidBody(this,null,null,{w:TSIZE,h:TSIZE},"static"),this.isBlocked=!0}function Water(t,i){this.x=t,this.y=i,this.z=0,this.sX=parseInt(t/TSIZE),this.sY=parseInt(i/TSIZE),this.sprite=new sprite(this,0,0,Water.sheet),this.rigidBody=new rigidBody(this,null,null,{w:TSIZE,h:TSIZE},"trigger"),this.isBlocked=!1,this.pull=[]}function PressurePlate(t,i){this.x=t,this.y=i,this.z=0,this.sX=parseInt(t/TSIZE),this.sY=parseInt(i/TSIZE),this.sprite=new sprite(this,0,0,PressurePlate.sheet),this.isBlocked=!1,this.state="up"}function LevelDoor(t,i){this.x=t,this.y=i,this.z=0,this.sX=parseInt(t/TSIZE),this.sY=parseInt(i/TSIZE),this.rigidBody=new rigidBody(this,null,null,{w:TSIZE,h:TSIZE},"static"),this.sprite=new sprite(this,0,0,LevelDoor.sheet),this.isBlocked=!0,this.state="closed",this.facing=null,this.curtain=null,this.type="wall"}input.registerNew("pause",["Enter"]),gameLoop.lastPause=0,gameLoop.isPaused=!1,gameLoop.isInDBug=!1,gameLoop.interval=null,gameLoop.nextLevel=!1,gameLoop.passCurrent="",gameLoop.passIndex=["default","HELLO1","WORLD2","WELCOME3","TO4","SOKOBAN5","BUZZ6","LOOPER7","ARCHER8","CLASSIC9","KNIGHTS10","NEEDLES11","RUSH12","CRUSH13","FREEZE14","DROWN15","BLOCKED16","CHECKER17","TIMING18","TWINS19","EYES20","ROOMS21","CONGO22","SPIRAL23","TRAPPED24","ROUTE25","FOLLOW26","LOLO27","FLYING28","REVENGE29","BOSS30","STOP31","SCREWED32","PRISONS33","CAREFUL34","XFIRE35","ROVER36","MAZE37","CLASSIC38","SHIELD39","BORROW40","CLASSIC41","ISLANDS42","SHRED43","CLASSIC44","SUNKEN45","PATROL46","CLASSIC47","CLASSIC48","RACE49","CLASSIC50","REPEATS51","STEADY52","FUSE53","BEEHIVE54","DRIFT55","RUN56","FISHING57","FUSETWO58","THEEND59","PARTTWO60","GAMEOVER","BONUS62","BONUS63","BONUS64","BONUS65","BONUS66","BONUS67","BONUS68","BONUS69","BONUS70","BONUS71","BONUS72","BONUS73","BONUS74","BONUS75","BONUS76","BONUS77","BONUS78","BONUS79","BONUS80"],gameLoop.update=function(){time.update(),input.update(),0==gameLoop.isPaused&&(stage.update(),physics.update()),HUD.update(),camera.update(),input.pause.pressed&&(gameLoop.isPaused?gameLoop.unPause():gameLoop.pause()),input.dbug.pressed&&!1===gameLoop.isPaused&&(!0===gameLoop.isInDBug?gameLoop.isInDBug=!1:gameLoop.isInDBug=!0),!0===gameLoop.nextLevel&&(gameLoop.nextLevel=!1,stage.loadCurrentLevel())},gameLoop.pause=function(){var t=(new Date).getTime();if(500<t-this.lastPause){this.lastPause=t,this.isPaused=!0,input.clearAll();var i={msg:"Paused",font:"Bold 42px Arial",fill:"white",shadow:{color:"black",blur:2,offsetX:1,offsetY:1}},e=new HUDText(0,0,10,i);HUD.register(e),e.update=function(){this.x=canvas.width/2-70,this.y=canvas.height/2,0==gameLoop.isPaused&&HUD.unRegister(this)},i={msg:"Enter Password: ",font:"Bold 12px Arial",fill:"white",shadow:{color:"black",blur:2,offsetX:1,offsetY:1}};var s=new HUDText(0,0,10,i);HUD.register(s),s.update=function(){this.x=canvas.width/2-68,this.y=canvas.height/2+15,0==gameLoop.isPaused&&HUD.unRegister(this)},i.msg="";var r=new HUDText(0,0,10,i);HUD.register(r),r.update=function(){this.msg=gameLoop.passCurrent,this.x=canvas.width/2+35,this.y=canvas.height/2+15,0==gameLoop.isPaused&&HUD.unRegister(this)}}},gameLoop.unPause=function(){var t=(new Date).getTime();500<t-this.lastPause&&(this.lastPause=t,this.isPaused=!1,input.clearAll())},gameLoop.addPassKey=function(t){if("Enter"===t){for(var i=1;i<gameLoop.passIndex.length;i++)if(gameLoop.passCurrent===gameLoop.passIndex[i])return stage.levelTime=0,stage.levelDeaths=0,stage.currentLevel=i,gameLoop.nextLevel=!0,!(gameLoop.passCurrent="");return gameLoop.passCurrent="",!1}if("Backspace"===t){if(0<gameLoop.passCurrent.length){var e=[];for(i=0;i<gameLoop.passCurrent.length;i++)e[i]=gameLoop.passCurrent.toString()[i];e.pop(),gameLoop.passCurrent="";for(i=0;i<e.length;i++)gameLoop.passCurrent+=e[i];return!0}return!1}var s=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],r=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","0","1","2","3","4","5","6","7","8","9"],h=!1;for(i=0;i<r.length;i++)if(t===r[i]||t===s[i]){t=r[i],h=!0;break}return!1!==h&&(gameLoop.passCurrent.length<9&&(gameLoop.passCurrent+=t),!0)},animatron.prototype.update=function(){if(null!=this.loop[this.current].r&&(this.rate=this.loop[this.current].r),0==this.rate)return!1;this.time+=time.deltaTime,this.time>this.rate&&(this.time-=this.rate,this.current+=1,this.current>=this.loop.length&&(this.current=0))},stage.tileIndex.push(Floor),Floor.sheet=new Image,Floor.sheet.src="resources/art/floor_spritesheet.png",Floor.sheet.cellW=TSIZE,Floor.sheet.cellH=TSIZE,Floor.pixelColors=[],Floor.pixelColors[0]="255,255,255",Floor.sheet.index=[0,1,2,3,4,5,6,6],Floor.prototype.type="floor",Floor.prototype.isTile=!0,Floor.prototype.isActor=!1,Floor.prototype.wakeUp=function(){for(var t=0,i=1,e=[{x:-1,y:-1},{x:0,y:-1},{x:-1,y:0}],s=0;s<e.length;s++)"wall"==stage.getTile(this.sX+e[s].x,this.sY+e[s].y).type&&(t+=i),i*=2;null!=this.sprite.sheet.index[t]&&(this.sprite.source.x=this.sprite.sheet.index[t]*this.sprite.sheet.cellW),this.sprite.source.y+=RandomIntRange(0,2)*this.sprite.sheet.cellH},stage.tileIndex.push(Wall),Wall.sheet=new Image,Wall.sheet.src="resources/art/wall_spritesheet.png",Wall.sheet.cellW=TSIZE,Wall.sheet.cellH=TSIZE,Wall.pixelColors=[],Wall.pixelColors[0]="0,0,0",Wall.sheet.index=[0,0,1,1,0,0,1,1,2,2,3,4,2,2,3,4,5,5,6,6,5,5,7,7,8,8,9,10,8,8,11,12,0,0,1,1,0,0,1,1,2,2,3,4,2,2,3,4,5,5,6,6,5,5,7,7,8,8,9,10,8,8,11,12,13,13,14,14,13,13,14,14,15,15,16,17,15,15,16,17,18,18,19,19,18,18,20,20,21,21,22,23,21,21,24,25,13,13,14,14,13,13,14,14,26,26,27,28,26,26,27,28,18,18,19,19,18,18,20,20,29,29,30,31,29,29,32,33,0,0,1,1,0,0,1,1,2,2,3,4,2,2,3,4,5,5,6,6,5,5,7,7,8,8,9,10,8,8,11,12,0,0,1,1,0,0,1,1,2,2,3,4,2,2,3,4,5,5,6,6,5,5,7,7,8,8,9,10,8,8,11,12,13,13,14,14,13,13,14,14,15,15,16,17,15,15,16,17,34,34,35,35,34,34,36,36,37,37,38,39,37,37,40,41,13,13,14,14,13,13,14,14,26,26,27,28,26,26,27,28,34,34,35,35,34,34,36,36,42,42,43,44,42,42,45,46],Wall.prototype.type="wall",Wall.prototype.isBlocked=!0,Wall.prototype.isTile=!0,Wall.prototype.isActor=!1,Wall.prototype.wakeUp=function(){for(var t=0,i=1,e=this.sY-1;e<=this.sY+1;e++)for(var s=this.sX-1;s<=this.sX+1;s++)s==this.sX&&e==this.sY||("wall"==stage.getTile(s,e).type&&(t+=i),i*=2);if(null!=this.sprite.sheet.index[t])for(this.sprite.source.x=this.sprite.sheet.index[t]*this.sprite.sheet.cellW;this.sprite.source.x>=this.sprite.sheet.width;)this.sprite.source.y+=this.sprite.sheet.cellH,this.sprite.source.x-=this.sprite.sheet.width},stage.tileIndex.push(Water),Water.sheet=new Image,Water.sheet.src="resources/art/water_spritesheet.png",Water.sheet.cellW=TSIZE,Water.sheet.cellH=TSIZE,Water.anim=new animatron(Water),Water.anim.lastUpdate=0,Water.anim.loop[0]={x:8*TSIZE*0,r:.35},Water.anim.loop[1]={x:8*TSIZE*1,r:.35},Water.anim.loop[2]={x:8*TSIZE*2,r:.35},Water.anim.loop[3]={x:8*TSIZE*3,r:.35},Water.pixelColors=[],Water.pixelColors[0]="0,0,255",Water.prototype.type="water",Water.prototype.pullSpeed=80,Water.prototype.isTile=!0,Water.prototype.isActor=!1,Water.prototype.wakeUp=function(){for(var t=0,i=1,e=this.sY-1;e<=this.sY+1;e++)for(var s=this.sX-1;s<=this.sX+1;s++)s==this.sX&&e==this.sY||(stage.getTile(s,e).constructor==Water&&(t+=i),i*=2);if(null!=Wall.sheet.index[t])for(this.sprite.source.xOffset=Wall.sheet.index[t]*this.sprite.sheet.cellW;this.sprite.source.xOffset>=7*this.sprite.sheet.cellW;)this.sprite.source.y+=this.sprite.sheet.cellH,this.sprite.source.xOffset-=7*this.sprite.sheet.cellW;this.sprite.source.x=this.sprite.source.xOffset+Water.anim.loop[Water.anim.current].x,stage.getTile(this.sX,this.sY+1).constructor!=Water?this.pull.up=!0:this.pull.up=!1,stage.getTile(this.sX,this.sY-1).constructor!=Water?this.pull.down=!0:this.pull.down=!1,stage.getTile(this.sX+1,this.sY).constructor!=Water?this.pull.left=!0:this.pull.left=!1,stage.getTile(this.sX-1,this.sY).constructor!=Water?this.pull.right=!0:this.pull.right=!1},Water.prototype.update=function(){Water.anim.lastUpdate!=time.now&&(Water.anim.lastUpdate=time.now,Water.anim.update()),this.sprite.source.x=this.sprite.source.xOffset+Water.anim.loop[Water.anim.current].x,this.sprite.source.y=this.sprite.source.y},Water.prototype.hit=function(t){if("water"==this.type)if("crate"==t.type&&t.x==this.x&&t.y==this.y){this.type="floor",this.isBlocked=!1,this.sprite.source.y+=7*this.sprite.sheet.cellH,t.kill(this);var i=stage.getTile(this.sX,this.sY-1);i.constructor==Water&&(i.pull.up=!0),(i=stage.getTile(this.sX,this.sY+1)).constructor==Water&&(i.pull.down=!0),(i=stage.getTile(this.sX-1,this.sY)).constructor==Water&&(i.pull.left=!0),(i=stage.getTile(this.sX+1,this.sY)).constructor==Water&&(i.pull.right=!0)}else if("pickup"===t.type)null!=t.kill&&t.kill(this);else if(("player"==t.type||t.constructor==IceBlock||"enemy"==t.type)&&t.constructor!=Buzz&&t.sX==this.sX&&t.sY==this.sY){for(var e=stage.getTilesInside(t.top,t.bottom,t.left,t.right),s=!0,r=0;r<e.length&&!0===s;r++)for(var h=0;h<e[r].length&&!0===s;h++)"water"!=e[r][h].type&&(s=!1);if(s)t.rigidBody.velocity.x-=4*t.rigidBody.velocity.x*time.deltaTime,t.rigidBody.velocity.y-=4*t.rigidBody.velocity.y*time.deltaTime,t.constructor!=IceBlock&&null!=t.kill&&t.kill(this);else{var a=physics.getOverlap(t,this),o=null,l=null;o=0<a.x?"right":"left",l=0<a.y?"down":"up";var n=null;r=0,h=0;"up"===(n=Math.abs(a.x)<Math.abs(a.y)?!0===this.pull[o]?o:l:!0===this.pull[l]?l:o)?h=-1:"down"===n?h=1:"left"===n?r=-1:"right"===n&&(r=1),t.rigidBody.velocity.x+=r*Math.abs(a.x)*this.pullSpeed*time.deltaTime,t.rigidBody.velocity.y+=h*Math.abs(a.y)*this.pullSpeed*time.deltaTime}}},stage.tileIndex.push(PressurePlate),PressurePlate.sheet=Floor.sheet,PressurePlate.pixelColors=[],PressurePlate.pixelColors[0]="255,0,255",PressurePlate.sheet.index=[0,1,2,3,4,5,6,6],PressurePlate.prototype.type="floor",PressurePlate.prototype.isTile=!0,PressurePlate.prototype.isActor=!1,PressurePlate.prototype.wakeUp=function(){for(var t=0,i=1,e=[{x:-1,y:-1},{x:0,y:-1},{x:-1,y:0}],s=0;s<e.length;s++)"wall"==stage.getTile(this.sX+e[s].x,this.sY+e[s].y).type&&(t+=i),i*=2;null!=PressurePlate.sheet.index[t]&&(this.sprite.source.x=PressurePlate.sheet.index[t]*this.sprite.sheet.cellW),this.sprite.source.y+=3*this.sprite.sheet.cellH},stage.tileIndex.push(LevelDoor),LevelDoor.sheet=new Image,LevelDoor.sheet.src="resources/art/leveldoor_spritesheet.png",LevelDoor.sheet.cellW=TSIZE,LevelDoor.sheet.cellH=TSIZE,LevelDoor.pixelColors=[],LevelDoor.pixelColors[0]="0,255,0",LevelDoor.plates=[],LevelDoor.prototype.isTile=!0,LevelDoor.prototype.isActor=!1,LevelDoor.prototype.wakeUp=function(){LevelDoor.plates=[];for(var t=0;t<stage.width;t++)for(var i=0;i<stage.height;i++){var e=stage.getTile(t,i);e.constructor==PressurePlate&&LevelDoor.plates.push(e)}"closed"==this.state?this.sprite.source.y=0*this.sprite.sheet.cellH:this.sprite.source.y=+this.sprite.sheet.cellH,stage.getTile(this.sX,this.sY-1).constructor!=Wall?(this.facing="up",this.sprite.source.x=0*this.sprite.sheet.cellW):stage.getTile(this.sX,this.sY+1).constructor!=Wall?(this.facing="down",this.sprite.source.x=3*this.sprite.sheet.cellW):stage.getTile(this.sX-1,this.sY).constructor!=Wall?(this.facing="left",this.sprite.source.x=+this.sprite.sheet.cellW):stage.getTile(this.sX+1,this.sY).constructor!=Wall&&(this.facing="right",this.sprite.source.x=2*this.sprite.sheet.cellW)},LevelDoor.prototype.update=function(){for(var t=0;t<LevelDoor.plates.length;t++)if("up"==LevelDoor.plates[t].state){if("open"==this.state){this.state="closed",this.type="wall",this.rigidBody.type="static",this.sprite.source.y=0*this.sprite.sheet.cellH;for(var i=0;i<physics.actors.length;i++)physics.actors[i].sX===this.sX&&physics.actors[i].sY===this.sY&&("up"===this.facing&&(physics.actors[i].y=this.top-physics.actors[i].height/2),"down"===this.facing&&(physics.actors[i].y=this.bottom+physics.actors[i].height/2),"left"===this.facing&&(physics.actors[i].x=this.left-physics.actors[i].width/2),"right"===this.facing&&(physics.actors[i].x=this.right+physics.actors[i].width/2))}return}"closed"==this.state&&(this.state="open",this.type="floor",this.rigidBody.type="trigger",this.sprite.source.y=+this.sprite.sheet.cellH)},LevelDoor.prototype.hit=function(t){if("open"==this.state&&"player"==t.type){if("up"==this.facing&&t.top<this.top)return;if("down"==this.facing&&t.bottom>this.bottom)return;if("left"==this.facing&&t.left<this.left)return;if("right"==this.facing&&t.right>this.right)return;stage.currentLevel++,stage.levelTime=0,stage.levelDeaths=0,stage.closeCurtain()}};var UNDERFOOT=0,ATEYE=1,OVERHEAD=2;function Tester(t,i){this.x=t,this.y=i,this.z=ATEYE,Object.defineProperty(this,"sX",{get:function(){return parseInt(this.x/TSIZE)}}),Object.defineProperty(this,"sY",{get:function(){return parseInt(this.y/TSIZE)}}),this.type="unit",this.isDead=!1,this.sprite=new sprite(this,0,0,Tester.sheet),this.rigidBody=new rigidBody(this,5,5,{w:16,h:16},"soft")}function Player(t,i){this.x=t,this.y=i,this.z=ATEYE,Object.defineProperty(this,"sX",{get:function(){return parseInt(this.x/TSIZE)}}),Object.defineProperty(this,"sY",{get:function(){return parseInt(this.y/TSIZE)}}),this.type="player",this.isDead=!1,this.sprite=new sprite(this,0,-4.5,Player.sheet),this.rigidBody=new rigidBody(this,5,7,{w:12,h:12},"soft"),this.state="idle",this.anim=new animatron,this.facing="down",this.moveForce=3e3,this.inputQueue=[],this.pushToggle=!1,this.ammo=0,this.ammoText=null,this.setAnimation(this.state)}function Crate(t,i){this.x=t,this.y=i,this.z=UNDERFOOT,Object.defineProperty(this,"sX",{get:function(){return parseInt(this.x/TSIZE)}}),Object.defineProperty(this,"sY",{get:function(){return parseInt(this.y/TSIZE)}}),stage.getTile(this.sX,this.sY).isBlocked=!0,this.type="crate",this.isDead=!1,this.sprite=new sprite(this,0,0,Crate.sheet),this.rigidBody=new rigidBody(this,2,5,{w:TSIZE,h:TSIZE},"static"),this.facing=null,this.state=null,this.pusher=null,this.slideTile=null,this.slideSpeed=38}function Archer(t,i,e){this.x=t,this.y=i,this.z=ATEYE,Object.defineProperty(this,"sX",{get:function(){return parseInt(this.x/TSIZE)}}),Object.defineProperty(this,"sY",{get:function(){return parseInt(this.y/TSIZE)}}),this.type="enemy",this.isDead=!1,this.state="ready",this.facing="down",this.sprite=new sprite(this,0,-3,Archer.sheet),this.rigidBody=new rigidBody(this,0,0,{w:14,h:14},"static"),this.anim=new animatron,this.minShootForce=400,this.maxShootForce=800,this.shootForcePer=3,this.canFire=!0,this.targetPlayer=null,this.arrows=[]}function Arrow(t,i,e){this.x=t,this.y=i,this.z=ATEYE,Object.defineProperty(this,"sX",{get:function(){return parseInt(this.x/TSIZE)}}),Object.defineProperty(this,"sY",{get:function(){return parseInt(this.y/TSIZE)}}),this.type="projectile",this.isDead=!1,this.sprite=new sprite(this,0,0,Arrow.sheet),this.rigidBody=new rigidBody(this,1,0,{w:3,h:3},"trigger"),this.firer=e,this.facing=e.facing,this.hitTarget=null}function Knight(t,i,e){this.x=t,this.y=i,this.z=ATEYE,Object.defineProperty(this,"sX",{get:function(){return parseInt(this.x/TSIZE)}}),Object.defineProperty(this,"sY",{get:function(){return parseInt(this.y/TSIZE)}}),this.sprite=new sprite(this,0,-1.5,Knight.sheet),this.rigidBody=new rigidBody(this,5,7,{w:12,h:12},"soft"),this.anim=new animatron,e===Knight.pixelColors[0]&&(this.hand="left"),e===Knight.pixelColors[1]&&(this.hand="right"),this.state="idle",this.type="enemy",this.isDead=!1,this.facing="down",this.targetPlayer=null,this.lastLookFrom=null,this.lastLookTo=null,this.canSeePlayer=!1,this.playerLastSeen=null,this.idleTimer={cur:0,max:2},this.moveForce=this.walkForce,this.wayPoints=[],this.lastHandChange=0}function PathNode(t,i,e,s){this.tile=t,this.prev=i,this.distance=e,this.heuristic=s||0}function Buzz(t,i,e){this.x=t,this.y=i,this.z=ATEYE,Object.defineProperty(this,"sX",{get:function(){return parseInt(this.x/TSIZE)}}),Object.defineProperty(this,"sY",{get:function(){return parseInt(this.y/TSIZE)}}),this.type="enemy",this.isDead=!1,this.sprite=new sprite(this,.5,1,Buzz.sheet),this.rigidBody=new rigidBody(this,2,5,{w:14,h:14},"weightless",[Player,Buzz]),this.anim=new animatron,e===Buzz.pixelColors[0]&&(this.state="clockwise"),e===Buzz.pixelColors[1]&&(this.state="counter-clockwise"),this.moveForce=1200,this.facing="up"}function IceWand(t,i){this.x=t,this.y=i,this.z=ATEYE,Object.defineProperty(this,"sX",{get:function(){return parseInt(this.x/TSIZE)}}),Object.defineProperty(this,"sY",{get:function(){return parseInt(this.y/TSIZE)}}),this.type="pickup",this.isDead=!1,this.anim=new animatron,this.sprite=new sprite(this,0,-3,IceWand.sheet),this.rigidBody=new rigidBody(this,1,1,{w:4,h:8},"soft")}function IceBall(t,i,e){this.x=t,this.y=i,this.z=ATEYE,Object.defineProperty(this,"sX",{get:function(){return parseInt(this.x/TSIZE)}}),Object.defineProperty(this,"sY",{get:function(){return parseInt(this.y/TSIZE)}}),this.firer=e,this.facing=e.facing,this.type="projectile",this.isDead=!1,this.sprite=new sprite(this,0,0,IceBall.sheet),this.rigidBody=new rigidBody(this,1,0,{w:12,h:12},"trigger"),this.anim=new animatron,this.anim.rate=.1,this.speed=120,this.wakeUp()}function IceBlock(t){this.x=t.x,this.y=t.y,this.z=ATEYE,Object.defineProperty(this,"sX",{get:function(){return parseInt(this.x/TSIZE)}}),Object.defineProperty(this,"sY",{get:function(){return parseInt(this.y/TSIZE)}}),this.frozenActor=t,this.type="unit",this.isDead=!1,this.sprite=new sprite(this,0,0,IceBlock.sheet),this.rigidBody=new rigidBody(this,t.rigidBody.mass,2,{w:t.width,h:t.height},"soft"),this.colliderTrueSize={w:18,h:16},this.needPhysReg=!0,this.meltTimer=8,this.wakeUp()}Tester.pixelColors=[],Tester.pixelColors[0]="255,128,255",stage.actorIndex.push(Tester),Tester.sheet=new Image,Tester.sheet.src="resources/art/tester_spritesheet.png",Tester.sheet.cellW=16,Tester.sheet.cellH=16,Tester.prototype.isTile=!1,Tester.prototype.isActor=!0,Tester.prototype.lateUpdate=function(){},Tester.prototype.wakeUp=function(){},Tester.prototype.hit=function(t){},Tester.prototype.kill=function(t){this.isDead=!0,stage.unRegisterActor(this),physics.unRegisterActor(this)},Player.pixelColors=[],Player.pixelColors[0]="255,0,0",stage.actorIndex.push(Player),Player.sheet=new Image,Player.sheet.src="resources/art/player_spritesheet.png",Player.sheet.cellW=28,Player.sheet.cellH=29,Player.prototype.isTile=!1,Player.prototype.isActor=!0,Player.prototype.wakeUp=function(){camera.focus=this,input.registerNew("up",["w","W","Up"]),input.registerNew("down",["s","S","Down"]),input.registerNew("left",["a","A","Left"]),input.registerNew("right",["d","D","Right"]),input.registerNew("suicide",["r","R"]),input.registerNew("fire",["Spacebar"," "])},Player.prototype.update=function(){if(!1===this.pushToggle&&"pushing"===this.state&&(this.state="running"),this.pushToggle=!1,"dieing"!=this.state&&"drowning"!=this.state&&"shooting"!=this.state){var t=0,i=0;input.right.state&&(t+=1,this.facing="right"),input.left.state&&(--t,this.facing="left"),input.up.state&&(--i,this.facing="up"),input.down.state&&(i+=1,this.facing="down");for(var e=["right","left","up","down"],s=0;s<e.length;s++)if(input[e[s]].pressed&&input[e[s]].state&&this.inputQueue.unshift(e[s]),!1===input[e[s]].state)for(var r=0;r<this.inputQueue.length;r++)this.inputQueue[r]===e[s]&&this.inputQueue.splice(r,1);if(null!=this.inputQueue[0]&&(this.facing=this.inputQueue[0]),0!=t||0!=i?("pushing"!=this.state&&(this.state="running"),physics.applyForce(this.moveForce*time.deltaTime,t,i,this.rigidBody)):this.state="idle",input.fire.pressed&&0<this.ammo){this.state="shooting",--this.ammo;var h=new IceBall(this.x,this.y,this);"up"===this.facing?h.x+=2:"down"===this.facing?h.x-=2:"left"===this.facing?h.y+=2:"right"===this.facing&&(h.y+=2)}}"shooting"===this.state&&1===this.anim.current&&(this.state="idle"),input.suicide.pressed&&"dieing"!=this.state&&"drowning"!=this.state&&this.kill(this),"dieing"!==this.state&&"drowning"!==this.state||7!==this.anim.current||(this.isDead=!0,stage.closeCurtain()),input.dbug.pressed&&!1===gameLoop.isInDBug&&this.addRemoveAmmo(1),this.setAnimation(this.state),this.anim.update(),this.sprite.source.x=this.anim.loop[this.anim.current].x,this.sprite.source.y=this.anim.loop[this.anim.current].y},Player.prototype.hit=function(t){if("static"===t.rigidBody.type&&("running"===this.state||"pushing"===this.state)){var i=!1;Math.abs(t.x-this.x)>Math.abs(t.y-this.y)?t.x>this.x?"right"===this.facing&&input.right.state&&(i=!0):"left"===this.facing&&input.left.state&&(i=!0):t.y>this.y?"down"===this.facing&&input.down.state&&(i=!0):"up"===this.facing&&input.up.state&&(i=!0),i&&(this.state="pushing",this.pushToggle=!0,null!=t.push&&t.push(this))}},Player.prototype.addRemoveAmmo=function(t){if(this.ammo+=t,10<=this.ammo&&(this.ammo=9),this.ammo<0&&(this.ammo=0),null===this.ammoText){this.ammoText=new HUDText(0,0,0,{msg:"Ice",font:"Bold 12px Consolas",fill:"white",stroke:"black",lineWidth:2,shadow:{color:"black",blur:2,offsetX:1,offsetY:1}}),(this.ammoText.parent=this).ammoText.update=function(){this.x=canvas.width-38,this.y=canvas.height-5,null===this.parent?HUD.unRegister(this):this.parent.ammo<=0?(HUD.unRegister(this),this.parent.ammoText=null):this.msg=this.parent.ammo.toString()+" Ice"},HUD.register(this.ammoText)}},Player.prototype.kill=function(t){!1===this.isDead&&(this.isDead=!0,stage.levelDeaths+=1,stage.skipLevelCheck(),physics.unRegisterActor(this),t.constructor===Water?this.state="drowning":(this.rigidBody.velocity.x=0,this.rigidBody.velocity.y=0,this.state="dieing"))},Player.prototype.setAnimation=function(t){if(this.anim.state===t&&this.anim.direction===this.facing)return!1;this.anim.state=t,this.anim.direction=this.facing,this.anim.loop=[],this.anim.time=0,this.anim.rate=0,this.anim.current=0;var i=this.sprite.sheet.cellW,e=this.sprite.sheet.cellH;switch(t){case"idle":"down"===this.facing?this.anim.loop[0]={x:0*i,y:0*e,r:0}:"up"===this.facing?this.anim.loop[0]={x:3*i,y:0*e,r:0}:"left"===this.facing?this.anim.loop[0]={x:0*i,y:+e,r:0}:"right"===this.facing&&(this.anim.loop[0]={x:0*i,y:2*e,r:0});break;case"running":"down"===this.facing?(this.anim.loop[0]={x:0*i,y:0*e,r:.2},this.anim.loop[1]={x:+i,y:0*e,r:.2},this.anim.loop[2]={x:0*i,y:0*e,r:.2},this.anim.loop[3]={x:2*i,y:0*e,r:.2}):"up"===this.facing?(this.anim.loop[0]={x:3*i,y:0*e,r:.2},this.anim.loop[1]={x:4*i,y:0*e,r:.2},this.anim.loop[2]={x:3*i,y:0*e,r:.2},this.anim.loop[3]={x:5*i,y:0*e,r:.2}):"left"===this.facing?(this.anim.loop[0]={x:+i,y:+e,r:.12},this.anim.loop[1]={x:2*i,y:+e,r:.12},this.anim.loop[2]={x:3*i,y:+e,r:.12},this.anim.loop[3]={x:4*i,y:+e,r:.12}):"right"===this.facing&&(this.anim.loop[0]={x:+i,y:2*e,r:.12},this.anim.loop[1]={x:2*i,y:2*e,r:.12},this.anim.loop[2]={x:3*i,y:2*e,r:.12},this.anim.loop[3]={x:4*i,y:2*e,r:.12});break;case"pushing":"down"===this.facing?(this.anim.loop[0]={x:0*i,y:3*e,r:.2},this.anim.loop[1]={x:+i,y:3*e,r:.2}):"up"===this.facing?(this.anim.loop[0]={x:2*i,y:3*e,r:.2},this.anim.loop[1]={x:3*i,y:3*e,r:.2}):"left"===this.facing?(this.anim.loop[0]={x:0*i,y:4*e,r:.2},this.anim.loop[1]={x:+i,y:4*e,r:.2}):"right"===this.facing&&(this.anim.loop[0]={x:2*i,y:4*e,r:.2},this.anim.loop[1]={x:3*i,y:4*e,r:.2});break;case"shooting":"down"===this.facing?(this.anim.loop[0]={x:4*i,y:3*e,r:.3},this.anim.loop[1]={x:4*i,y:3*e,r:0}):"up"===this.facing?(this.anim.loop[0]={x:4*i,y:0*e,r:.3},this.anim.loop[1]={x:4*i,y:0*e,r:0}):"left"===this.facing?(this.anim.loop[0]={x:4*i,y:4*e,r:.3},this.anim.loop[1]={x:4*i,y:4*e,r:0}):"right"===this.facing&&(this.anim.loop[0]={x:5*i,y:4*e,r:.3},this.anim.loop[1]={x:5*i,y:4*e,r:0});break;case"dieing":this.anim.loop[0]={x:0*i,y:0*e,r:.2},this.anim.loop[1]={x:0*i,y:5*e,r:.08},this.anim.loop[2]={x:+i,y:5*e,r:.08},this.anim.loop[3]={x:2*i,y:5*e,r:.08},this.anim.loop[4]={x:3*i,y:5*e,r:.08},this.anim.loop[5]={x:4*i,y:5*e,r:.08},this.anim.loop[6]={x:5*i,y:5*e,r:.8},this.anim.loop[7]={x:5*i,y:5*e,r:0};break;case"drowning":this.anim.loop[0]={x:0*i,y:0*e,r:.07},this.anim.loop[1]={x:0*i,y:6*e,r:.07},this.anim.loop[2]={x:+i,y:6*e,r:.07},this.anim.loop[3]={x:2*i,y:6*e,r:.07},this.anim.loop[4]={x:3*i,y:6*e,r:.07},this.anim.loop[5]={x:4*i,y:6*e,r:.07},this.anim.loop[6]={x:5*i,y:6*e,r:.8},this.anim.loop[7]={x:5*i,y:6*e,r:0};break;default:alert(t+" animation not found.")}},Crate.pixelColors=[],Crate.pixelColors[0]="192,128,80",stage.actorIndex.push(Crate),Crate.sheet=new Image,Crate.sheet.src="resources/art/crate_spritesheet.png",Crate.sheet.cellW=TSIZE,Crate.sheet.cellH=TSIZE,Crate.prototype.isTile=!1,Crate.prototype.isActor=!0,Crate.prototype.wakeUp=function(){},Crate.prototype.update=function(){if("sliding"===this.state){var t=0,i=0;"up"===this.facing?--i:"down"===this.facing?i+=1:"left"===this.facing?--t:"right"===this.facing&&(t+=1),"pushing"===this.pusher.state&&this.pusher.facing===this.facing?(this.x+=t*this.slideSpeed*time.deltaTime,this.y+=i*this.slideSpeed*time.deltaTime,this.rigidBody.velocity.x+=t*this.slideSpeed,this.rigidBody.velocity.y+=i*this.slideSpeed,this.pusher.x+=t*this.slideSpeed*time.deltaTime,this.pusher.y+=i*this.slideSpeed*time.deltaTime):(this.x+=t*this.slideSpeed*time.deltaTime*.6,this.y+=i*this.slideSpeed*time.deltaTime*.6,this.rigidBody.velocity.x+=t*this.slideSpeed*.6,this.rigidBody.velocity.y+=i*this.slideSpeed*.6),("down"===this.facing&&this.y>this.slideTile.y||"up"===this.facing&&this.y<this.slideTile.y||"right"===this.facing&&this.x>this.slideTile.x||"left"===this.facing&&this.x<this.slideTile.x)&&(this.x=this.slideTile.x,this.y=this.slideTile.y,this.slideTile.constructor===PressurePlate&&(this.slideTile.state="down"),this.facing=null,this.state=null,this.pusher=null,this.slideTile=null)}else this.rigidBody.velocity={x:0,y:0}},Crate.prototype.push=function(t){if("pushing"===t.state&&null===this.state){var i=!1;if(Math.abs(t.x-this.x)>Math.abs(t.y-this.y)?t.x>this.x?"left"===t.facing&&(this.facing="left",i=!0):"right"===t.facing&&(this.facing="right",i=!0):t.y>this.y?"up"===t.facing&&(this.facing="up",i=!0):"down"===t.facing&&(this.facing="down",i=!0),i&&("down"===this.facing||"up"===this.facing?(t.left<this.left||t.right>this.right)&&(i=!1):(t.top<this.top||t.bottom>this.bottom)&&(i=!1)),i&&(this.slideTile={x:this.sX,y:this.sY},"down"===this.facing&&(this.slideTile.y+=1),"up"===this.facing&&--this.slideTile.y,"right"===this.facing&&(this.slideTile.x+=1),"left"===this.facing&&--this.slideTile.x,this.slideTile=stage.getTile(this.slideTile.x,this.slideTile.y),this.slideTile.isBlocked&&(i=!1)),i)for(var e=0;e<physics.actors.length;e++)if("static"===physics.actors[e].rigidBody.type&&physics.actors[e]!=this){var s=physics.actors[e].sX,r=physics.actors[e].sY;if(s===this.slideTile.sX&&r===this.slideTile.sY){i=!1;break}if(null!=physics.actors[e].slideTile&&physics.actors[e].slideTile.sX===this.slideTile.sX&&physics.actors[e].slideTile.sY===this.slideTile.sY){i=!1;break}}if(i){var h=stage.getTile(this.sX,this.sY);h.constructor===PressurePlate&&(h.state="up"),h.isBlocked=!1,this.slideTile.isBlocked=!0,this.state="sliding",this.pusher=t}else this.facing=null,this.state=null,this.pusher=null,this.slideTile=null}},Crate.prototype.kill=function(t){stage.getTile(this.sX,this.sY).isBlocked=!1,null!=this.slideTile&&(this.slideTile.isBlocked=!1),this.state="dead",this.isDead=!0,stage.unRegisterActor(this),physics.unRegisterActor(this)},Archer.pixelColors=[],Archer.pixelColors[0]="0,128,0",stage.actorIndex.push(Archer),Archer.sheet=new Image,Archer.sheet.src="resources/art/archer_spritesheet.png",Archer.sheet.cellW=26,Archer.sheet.cellH=26,Archer.prototype.isTile=!1,Archer.prototype.isActor=!0,Archer.prototype.wakeUp=function(){this.setAnimation();for(var t=0;t<stage.actors.length;t++)if("player"===stage.actors[t].type){this.targetPlayer=stage.actors[t];break}stage.getTile(this.sX,this.sY).isBlocked=!0},Archer.prototype.update=function(){if(this.state="ready",null!=this.targetPlayer){var t={x:this.targetPlayer.x-this.x,y:this.targetPlayer.y-this.y};Math.abs(t.x)>Math.abs(t.y)?(this.facing=0<t.x?"right":"left",this.targetPlayer.top<(this.sY+1)*TSIZE&&this.targetPlayer.bottom>this.sY*TSIZE&&(this.state="aim",this.targetPlayer.sY===this.sY&&(this.state="fire",this.fireCheck()))):(this.facing=0<t.y?"down":"up",this.targetPlayer.left<(this.sX+1)*TSIZE&&this.targetPlayer.right>this.sX*TSIZE&&(this.state="aim",this.targetPlayer.sX===this.sX&&(this.state="fire",this.fireCheck())))}"fire"!=this.state&&(this.canFire=!0),this.setAnimation(),this.anim.update(),this.sprite.source.x=this.anim.loop[this.anim.current].x,this.sprite.source.y=this.anim.loop[this.anim.current].y},Archer.prototype.fireCheck=function(){if(!1===this.canFire)return!1;var t=this.sX,i=this.sY,e=stage.getTile(t,i),s=stage.getTile(this.targetPlayer.sX,this.targetPlayer.sY),r=0,h=0;for("up"===this.facing?h=-1:"down"===this.facing?h=1:"left"===this.facing?r=-1:"right"===this.facing&&(r=1);e!=s;)if(t+=r,i+=h,(e=stage.getTile(t,i)).isBlocked)return!1;for(var a=0;a<physics.actors.length;a++)if(physics.actors[a].constructor===Crate&&this.targetPlayer.sX===physics.actors[a].sX&&this.targetPlayer.sY===physics.actors[a].sY)return!1;t=0,i=0;if("up"===this.facing?i=-1:"down"===this.facing?i=1:"left"===this.facing?t=-1:"right"===this.facing&&(t=1),this.arrows.push(new Arrow(this.x,this.y,this)),this.arrows[this.arrows.length-1].wakeUp(),4<this.arrows.length&&(null!=this.arrows[0]&&this.arrows[0].kill(this),this.arrows.shift()),"up"===this.facing||"down"===this.facing)var o=Math.abs(this.y-this.targetPlayer.y)*this.shootForcePer;else o=Math.abs(this.x-this.targetPlayer.x)*this.shootForcePer;return o<this.minShootForce&&(o=this.minShootForce),o>this.maxShootForce&&(o=this.maxShootForce),physics.applyForce(o,t,i,this.arrows[this.arrows.length-1].rigidBody),!(this.canFire=!1)},Archer.prototype.setAnimation=function(){if(this.anim.state===this.state&&this.anim.direction===this.facing)return!1;this.anim.state=this.state,this.anim.direction=this.facing,this.anim.loop=[],this.anim.time=0,this.anim.rate=0,this.anim.current=0;var t=this.sprite.sheet.cellW,i=this.sprite.sheet.cellH;switch(this.anim.loop[0]={x:0,y:0,r:0},"down"===this.facing?this.anim.loop[0].y=0*i:"up"===this.facing?this.anim.loop[0].y=+i:"left"===this.facing?this.anim.loop[0].y=2*i:"right"===this.facing&&(this.anim.loop[0].y=3*i),this.state){case"ready":this.anim.loop[0].x=0*t;break;case"aim":this.anim.loop[0].x=+t;break;case"fire":this.anim.loop[0].x=2*t}},Archer.prototype.hit=function(t){},Archer.prototype.kill=function(t){this.isDead=!0,stage.unRegisterActor(this),physics.unRegisterActor(this)},Arrow.sheet=new Image,Arrow.sheet.src="resources/art/arrow_spritesheet.png",Arrow.sheet.cellW=19,Arrow.sheet.cellH=25,Arrow.prototype.isTile=!1,Arrow.prototype.isActor=!0,Arrow.prototype.lateUpdate=function(){if(null===this.hitTarget){if(null!=this.firer&&null!=this.firer.targetPlayer){var t=this.firer.targetPlayer;if("up"===this.facing||"down"===this.facing){var i=Math.abs(this.y-t.y)/Math.abs(this.rigidBody.velocity.y);(e=t.x+t.rigidBody.velocity.x*i)-this.width/2<this.firer.sX*TSIZE?e=this.firer.sX*TSIZE+this.width/2+.01:e+this.width/2>(this.firer.sX+1)*TSIZE&&(e=(this.firer.sX+1)*TSIZE-this.width/2-.01),this.rigidBody.velocity.x=(e-this.x)/i}else{var e;i=Math.abs(this.x-t.x)/Math.abs(this.rigidBody.velocity.x);(e=t.y+t.rigidBody.velocity.y*i)-this.height/2<this.firer.sY*TSIZE?e=this.firer.sY*TSIZE+this.height/2+.01:e+this.height/2>(this.firer.sY+1)*TSIZE&&(e=(this.firer.sY+1)*TSIZE-this.height/2-.01),this.rigidBody.velocity.y=(e-this.y)/i}}}else{for(var s=!1,r=0;r<stage.actors.length&&!1===s;r++)stage.actors[r]===this.hitTarget.actor&&(s=!0);if(!1===s&&this.kill(this),null!=this.hitTarget.actor)for(this.x=this.hitTarget.actor.x+this.hitTarget.offsetX,this.y=this.hitTarget.actor.y+this.hitTarget.offsetY;this.hitTarget.facing!=this.hitTarget.actor.facing&&this.hitTarget.actor.constructor!=Crate;){var h=["up","right","down","left"];for(r=0;r<h.length;r++)if(h[r]===this.hitTarget.facing){(r+=1)===h.length&&(r=0),this.hitTarget.facing=h[r];for(var a=0;a<h.length;a++)if(h[a]===this.facing){(a+=1)===h.length&&(a=0),this.facing=h[a],this.updateBody();break}var o=this.hitTarget.offsetY;this.hitTarget.offsetY=this.hitTarget.offsetX,this.hitTarget.offsetX=-1*o;break}}}},Arrow.prototype.wakeUp=function(){this.updateBody(),stage.registerActor(this),physics.registerActor(this)},Arrow.prototype.updateBody=function(){"up"===this.facing?(this.sprite.source.x=0*this.sprite.sheet.cellW,this.rigidBody.collider.h=10,this.sprite.offset.y=.5):"down"===this.facing?(this.sprite.source.x=+this.sprite.sheet.cellW,this.rigidBody.collider.h=10,this.sprite.offset.y=4.5):"left"===this.facing?(this.sprite.source.x=2*this.sprite.sheet.cellW,this.rigidBody.collider.w=10,this.sprite.offset.x=-3):"right"===this.facing&&(this.sprite.source.x=3*this.sprite.sheet.cellW,this.rigidBody.collider.w=10,this.sprite.offset.x=3)},Arrow.prototype.hit=function(t){t!=this.firer&&"trigger"!=t.rigidBody.type&&"projectile"!=t.type&&"pickup"!=t.type&&("player"===t.type&&t.kill(this),t.constructor===Buzz&&this.kill(t),"up"===this.facing?this.y=t.bottom+this.height/2:"down"===this.facing?this.y=t.top-this.height/2:"left"===this.facing?this.x=t.right+this.width/2:"right"===this.facing&&(this.x=t.left-this.width/2),this.hitTarget=new Object,this.hitTarget.actor=t,this.hitTarget.facing=t.facing,this.hitTarget.offsetX=this.x-this.hitTarget.actor.x,this.hitTarget.offsetY=this.y-this.hitTarget.actor.y,physics.unRegisterActor(this))},Arrow.prototype.kill=function(t){this.isDead=!0,stage.unRegisterActor(this),physics.unRegisterActor(this)},Knight.pixelColors=[],Knight.pixelColors[0]="255,128,0",Knight.pixelColors[1]="255,192,0",stage.actorIndex.push(Knight),Knight.sheet=new Image,Knight.sheet.src="resources/art/knight_spritesheet.png",Knight.sheet.cellW=28,Knight.sheet.cellH=30,Knight.prototype.isTile=!1,Knight.prototype.isActor=!0,Knight.prototype.walkForce=1300,Knight.prototype.runForce=2600,Knight.prototype.wakeUp=function(){this.setAnimation(this.state),this.sprite.source.x=this.anim.loop[this.anim.current].x,this.sprite.source.y=this.anim.loop[this.anim.current].y;for(var t=0;t<stage.actors.length;t++)if("player"===stage.actors[t].type){this.targetPlayer=stage.actors[t];break}},Knight.prototype.update=function(){switch(this.state){case"idle":if(this.lookForPlayer(),this.idleTimer.cur+=time.deltaTime,this.idleTimer.cur>this.idleTimer.max)if(this.idleTimer.cur-=this.idleTimer.max,!0===this.findPatrolPath())this.state="patrolling";else{this.facing=["up","down","left","right"][RandomIntRange(0,3)]}!0===this.canSeePlayer&&this.findPathToPlayer();break;case"patrolling":this.lookForPlayer(),this.canSeePlayer?(this.wayPoints=[],this.findPathToPlayer()):(0<this.wayPoints.length&&this.sX===this.wayPoints[0].sX&&this.sY===this.wayPoints[0].sY&&this.wayPoints.shift(),0===this.wayPoints.length&&this.findPatrolPath(),0!=this.wayPoints.length&&this.goTo(this.wayPoints[0]));break;case"chasing":this.targetPlayer.isDead?(this.wayPoints=[],!0===this.findPatrolPath()?this.state="patrolling":this.state="idle"):this.sX===this.targetPlayer.sX&&this.sY===this.targetPlayer.sY?this.goTo(this.targetPlayer):(this.lookForPlayer(),this.canSeePlayer&&this.findPathToPlayer(),0<this.wayPoints.length?this.sX===this.wayPoints[0].sX&&this.sY===this.wayPoints[0].sY?1<this.wayPoints.length?(this.wayPoints.shift(),this.goTo(this.wayPoints[0])):this.findPatrolPath():this.goTo(this.wayPoints[0]):this.findPatrolPath());break;case"watching":this.targetPlayer.isDead?(this.wayPoints=[],!0===this.findPatrolPath()?this.state="patrolling":this.state="idle"):this.face(this.targetPlayer),this.targetPlayer.sX==this.playerLastSeen.sX&&this.targetPlayer.sY==this.playerLastSeen.sY||(this.lookForPlayer(),this.canSeePlayer?(this.findPathToPlayer(),0<this.wayPoints.length&&(this.sX==this.wayPoints[this.wayPoints.length-1].sX&&this.sY==this.wayPoints[this.wayPoints.length-1].sY||(this.state="chasing"))):this.findPatrolPath());break;case"attacking":4===this.anim.current&&(this.state="idle");break;case"dieing":case"drowning":7===this.anim.current&&(this.isDead=!0,stage.unRegisterActor(this),physics.unRegisterActor(this));break;default:console.log("Knight state not found - "+this.state+".")}this.setAnimation(this.state),this.anim.update(),this.sprite.source.x=this.anim.loop[this.anim.current].x,this.sprite.source.y=this.anim.loop[this.anim.current].y},Knight.prototype.goTo=function(t){this.face(t),"patrolling"===this.state?physics.applyForce(this.moveForce*time.deltaTime,t.x-this.x,t.y-this.y,this.rigidBody):physics.applyForce(2*this.moveForce*time.deltaTime,t.x-this.x,t.y-this.y,this.rigidBody)},Knight.prototype.face=function(t){Math.abs(this.x-t.x)>Math.abs(this.y-t.y)?0<this.x-t.x?this.facing="left":this.facing="right":0<this.y-t.y?this.facing="up":this.facing="down"},Knight.prototype.lookForPlayer=function(){if(this.targetPlayer.isDead)this.canSeePlayer=!1;else if(this.lastLookFrom!==stage.getTile(this.sX,this.sY)||this.lastLookTo!==stage.getTile(this.targetPlayer.sX,this.targetPlayer.sY)){this.lastLookFrom=stage.getTile(this.sX,this.sY),this.lastLookTo=stage.getTile(this.targetPlayer.sX,this.targetPlayer.sY);var t=this.targetPlayer.x-this.x,i=this.targetPlayer.y-this.y;if("chasing"===this.state||"watching"===this.state)var e=!0;else{e=!1;"up"===this.facing?i<0&&Math.abs(i)>Math.abs(t)/2&&(e=!0):"down"===this.facing?0<i&&Math.abs(i)>Math.abs(t)/2&&(e=!0):"left"===this.facing?t<0&&Math.abs(t)>Math.abs(i)/2&&(e=!0):"right"===this.facing&&0<t&&Math.abs(t)>Math.abs(i)/2&&(e=!0)}if(e){if(10<Math.sqrt(Math.pow(t,2)+Math.pow(i,2))/TSIZE)return void(this.canSeePlayer=!1);for(var s=physics.rayTrace(this.sX,this.sY,this.targetPlayer.sX,this.targetPlayer.sY),r=0;r<s.length;r++)if(!0===s[r].isBlocked)return void(this.canSeePlayer=!1);this.playerLastSeen=stage.getTile(this.targetPlayer.sX,this.targetPlayer.sY),this.canSeePlayer=!0}else this.canSeePlayer=!1}},Knight.prototype.findPathToPlayer=function(){if(0<this.wayPoints.length&&this.wayPoints[this.wayPoints.length-1].sX===this.playerLastSeen.sX&&this.wayPoints[this.wayPoints.length-1].sY===this.playerLastSeen.sY)return!0;if(this.sX===this.targetPlayer.sX&&this.sY===this.targetPlayer.sY)return this.state="chasing",this.wayPoints=[],this.wayPoints.push(stage.getTile(this.sX,this.sY)),!0;this.wayPoints=[];var t=null,i=[],e=[];for(i.push(new PathNode(stage.getTile(this.sX,this.sY),null,0,Math.abs(this.sX-this.targetPlayer.sX)+Math.abs(this.sY-this.targetPlayer.sY)));0<i.length;){for(var s=0,r=0;r<i.length;r++)i[r].distance+i[r].heuristic<i[s].distance+i[s].heuristic&&(s=r);if(i[s].distance<50){var h=[];h.push(new PathNode(stage.getTile(i[s].tile.sX,i[s].tile.sY-1),i[s],i[s].distance+1,Math.abs(i[s].tile.sX-this.targetPlayer.sX)+Math.abs(i[s].tile.sY-1-this.targetPlayer.sY))),h.push(new PathNode(stage.getTile(i[s].tile.sX,i[s].tile.sY+1),i[s],i[s].distance+1,Math.abs(i[s].tile.sX-this.targetPlayer.sX)+Math.abs(i[s].tile.sY+1-this.targetPlayer.sY))),h.push(new PathNode(stage.getTile(i[s].tile.sX-1,i[s].tile.sY),i[s],i[s].distance+1,Math.abs(i[s].tile.sX-1-this.targetPlayer.sX)+Math.abs(i[s].tile.sY-this.targetPlayer.sY))),h.push(new PathNode(stage.getTile(i[s].tile.sX+1,i[s].tile.sY),i[s],i[s].distance+1,Math.abs(i[s].tile.sX+1-this.targetPlayer.sX)+Math.abs(i[s].tile.sY-this.targetPlayer.sY))),1!=h[0].tile.isBlocked&&"water"!=h[0].tile.type&&(1!=h[2].tile.isBlocked&&"water"!=h[2].tile.type&&h.push(new PathNode(stage.getTile(i[s].tile.sX-1,i[s].tile.sY-1),i[s],i[s].distance+Math.SQRT2,Math.abs(i[s].tile.sX-1-this.targetPlayer.sX)+Math.abs(i[s].tile.sY-1-this.targetPlayer.sY))),1!=h[3].tile.isBlocked&&"water"!=h[3].tile.type&&h.push(new PathNode(stage.getTile(i[s].tile.sX+1,i[s].tile.sY-1),i[s],i[s].distance+Math.SQRT2,Math.abs(i[s].tile.sX+1-this.targetPlayer.sX)+Math.abs(i[s].tile.sY-1-this.targetPlayer.sY)))),1!=h[1].tile.isBlocked&&"water"!=h[1].tile.type&&(1!=h[2].tile.isBlocked&&"water"!=h[2].tile.type&&h.push(new PathNode(stage.getTile(i[s].tile.sX-1,i[s].tile.sY+1),i[s],i[s].distance+Math.SQRT2,Math.abs(i[s].tile.sX-1-this.targetPlayer.sX)+Math.abs(i[s].tile.sY+1-this.targetPlayer.sY))),1!=h[3].tile.isBlocked&&"water"!=h[3].tile.type&&h.push(new PathNode(stage.getTile(i[s].tile.sX+1,i[s].tile.sY+1),i[s],i[s].distance+Math.SQRT2,Math.abs(i[s].tile.sX+1-this.targetPlayer.sX)+Math.abs(i[s].tile.sY+1-this.targetPlayer.sY))));for(r=0;r<h.length;r++)if(!0!==h[r].tile.isBlocked&&"water"!==h[r].tile.type){for(var a=0;a<i.length&&h[r].tile!==i[a].tile;a++);if(a==i.length){for(a=0;a<e.length&&h[r].tile!==e[a].tile;a++);a==e.length&&i.push(h[r])}}}if(e.push(i[s]),i.splice(s,1),e[e.length-1].tile.sX===this.playerLastSeen.sX&&e[e.length-1].tile.sY===this.playerLastSeen.sY){t=e[e.length-1];break}}if(0===e.length)return this.wayPoints=[],this.canSeePlayer?(this.face(this.targetPlayer),this.state="watching"):this.state="idle",!1;if(null===t){var o=0;for(r=0;r<e.length;r++)e[r].heuristic<e[o].heuristic&&(o=r);t=e[o]}if(this.wayPoints=[],this.state="chasing",this.sX===t.tile.sX&&this.sY===t.tile.sY)return this.face(this.targetPlayer),!(this.state="watching");for(;null!=t;)this.wayPoints.unshift(t.tile),t=t.prev;return!0},Knight.prototype.findPatrolPath=function(){for(var t=!1,i=this.sY-1;i<=this.sY+1&&!1===t;i++)for(var e=this.sX-1;e<=this.sX+1&&!1===t;e++)e==this.sX&&i==this.sY||!0!==stage.getTile(e,i).isBlocked&&"water"!==stage.getTile(e,i).type||(t=!0);if(!0===t){var s=[];"left"===this.hand?(s.up=[{x:-1,y:0},{x:-1,y:1}],s.down=[{x:1,y:0},{x:1,y:-1}],s.left=[{x:0,y:1},{x:1,y:1}],s.right=[{x:0,y:-1},{x:-1,y:-1}]):"right"===this.hand&&(s.up=[{x:1,y:0},{x:1,y:1}],s.down=[{x:-1,y:0},{x:-1,y:-1}],s.left=[{x:0,y:-1},{x:1,y:-1}],s.right=[{x:0,y:1},{x:-1,y:1}]);var r=[];"left"===this.hand?(r.up="right",r.down="left",r.left="up",r.right="down"):"right"===this.hand&&(r.up="left",r.down="right",r.left="down",r.right="up");for(var h=!1,a=0;a<4&&!1===h;a++){h=!1;for(var o=0;o<s[this.facing].length;o++){if(!0===(l=stage.getTile(this.sX+s[this.facing][o].x,this.sY+s[this.facing][o].y)).isBlocked||"water"===l.type){h=!0;break}}!1===h&&(this.facing=r[this.facing])}if(4===a)return this.findClosestWall(),!0;this.wayPoints=[];for(a=0;a<4&&0===this.wayPoints.length;a++){var l;!0===(l=stage.getTile(this.sX+s[this.facing][0].x,this.sY+s[this.facing][0].y)).isBlocked||"water"===l.type?this.facing=r[this.facing]:this.wayPoints.unshift(l)}if(0===this.wayPoints.length)return!(this.state="idle")}else this.findClosestWall();return this.state="patrolling",!0},Knight.prototype.findClosestWall=function(){var t=null,i=[],e=[],s=[];for(i.push(new PathNode(stage.getTile(this.sX,this.sY),null,0));0<i.length;){for(var r=0,h=0;h<i.length;h++)i[h].distance<i[r].distance&&(r=h);s.push(new PathNode(stage.getTile(i[r].tile.sX,i[r].tile.sY-1),i[r],i[r].distance+1)),s.push(new PathNode(stage.getTile(i[r].tile.sX,i[r].tile.sY+1),i[r],i[r].distance+1)),s.push(new PathNode(stage.getTile(i[r].tile.sX-1,i[r].tile.sY),i[r],i[r].distance+1)),s.push(new PathNode(stage.getTile(i[r].tile.sX+1,i[r].tile.sY),i[r],i[r].distance+1)),1!=s[0].tile.isBlocked&&"water"!=s[0].tile.type&&(1!=s[2].tile.isBlocked&&"water"!=s[2].tile.type&&s.push(new PathNode(stage.getTile(i[r].tile.sX-1,i[r].tile.sY-1),i[r],i[r].distance+Math.SQRT2)),1!=s[3].tile.isBlocked&&"water"!=s[3].tile.type&&s.push(new PathNode(stage.getTile(i[r].tile.sX+1,i[r].tile.sY-1),i[r],i[r].distance+Math.SQRT2))),1!=s[1].tile.isBlocked&&"water"!=s[1].tile.type&&(1!=s[2].tile.isBlocked&&"water"!=s[2].tile.type&&s.push(new PathNode(stage.getTile(i[r].tile.sX-1,i[r].tile.sY+1),i[r],i[r].distance+Math.SQRT2)),1!=s[3].tile.isBlocked&&"water"!=s[3].tile.type&&s.push(new PathNode(stage.getTile(i[r].tile.sX+1,i[r].tile.sY+1),i[r],i[r].distance+Math.SQRT2)));for(h=0;h<s.length;h++){for(var a=0;a<i.length&&s[h].tile!==i[a].tile;a++);if(a==i.length){for(a=0;a<e.length&&s[h].tile!==e[a].tile;a++);a==e.length&&i.push(s[h])}}if(e.push(i[r]),i.splice(r,1),!0===e[e.length-1].tile.isBlocked||"water"===e[e.length-1].tile.type){t=e[e.length-1];break}}for(t=t.prev,this.wayPoints=[],this.state="patrolling";null!=t;)this.wayPoints.unshift(t.tile),t=t.prev;return!0},Knight.prototype.setAnimation=function(t){if(this.anim.state===t&&this.anim.direction===this.facing)return!1;this.anim.state=t,this.anim.direction=this.facing,this.anim.loop=[],this.anim.time=0,this.anim.rate=0,this.anim.current=0;var i=this.sprite.sheet.cellW,e=this.sprite.sheet.cellH;switch(t){case"idle":"down"===this.facing&&(this.anim.loop[0]={x:0*i,y:0*e,r:0}),"up"===this.facing&&(this.anim.loop[0]={x:0*i,y:+e,r:0}),"left"===this.facing&&(this.anim.loop[0]={x:0*i,y:2*e,r:0}),"right"===this.facing&&(this.anim.loop[0]={x:0*i,y:3*e,r:0});break;case"patrolling":"down"===this.facing?(this.anim.loop[0]={x:0*i,y:0*e,r:.2},this.anim.loop[1]={x:+i,y:0*e,r:.2},this.anim.loop[2]={x:0*i,y:0*e,r:.2},this.anim.loop[3]={x:2*i,y:0*e,r:.2}):"up"===this.facing?(this.anim.loop[0]={x:0*i,y:+e,r:.2},this.anim.loop[1]={x:+i,y:+e,r:.2},this.anim.loop[2]={x:0*i,y:+e,r:.2},this.anim.loop[3]={x:2*i,y:+e,r:.2}):"left"===this.facing?(this.anim.loop[0]={x:+i,y:2*e,r:.12},this.anim.loop[1]={x:2*i,y:2*e,r:.12},this.anim.loop[2]={x:3*i,y:2*e,r:.12},this.anim.loop[3]={x:4*i,y:2*e,r:.12}):"right"===this.facing&&(this.anim.loop[0]={x:+i,y:3*e,r:.12},this.anim.loop[1]={x:2*i,y:3*e,r:.12},this.anim.loop[2]={x:3*i,y:3*e,r:.12},this.anim.loop[3]={x:4*i,y:3*e,r:.12});break;case"chasing":"down"===this.facing?(this.anim.loop[0]={x:0*i,y:4*e,r:.2},this.anim.loop[1]={x:+i,y:4*e,r:.2},this.anim.loop[2]={x:0*i,y:4*e,r:.2},this.anim.loop[3]={x:2*i,y:4*e,r:.2}):"up"===this.facing?(this.anim.loop[0]={x:0*i,y:+e,r:.2},this.anim.loop[1]={x:+i,y:+e,r:.2},this.anim.loop[2]={x:0*i,y:+e,r:.2},this.anim.loop[3]={x:2*i,y:+e,r:.2}):"left"===this.facing?(this.anim.loop[0]={x:+i,y:5*e,r:.12},this.anim.loop[1]={x:2*i,y:5*e,r:.12},this.anim.loop[2]={x:3*i,y:5*e,r:.12},this.anim.loop[3]={x:4*i,y:5*e,r:.12}):"right"===this.facing&&(this.anim.loop[0]={x:+i,y:6*e,r:.12},this.anim.loop[1]={x:2*i,y:6*e,r:.12},this.anim.loop[2]={x:3*i,y:6*e,r:.12},this.anim.loop[3]={x:4*i,y:6*e,r:.12});break;case"attacking":var s=.08;"down"===this.facing?(this.anim.loop[0]={x:0*i,y:7*e,r:s},this.anim.loop[1]={x:+i,y:7*e,r:s},this.anim.loop[2]={x:2*i,y:7*e,r:s},this.anim.loop[3]={x:0*i,y:0*e,r:1},this.anim.loop[4]={x:0*i,y:0*e,r:0}):"up"===this.facing?(this.anim.loop[0]={x:0*i,y:8*e,r:s},this.anim.loop[1]={x:+i,y:8*e,r:s},this.anim.loop[2]={x:2*i,y:8*e,r:s},this.anim.loop[3]={x:0*i,y:+e,r:1},this.anim.loop[4]={x:0*i,y:+e,r:0}):"left"===this.facing?(this.anim.loop[0]={x:0*i,y:9*e,r:s},this.anim.loop[1]={x:+i,y:9*e,r:s},this.anim.loop[2]={x:2*i,y:9*e,r:s},this.anim.loop[3]={x:0*i,y:2*e,r:1},this.anim.loop[4]={x:0*i,y:2*e,r:0}):"right"===this.facing&&(this.anim.loop[0]={x:0*i,y:10*e,r:s},this.anim.loop[1]={x:+i,y:10*e,r:s},this.anim.loop[2]={x:2*i,y:10*e,r:s},this.anim.loop[3]={x:0*i,y:3*e,r:1},this.anim.loop[4]={x:0*i,y:3*e,r:0});break;case"dieing":this.anim.loop[0]={x:0*i,y:4*e,r:.2},this.anim.loop[1]={x:0*i,y:11*e,r:.08},this.anim.loop[2]={x:+i,y:11*e,r:.08},this.anim.loop[3]={x:2*i,y:11*e,r:.08},this.anim.loop[4]={x:3*i,y:11*e,r:.08},this.anim.loop[5]={x:4*i,y:11*e,r:.08},this.anim.loop[6]={x:4*i,y:10*e,r:.8},this.anim.loop[7]={x:4*i,y:10*e,r:0};break;case"drowning":s=.07;this.anim.loop[0]={x:0*i,y:4*e,r:s},this.anim.loop[1]={x:0*i,y:12*e,r:s},this.anim.loop[2]={x:+i,y:12*e,r:s},this.anim.loop[3]={x:2*i,y:12*e,r:s},this.anim.loop[4]={x:3*i,y:12*e,r:s},this.anim.loop[5]={x:4*i,y:12*e,r:s},this.anim.loop[6]={x:4*i,y:10*e,r:.8},this.anim.loop[7]={x:4*i,y:10*e,r:0};break;case"watching":"down"===this.facing&&(this.anim.loop[0]={x:0*i,y:4*e,r:0}),"up"===this.facing&&(this.anim.loop[0]={x:0*i,y:+e,r:0}),"left"===this.facing&&(this.anim.loop[0]={x:0*i,y:5*e,r:0}),"right"===this.facing&&(this.anim.loop[0]={x:0*i,y:6*e,r:0});break;default:alert(t+" animation not found.")}},Knight.prototype.hit=function(t){if("player"===t.type?"dieing"!=t.state&&"drowning"!=t.state&&(t.kill(this),this.face(t),this.state="attacking"):t.constructor===IceBall&&(this.state="idle",this.canSeePlayer=!1,this.idleTimer.cur=this.idleTimer.max-1,this.wayPoints=[]),"trigger"!=t.rigidBody.type&&"weightless"!=t.rigidBody.type)if("crate"===t.type)if("patrolling"===this.state){var i=null,e=physics.getOverlap(this,t);if(Math.abs(e.x)<Math.abs(e.y)){if(!1===(i=stage.getTile(this.sX,this.sY-1)).isBlocked&&"water"!=i.type)return void(this.wayPoints=[i]);if(!1===(i=stage.getTile(this.sX,this.sY+1)).isBlocked&&"water"!=i.type)return void(this.wayPoints=[i])}else{if(!1===(i=stage.getTile(this.sX-1,this.sY)).isBlocked&&"water"!=i.type)return void(this.wayPoints=[i]);if(!1===(i=stage.getTile(this.sX+1,this.sY)).isBlocked&&"water"!=i.type)return void(this.wayPoints=[i])}}else"chasing"===this.state&&(this.wayPoints=[],this.findPathToPlayer());else"patrolling"===this.state&&t.constructor===Knight&&.2<(time.now-this.lastHandChange)/1e3&&(this.lastHandChange=time.now,"left"===this.hand?this.hand="right":this.hand="left","up"===this.facing?this.facing="down":"down"===this.facing?this.facing="up":"left"===this.facing?this.facing="right":"right"===this.facing&&(this.facing="left"),physics.applyForce(200,t.x-this.x,t.y-this.y,t.rigidBody),this.wayPoints=[])},Knight.prototype.kill=function(t){this.isDead=!0,physics.unRegisterActor(this),t.constructor===Water?this.state="drowning":(this.rigidBody.velocity.x=0,this.rigidBody.velocity.y=0,this.state="dieing")},Buzz.pixelColors=[],Buzz.pixelColors[0]="192,192,192",Buzz.pixelColors[1]="160,160,160",stage.actorIndex.push(Buzz),Buzz.sheet=new Image,Buzz.sheet.src="resources/art/buzz_spritesheet.png",Buzz.sheet.cellW=23,Buzz.sheet.cellH=24,Buzz.prototype.isTile=!1,Buzz.prototype.isActor=!0,Buzz.prototype.wakeUp=function(){if("clockwise"===this.state)var t=0;else t=1;this.anim.loop[0]={x:0*this.sprite.sheet.cellW,y:this.sprite.sheet.cellH*t,r:.04},this.anim.loop[1]={x:+this.sprite.sheet.cellW,y:this.sprite.sheet.cellH*t,r:.04},this.anim.loop[2]={x:2*this.sprite.sheet.cellW,y:this.sprite.sheet.cellH*t,r:.04};var i=[];i[0]={dir:"up",x:0,y:-1,dis:0},i[1]={dir:"down",x:0,y:1,dis:0},i[2]={dir:"left",x:-1,y:0,dis:0},i[3]={dir:"right",x:1,y:0,dis:0};for(var e=0;e<i.length;e++)for(var s={x:this.sX,y:this.sY};;){s.x+=i[e].x,s.y+=i[e].y,i[e].dis++;var r=stage.getTile(s.x,s.y);if("wall"===r.type||r.isBlocked)break}var h=i[0];for(e=0;e<i.length;e++)i[e].dis<h.dis&&(h=i[e]);this.facing=h.dir},Buzz.prototype.update=function(){var t=0,i=0;"right"===this.facing?t=1:"left"===this.facing?t=-1:"up"===this.facing?i=-1:"down"===this.facing&&(i=1),physics.applyForce(this.moveForce*time.deltaTime,t,i,this.rigidBody),this.anim.update(),this.sprite.source.x=this.anim.loop[this.anim.current].x,this.sprite.source.y=this.anim.loop[this.anim.current].y},Buzz.prototype.hit=function(t){if(t.constructor!==Arrow){if("trigger"!=t.rigidBody.type&&"weightless"!=t.rigidBody.type)if("player"===t.type)t.kill(this);else{var i=physics.getOverlap(this,t);Math.abs(i.x)<Math.abs(i.y)?this.x<t.x?this.facing="up":this.facing="down":this.y<t.y?this.facing="right":this.facing="left","counter-clockwise"===this.state&&("up"===this.facing?this.facing="down":"down"===this.facing?this.facing="up":"left"===this.facing?this.facing="right":"right"===this.facing&&(this.facing="left"))}}else t.kill(this)},Buzz.prototype.kill=function(t){if(t===physics&&stage.getTile(this.sX,this.sY).isBlocked)for(var i=0;i<stage.actors.length;i++)if("crate"===stage.actors[i].type&&stage.actors[i].sX===this.sX&&stage.actors[i].sY===this.sY)return void stage.actors[i].kill(this);this.isDead=!0,stage.unRegisterActor(this),physics.unRegisterActor(this)},IceWand.pixelColors=[],IceWand.pixelColors[0]="0,255,255",stage.actorIndex.push(IceWand),IceWand.sheet=new Image,IceWand.sheet.src="resources/art/icewand_spritesheet.png",IceWand.sheet.cellW=10,IceWand.sheet.cellH=24,IceWand.prototype.isTile=!1,IceWand.prototype.isActor=!0,IceWand.prototype.wakeUp=function(){this.anim.rate=.15,this.anim.loop[0]={x:0*IceWand.sheet.cellW,y:0*IceWand.sheet.cellH},this.anim.loop[1]={x:+IceWand.sheet.cellW,y:0*IceWand.sheet.cellH},this.anim.loop[2]={x:2*IceWand.sheet.cellW,y:0*IceWand.sheet.cellH},this.anim.loop[3]={x:3*IceWand.sheet.cellW,y:0*IceWand.sheet.cellH},this.anim.loop[4]={x:4*IceWand.sheet.cellW,y:0*IceWand.sheet.cellH}},IceWand.prototype.update=function(){this.anim.update(),this.sprite.source.x=this.anim.loop[this.anim.current].x,this.sprite.source.y=this.anim.loop[this.anim.current].y},IceWand.prototype.hit=function(t){"player"===t.type&&(t.addRemoveAmmo(1),this.kill(this))},IceWand.prototype.kill=function(t){this.isDead=!0,stage.unRegisterActor(this),physics.unRegisterActor(this)},IceBall.sheet=new Image,IceBall.sheet.src="resources/art/iceball_spritesheet.png",IceBall.sheet.cellW=18,IceBall.sheet.cellH=22,IceBall.prototype.isTile=!1,IceBall.prototype.isActor=!0,IceBall.prototype.wakeUp=function(){var t=0;"up"===this.facing?(t=0,this.rigidBody.collider.w=6,physics.applyForce(this.speed,0,-1,this.rigidBody)):"down"===this.facing?(t=1,this.rigidBody.collider.w=6,physics.applyForce(this.speed,0,1,this.rigidBody)):"left"===this.facing?(t=2,this.rigidBody.collider.h=8,physics.applyForce(this.speed,-1,0,this.rigidBody)):"right"===this.facing&&(t=3,this.rigidBody.collider.h=8,physics.applyForce(this.speed,1,0,this.rigidBody)),this.anim.loop[0]={x:IceBall.sheet.cellW*t,y:0*IceBall.sheet.cellH},this.anim.loop[1]={x:IceBall.sheet.cellW*t,y:+IceBall.sheet.cellH},this.anim.loop[2]={x:IceBall.sheet.cellW*t,y:2*IceBall.sheet.cellH},stage.registerActor(this),physics.registerActor(this)},IceBall.prototype.update=function(){this.anim.update(),this.sprite.source.x=this.anim.loop[this.anim.current].x,this.sprite.source.y=this.anim.loop[this.anim.current].y},IceBall.prototype.hit=function(t){t!=this.firer&&("enemy"===t.type&&t.constructor!=Archer&&(new IceBlock(t),this.kill(t)),"trigger"!=t.rigidBody.type&&"pickup"!=t.type&&"projectile"!=t.type&&this.kill(t))},IceBall.prototype.kill=function(t){this.isDead=!0,stage.unRegisterActor(this),physics.unRegisterActor(this)},IceBlock.sheet=new Image,IceBlock.sheet.src="resources/art/iceblock_spritesheet.png",IceBlock.sheet.cellW=22,IceBlock.sheet.cellH=26,IceBlock.prototype.isTile=!1,IceBlock.prototype.isActor=!0,IceBlock.prototype.wakeUp=function(){stage.registerActor(this),stage.unRegisterActor(this.frozenActor),physics.unRegisterActor(this.frozenActor),this.rigidBody.velocity.x=this.frozenActor.rigidBody.velocity.x,this.rigidBody.velocity.y=this.frozenActor.rigidBody.velocity.y,this.frozenActor.constructor!=Buzz?(this.frozenActor.constructor===Knight?this.sprite.source.x=0*IceBlock.sheet.cellW:this.frozenActor.constructor===Archer&&(this.sprite.source.x=+IceBlock.sheet.cellW),this.sprite.offset.y=-4,"down"===this.frozenActor.facing?this.sprite.source.y=0*IceBlock.sheet.cellH:"up"===this.frozenActor.facing?this.sprite.source.y=+IceBlock.sheet.cellH:"left"===this.frozenActor.facing?this.sprite.source.y=2*IceBlock.sheet.cellH:"right"===this.frozenActor.facing&&(this.sprite.source.y=3*IceBlock.sheet.cellH)):(this.sprite.source.x=2*IceBlock.sheet.cellW,"clockwise"===this.frozenActor.state&&(this.sprite.source.y=+IceBlock.sheet.cellH))},IceBlock.prototype.update=function(){this.needPhysReg&&(this.needPhysReg=!1,physics.registerActor(this)),this.width!=this.colliderTrueSize.w&&(this.rigidBody.collider.w+=6*time.deltaTime,this.width>this.colliderTrueSize.w&&(this.rigidBody.collider.w=this.colliderTrueSize.w)),this.height!=this.colliderTrueSize.h&&(this.rigidBody.collider.h+=6*time.deltaTime,this.height>this.colliderTrueSize.h&&(this.rigidBody.collider.h=this.colliderTrueSize.h)),this.meltTimer-=time.deltaTime,this.meltTimer<=4&&this.sprite.source.x<3*IceBlock.sheet.cellW||this.meltTimer<=3&&this.sprite.source.x<6*IceBlock.sheet.cellW||this.meltTimer<=2&&this.sprite.source.x<9*IceBlock.sheet.cellW||this.meltTimer<=1&&this.sprite.source.x<12*IceBlock.sheet.cellW?this.sprite.source.x+=3*IceBlock.sheet.cellW:this.meltTimer<=0&&this.melt()},IceBlock.prototype.hit=function(t){},IceBlock.prototype.melt=function(){stage.registerActor(this.frozenActor),physics.registerActor(this.frozenActor),this.frozenActor.x=this.x,this.frozenActor.y=this.y,this.frozenActor.rigidBody.velocity.x=this.rigidBody.velocity.x,this.frozenActor.rigidBody.velocity.y=this.rigidBody.velocity.y,this.kill(this)},IceBlock.prototype.kill=function(t){this.isDead=!0,stage.unRegisterActor(this),physics.unRegisterActor(this)},stage.loadCurrentLevel();